"NhapHopDong As screen.'phoneLayout_FluidGridWithHeaderPageLayout_ver3.0'":
    OnVisible: |
        =Reset(dpNgayHDNHD);Reset(dpHLTuNHD);Reset(dpHLDenNHD);Reset(cbxDVQLNHD);Reset(cbxDVTienNHD);Reset(cbxLoaiKBNHD);Reset(cbxMaKBNHD);Reset(tiTenKBNHD);Reset(cbxDVKBNHD);
        Reset(cbxMaKHNHD);Reset(tiTenKHNHD);Reset(tiDChiNHD);Reset(dpNSinhNHD);Reset(cbxGTinhNHD);Reset(tiSDTNHD);Reset(tiEmailNHD);Reset(cbxLoaiKHNHD);Reset(cbxNgheNHD);
        Reset(cbxTinhNHD);Reset(LinkHDLK);
        Reset(tiSoNTGNHD);
        If(
            IsBlank(LookUp(DL_HOP_DONGS,MA_HOP_DONG=maHopDongFwd)),
            ClearCollect(
                objHD,
                Defaults(DL_HOP_DONGS)
            ),
            ClearCollect(
                objHD,
                LookUp(DL_HOP_DONGS,MA_HOP_DONG=maHopDongFwd)
            )
        );
        ClearCollect(
            tmpDSHDSPNHDCollect,
            AddColumns(
                Filter(
                    DL_HOP_DONG_SPS,
                    MA_HOP_DONG=maHopDongFwd
                ),
                "added",
                0,
                "edited",
                0
            )
        );
        UpdateContext({
            maHDSP:Max(DL_HOP_DONG_SPS,ID),
            maAddedHDSPNHD:"",
            maUpdatedHDSPNHD:"",
            nhomKB:""
        });
        Set(maHopDongFwd,"");

    Canvas2 As fluidGrid.fluidGridWithBlankCard:
        BorderThickness: =0
        Height: =768
        Width: =1306
        X: =60
        Y: =
        ZIndex: =3

        DataCard2 As dataCard:
            BorderColor: =RGBA(0, 0, 0, 1)
            BorderStyle: =BorderStyle.Solid
            BorderThickness: =0
            DisplayMode: =DisplayMode.Edit
            Fill: =RGBA(0, 0, 0, 0)
            Height: =1683
            Width: =1306
            X: =0
            Y: =0
            ZIndex: =1

            Container3_2 As groupContainer.manualLayoutContainer:
                Height: =179
                Width: =1267
                X: =16
                Y: =4
                ZIndex: =1

                Label3_32 As label:
                    Height: =25
                    Size: =11
                    Text: ="Mã"
                    Width: =47
                    X: =70
                    Y: =24
                    ZIndex: =1

                tiMaHDNHD As text:
                    BorderColor: =RGBA(72, 163, 62, 1)
                    Default: =If(IsBlank(First(objHD).MA_HOP_DONG),"Hệ thống tự sinh",First(objHD).MA_HOP_DONG) 
                    DisplayMode: =DisplayMode.Disabled
                    Height: =32
                    Size: =11
                    Width: =200
                    X: =70
                    Y: =52
                    ZIndex: =2

                Label3_35 As label:
                    Height: =25
                    Size: =11
                    Text: ="Hiệu lực đến (*)"
                    Width: =140
                    X: =990
                    Y: =24
                    ZIndex: =3

                Label3_37 As label:
                    Height: =25
                    Size: =11
                    Text: ="Đơn vị quản lý HĐ (*)"
                    Width: =168
                    X: =70
                    Y: =95
                    ZIndex: =7

                cbxDVQLNHD As combobox:
                    BorderColor: =RGBA(72, 163, 62, 1)
                    DefaultSelectedItems: =LookUp(Filter(DM_PHAMVI_DIALYS,LOAI="DON_VI"),MA_PHAMVI=First(objHD).DONVI_QUANLY_HD)
                    DisplayFields: =["cr282_ma_phamvi"]
                    Height: =32
                    InputTextPlaceholder: ="Chọn đơn vị quản lý"
                    Items: =Filter(DM_PHAMVI_DIALYS,LOAI="DON_VI")
                    SearchFields: =["cr282_ma_phamvi"]
                    SearchItems: =Search(Filter(DM_PHAMVI_DIALYS,LOAI="DON_VI"),cbxDVQLNHD.SearchText,"cr282_ma_phamvi")
                    SelectMultiple: =false
                    Size: =11
                    Template: =ListItemTemplate.Double
                    Width: =200
                    X: =70
                    Y: =122
                    ZIndex: =8

                Label3_34 As label:
                    Height: =25
                    Size: =11
                    Text: ="Hiệu lực từ (*)"
                    Width: =140
                    X: =690
                    Y: =24
                    ZIndex: =9

                dpNgayHDNHD As datepicker:
                    BorderColor: =RGBA(72, 163, 62, 1)
                    DefaultDate: =First(objHD).NGAY_HOP_DONG
                    EndYear: =2200
                    Format: ="dd/mm/yyyy"
                    Height: =32
                    InputTextPlaceholder: =
                    IsEditable: =true
                    Size: =11
                    StartYear: =1900
                    Width: =200
                    X: =380
                    Y: =52
                    ZIndex: =13

                Label3_33 As label:
                    Height: =25
                    Size: =11
                    Text: ="Ngày hợp đồng (*)"
                    Width: =140
                    X: =380
                    Y: =24
                    ZIndex: =14

                dpHLTuNHD As datepicker:
                    BorderColor: =RGBA(72, 163, 62, 1)
                    DefaultDate: =First(objHD).HIEU_LUC_TU
                    EndYear: =2200
                    Format: ="dd/mm/yyyy"
                    Height: =32
                    InputTextPlaceholder: =
                    IsEditable: =true
                    Size: =11
                    StartYear: =1900
                    Width: =200
                    X: =690
                    Y: =52
                    ZIndex: =15

                dpHLDenNHD As datepicker:
                    BorderColor: =RGBA(72, 163, 62, 1)
                    DefaultDate: =First(objHD).HIEU_LUC_DEN
                    EndYear: =2200
                    Format: ="dd/mm/yyyy"
                    Height: =32
                    InputTextPlaceholder: =
                    IsEditable: =true
                    Size: =11
                    StartYear: =1900
                    Width: =200
                    X: =990
                    Y: =52
                    ZIndex: =16

                cbxDVTienNHD As combobox:
                    BorderColor: =RGBA(72, 163, 62, 1)
                    DefaultSelectedItems: =If(IsBlank(First(objHD).MA_HOP_DONG),LookUp(BH_DM_TIENTES,TIEN_TE="VND"),LookUp(BH_DM_TIENTES,TIEN_TE=First(objHD).DONVI_TIEN))
                    DisplayFields: =["cr282_tien_te"]
                    Height: =32
                    InputTextPlaceholder: ="Chọn đơn vị tiền"
                    Items: =BH_DM_TIENTES
                    SearchFields: =["cr282_id"]
                    SearchItems: =Search(BH_DM_TIENTES,cbxDVTienNHD.SearchText,"cr282_id")
                    SelectMultiple: =false
                    Size: =11
                    Width: =200
                    X: =380
                    Y: =122
                    ZIndex: =17

                Label3_38 As label:
                    Height: =25
                    Size: =11
                    Text: ="Đơn vị tiền (*)"
                    Width: =140
                    X: =380
                    Y: =95
                    ZIndex: =18

                Label3_36 As label:
                    FontWeight: =FontWeight.Bold
                    Height: =20
                    Size: =11
                    Text: ="1. Thông tin chung"
                    Width: =254
                    Y: =4
                    ZIndex: =19

                Label3_39 As label:
                    Height: =25
                    Size: =11
                    Text: ="Phương thức thanh toán"
                    Width: =190
                    X: =690
                    Y: =95
                    ZIndex: =20

                cbxPTTTNHD As combobox:
                    BorderColor: =RGBA(72, 163, 62, 1)
                    DefaultSelectedItems: |-
                        =LookUp([{title:"Tiền mặt",value:"0"},{title:"Chuyển khoản",value:"1"}],value=First(objHD).PTHUC_THANH_TOAN)
                    DisplayFields: =["title"]
                    Height: =32
                    InputTextPlaceholder: ="Chọn phương thức TT"
                    Items: |-
                        =[{title:"Tiền mặt",value:"0"},{title:"Chuyển khoản",value:"1"}]
                    SearchFields: =["title"]
                    SearchItems: |-
                        =Search([{title:"Tiền mặt",value:"0"},{title:"Chuyển khoản",value:"1"}],cbxPTTTNHD.SearchText,"title")
                    SelectMultiple: =false
                    Size: =11
                    Width: =200
                    X: =690
                    Y: =122
                    ZIndex: =21

            Container3_3 As groupContainer.manualLayoutContainer:
                Height: =99
                Width: =1267
                X: =16
                Y: =183
                ZIndex: =2

                Label3_41 As label:
                    Height: =25
                    Size: =11
                    Text: ="Loại kênh bán (*)"
                    Width: =137
                    X: =70
                    Y: =25
                    ZIndex: =1

                Label3_44 As label:
                    Height: =25
                    Size: =11
                    Text: ="Đơn vị kênh bán"
                    Width: =133
                    X: =990
                    Y: =25
                    ZIndex: =3

                Label3_43 As label:
                    Height: =25
                    Size: =11
                    Text: ="Tên kênh bán (*)"
                    Width: =140
                    X: =690
                    Y: =25
                    ZIndex: =9

                Label3_42 As label:
                    Height: =25
                    Size: =11
                    Text: ="Mã kênh bán (*)"
                    Width: =140
                    X: =380
                    Y: =25
                    ZIndex: =14

                Label3_40 As label:
                    FontWeight: =FontWeight.Bold
                    Height: =20
                    Size: =11
                    Text: ="2. Kênh bán"
                    Width: =254
                    Y: =4
                    ZIndex: =19

                tiTenKBNHD As text:
                    BorderColor: =RGBA(72, 163, 62, 1)
                    Default: =First(objHD).TEN_KENH_BAN
                    Height: =32
                    Size: =11
                    Width: =200
                    X: =690
                    Y: =52
                    ZIndex: =20

                cbxLoaiKBNHD As combobox:
                    BorderColor: =RGBA(72, 163, 62, 1)
                    DefaultSelectedItems: =LookUp(DM_LOAI_KENH_BANS,MA_LOAI_KB=First(objHD).LOAI_KENH_BAN)
                    DisplayFields: =["cr282_ten_loai_kb"]
                    Height: =32
                    InputTextPlaceholder: ="Chọn loại kênh bán"
                    Items: =DM_LOAI_KENH_BANS
                    OnChange: =Reset(cbxMaKBNHD)
                    SearchFields: =["cr282_ten_loai_kb"]
                    SearchItems: =Search(DM_LOAI_KENH_BANS,cbxLoaiKBNHD.SearchText,"cr282_ten_loai_kb")
                    SelectMultiple: =false
                    Size: =11
                    Width: =200
                    X: =70
                    Y: =52
                    ZIndex: =21

                cbxMaKBNHD As combobox:
                    BorderColor: =RGBA(72, 163, 62, 1)
                    DefaultSelectedItems: =LookUp(DM_KENH_BANS,MA_KENH_BAN=First(objHD).MA_KENH_BAN && LOAI=cbxLoaiKBNHD.Selected.MA_LOAI_KB)
                    DisplayFields: =["cr282_ma_kenh_ban","cr282_ten_kenh_ban"]
                    Height: =32
                    InputTextPlaceholder: ="Chọn mã kênh bán"
                    Items: =Filter(DM_KENH_BANS,LOAI=cbxLoaiKBNHD.Selected.MA_LOAI_KB)
                    OnChange: |-
                        =UpdateIf(
                            objHD,
                            true,
                            {
                                TEN_KENH_BAN:LookUp(DM_KENH_BANS,MA_KENH_BAN=cbxMaKBNHD.Selected.MA_KENH_BAN,TEN_KENH_BAN)
                            }
                        );
                        UpdateContext({
                            nhomKB:If(
                                LookUp(DM_LOAI_KENH_BANS,MA_LOAI_KB=cbxMaKBNHD.Selected.LOAI,CODE_KENH_BAN) in ["TT","CTV"],
                                "0",
                                LookUp(DM_LOAI_KENH_BANS,MA_LOAI_KB=cbxMaKBNHD.Selected.LOAI,CODE_KENH_BAN) in ["MG","BA"],
                                "1",
                                LookUp(DM_LOAI_KENH_BANS,MA_LOAI_KB=cbxMaKBNHD.Selected.LOAI,CODE_KENH_BAN) = "DL",
                                cbxMaKBNHD.Selected.LOAI_CANHAN_TOCHUC
                            )
                        })
                    SearchFields: =["cr282_ma_kenh_ban"]
                    SearchItems: =Search(Filter(DM_KENH_BANS,LOAI=cbxLoaiKBNHD.Selected.MA_LOAI_KB),cbxMaKBNHD.SearchText,"cr282_ma_kenh_ban")
                    SelectMultiple: =false
                    Size: =11
                    Template: =ListItemTemplate.Double
                    Width: =200
                    X: =380
                    Y: =52
                    ZIndex: =22

                cbxDVKBNHD As combobox:
                    BorderColor: =RGBA(72, 163, 62, 1)
                    DefaultSelectedItems: =LookUp(DM_DON_VI,MA_DON_VI=First(objHD).DONVI_KENHBAN)
                    DisplayFields: =["cr282_ten_don_vi","cr282_ma_don_vi"]
                    Height: =32
                    InputTextPlaceholder: ="Chọn đơn vị kênh bán"
                    Items: =DM_DON_VI
                    SearchFields: =["cr282_ten_don_vi"]
                    SearchItems: =Search(DM_DON_VI,cbxDVKBNHD.SearchText,"cr282_ten_don_vi")
                    SelectMultiple: =false
                    Size: =11
                    Template: =ListItemTemplate.Double
                    Width: =200
                    X: =990
                    Y: =52
                    ZIndex: =23

            Container3_4 As groupContainer.manualLayoutContainer:
                Height: =239
                Width: =1267
                X: =16
                Y: =282
                ZIndex: =3

                Label3_46 As label:
                    Height: =25
                    Size: =11
                    Text: ="Mã khách hàng (*)"
                    Width: =137
                    X: =70
                    Y: =25
                    ZIndex: =1

                Label3_49 As label:
                    Height: =25
                    Size: =11
                    Text: ="Ngày sinh/Thành lập"
                    Width: =160
                    X: =70
                    Y: =92
                    ZIndex: =3

                Label3_48 As label:
                    Height: =25
                    Size: =11
                    Text: ="Địa chỉ"
                    Width: =83
                    X: =690
                    Y: =25
                    ZIndex: =9

                Label3_47 As label:
                    Height: =25
                    Size: =11
                    Text: ="Tên khách hàng (*)"
                    Width: =140
                    X: =380
                    Y: =25
                    ZIndex: =14

                dpNSinhNHD As datepicker:
                    BorderColor: =RGBA(72, 163, 62, 1)
                    DefaultDate: =First(objHD).NGAY_SINH
                    EndYear: =2200
                    Format: ="dd/mm/yyyy"
                    Height: =32
                    InputTextPlaceholder: =
                    IsEditable: =true
                    Size: =11
                    StartYear: =1900
                    Width: =200
                    X: =70
                    Y: =120
                    ZIndex: =16

                Label3_45 As label:
                    FontWeight: =FontWeight.Bold
                    Height: =20
                    Size: =11
                    Text: ="3. Khách hàng"
                    Width: =254
                    Y: =4
                    ZIndex: =19

                tiDChiNHD As text:
                    BorderColor: =RGBA(72, 163, 62, 1)
                    Default: =First(objHD).DIA_CHI
                    Height: =32
                    Size: =11
                    Width: =200
                    X: =690
                    Y: =52
                    ZIndex: =20

                cbxMaKHNHD As combobox:
                    BorderColor: =RGBA(72, 163, 62, 1)
                    DefaultSelectedItems: =LookUp(DM_KHACH_HANG,MA_KHACH_HANG=First(objHD).MA_KHACH_HANG)
                    DisplayFields: =["cr282_ma_khach_hang","cr282_ten_khach_hang"]
                    Height: =32
                    InputTextPlaceholder: ="Chọn mã khách hàng"
                    Items: =DM_KHACH_HANG
                    OnChange: |-
                        =UpdateIf(
                            objHD,
                            true,
                            {
                                TEN_KHACH_HANG:LookUp(DM_KHACH_HANG,MA_KHACH_HANG=cbxMaKHNHD.Selected.MA_KHACH_HANG,TEN_KHACH_HANG),
                                DIA_CHI:LookUp(DM_KHACH_HANG,MA_KHACH_HANG=cbxMaKHNHD.Selected.MA_KHACH_HANG,DIA_CHI_KH),
                                NGAY_SINH:LookUp(DM_KHACH_HANG,MA_KHACH_HANG=cbxMaKHNHD.Selected.MA_KHACH_HANG,NGAY_SINH),
                                GIOI_TINH:LookUp(DM_KHACH_HANG,MA_KHACH_HANG=cbxMaKHNHD.Selected.MA_KHACH_HANG,MA_GIOI_TINH),
                                SO_DIEN_THOAI:LookUp(DM_KHACH_HANG,MA_KHACH_HANG=cbxMaKHNHD.Selected.MA_KHACH_HANG,SDT_KHACH_HANG),
                                EMAIL:LookUp(DM_KHACH_HANG,MA_KHACH_HANG=cbxMaKHNHD.Selected.MA_KHACH_HANG,EMAIL),
                                LOAI_KHACH_HANG:LookUp(DM_KHACH_HANG,MA_KHACH_HANG=cbxMaKHNHD.Selected.MA_KHACH_HANG,LOAI_KHACH_HANG),
                                NGHE_NGHIEP:LookUp(DM_KHACH_HANG,MA_KHACH_HANG=cbxMaKHNHD.Selected.MA_KHACH_HANG,NGANH_NGHE),
                                SO_NGUOI_TGIA:Text(LookUp(DM_KHACH_HANG,MA_KHACH_HANG=cbxMaKHNHD.Selected.MA_KHACH_HANG,SO_THANH_VIEN)),
                                TINH_TP_KH:LookUp(DM_KHACH_HANG,MA_KHACH_HANG=cbxMaKHNHD.Selected.MA_KHACH_HANG,MA_TINH),
                                NHOM_KHACH_HANG:LookUp(DM_KHACH_HANG,MA_KHACH_HANG=cbxMaKHNHD.Selected.MA_KHACH_HANG,MA_NHOM_KH)
                            }
                        )
                    SearchFields: =["cr282_ma_khach_hang"]
                    SearchItems: =Search(DM_KHACH_HANG,cbxMaKHNHD.SearchText,"cr282_ma_khach_hang")
                    SelectMultiple: =false
                    Size: =11
                    Template: =ListItemTemplate.Double
                    Width: =200
                    X: =70
                    Y: =52
                    ZIndex: =21

                tiTenKHNHD As text:
                    BorderColor: =RGBA(72, 163, 62, 1)
                    Default: =First(objHD).TEN_KHACH_HANG
                    Height: =32
                    Size: =11
                    Width: =200
                    X: =380
                    Y: =52
                    ZIndex: =22

                cbxGTinhNHD As combobox:
                    BorderColor: =RGBA(72, 163, 62, 1)
                    DefaultSelectedItems: =LookUp(DM_GIOI_TINHS,MA_GIOI_TINH=First(objHD).GIOI_TINH)
                    DisplayFields: =["cr282_ten_gioi_tinh"]
                    Height: =32
                    InputTextPlaceholder: ="Chọn giới tính"
                    Items: =DM_GIOI_TINHS
                    SearchFields: =["cr282_ten_gioi_tinh"]
                    SearchItems: =Search(DM_GIOI_TINHS,cbxGTinhNHD.SearchText,"cr282_ten_gioi_tinh")
                    SelectMultiple: =false
                    Size: =11
                    Width: =200
                    X: =380
                    Y: =120
                    ZIndex: =23

                Label3_50 As label:
                    Height: =25
                    Size: =11
                    Text: ="Giới tính"
                    Width: =83
                    X: =380
                    Y: =92
                    ZIndex: =24

                tiSDTNHD As text:
                    BorderColor: =RGBA(72, 163, 62, 1)
                    Default: =First(objHD).SO_DIEN_THOAI
                    Height: =32
                    Size: =11
                    Width: =200
                    X: =690
                    Y: =120
                    ZIndex: =25

                tiEmailNHD As text:
                    BorderColor: =RGBA(72, 163, 62, 1)
                    Default: =First(objHD).EMAIL
                    Height: =32
                    Size: =11
                    Width: =200
                    X: =990
                    Y: =120
                    ZIndex: =26

                tiSoNTGNHD As text:
                    BorderColor: =RGBA(72, 163, 62, 1)
                    Default: =First(objHD).SO_NGUOI_TGIA
                    Height: =32
                    Size: =11
                    Width: =200
                    X: =990
                    Y: =190
                    ZIndex: =27

                cbxNgheNHD As combobox:
                    BorderColor: =RGBA(72, 163, 62, 1)
                    DefaultSelectedItems: =LookUp(BH_DM_NGANHNGHES,MA_NHOM_NGANH=First(objHD).NGHE_NGHIEP)
                    DisplayFields: =["cr282_ten_nganh"]
                    Height: =32
                    InputTextPlaceholder: ="Chọn nghề nghiệp"
                    Items: =BH_DM_NGANHNGHES
                    SearchFields: =["cr282_id"]
                    SearchItems: =Search(BH_DM_NGANHNGHES,cbxNgheNHD.SearchText,"cr282_id")
                    SelectMultiple: =false
                    Size: =11
                    Width: =200
                    X: =690
                    Y: =190
                    ZIndex: =28

                Label3_51 As label:
                    Height: =25
                    Size: =11
                    Text: ="Số điện thoại"
                    Width: =140
                    X: =690
                    Y: =92
                    ZIndex: =29

                Label3_52 As label:
                    Height: =25
                    Size: =11
                    Text: ="Email"
                    Width: =83
                    X: =990
                    Y: =92
                    ZIndex: =30

                cbxLoaiKHNHD As combobox:
                    BorderColor: =RGBA(72, 163, 62, 1)
                    DefaultSelectedItems: |-
                        =LookUp([{title:"Cá nhân",value:"0"},{title:"Tổ chức",value:"1"}],value=First(objHD).LOAI_KHACH_HANG)
                    DisplayFields: =["title"]
                    Height: =32
                    InputTextPlaceholder: ="Chọn loại khách hàng"
                    IsSearchable: =false
                    Items: |-
                        =[{title:"Cá nhân",value:"0"},{title:"Tổ chức",value:"1"}]
                    SearchFields: =["title"]
                    SearchItems: =[]
                    SelectMultiple: =false
                    Size: =11
                    Width: =200
                    X: =70
                    Y: =190
                    ZIndex: =31

                Label3_53 As label:
                    Height: =25
                    Size: =11
                    Text: ="Loại khách hàng"
                    Width: =140
                    X: =70
                    Y: =162
                    ZIndex: =32

                Label3_54 As label:
                    Height: =25
                    Size: =11
                    Text: ="Nghề nghiệp/Nhóm nghề"
                    Width: =200
                    X: =690
                    Y: =162
                    ZIndex: =33

                Label3_55 As label:
                    Height: =25
                    Size: =11
                    Text: ="Tổng số người tham gia"
                    Width: =200
                    X: =990
                    Y: =162
                    ZIndex: =34

                cbxTinhNHD As combobox:
                    BorderColor: =RGBA(72, 163, 62, 1)
                    DefaultSelectedItems: =LookUp(Filter(DM_PHAMVI_DIALYS,LOAI="TINH_TP"),MA_PHAMVI=First(objHD).TINH_TP_KH)
                    DisplayFields: =["cr282_ten_phamvi"]
                    Height: =32
                    InputTextPlaceholder: ="Chọn tỉnh/thành phố"
                    Items: =Filter(DM_PHAMVI_DIALYS,LOAI="TINH_TP")
                    SearchFields: =["cr282_ma_phamvi"]
                    SearchItems: =Search(Filter(DM_PHAMVI_DIALYS,LOAI="TINH_TP"),cbxTinhNHD.SearchText,"cr282_ma_phamvi")
                    SelectMultiple: =false
                    Size: =11
                    Width: =200
                    X: =990
                    Y: =52
                    ZIndex: =35

                Label3_57 As label:
                    Height: =25
                    Size: =11
                    Text: ="Tỉnh/TP"
                    Width: =83
                    X: =990
                    Y: =25
                    ZIndex: =36

                cbxNhomKHNHD As combobox:
                    BorderColor: =RGBA(72, 163, 62, 1)
                    DefaultSelectedItems: =LookUp(DM_NHOM_KH,MA_NHOM_KH=First(objHD).NHOM_KHACH_HANG)
                    DisplayFields: =["cr282_ten_nhom_kh"]
                    Height: =32
                    InputTextPlaceholder: ="Chọn loại khách hàng"
                    IsSearchable: =false
                    Items: =DM_NHOM_KH
                    SearchFields: =["cr282_ten_nhom_kh"]
                    SearchItems: =[]
                    SelectMultiple: =false
                    Size: =11
                    Width: =200
                    X: =380
                    Y: =190
                    ZIndex: =37

                Label3_56 As label:
                    Height: =25
                    Size: =11
                    Text: ="Nhóm khách hàng"
                    Width: =140
                    X: =380
                    Y: =162
                    ZIndex: =38

            Container3_5 As groupContainer.manualLayoutContainer:
                Height: =315
                Width: =1267
                X: =16
                Y: =521
                ZIndex: =4

                Label3_58 As label:
                    FontWeight: =FontWeight.Bold
                    Height: =20
                    Size: =11
                    Text: ="4. Sản phẩm"
                    Width: =254
                    Y: =4
                    ZIndex: =19

                Gallery3_2 As gallery.variableTemplateHeightGallery:
                    DelayItemLoading: =true
                    Height: =226
                    Items: |-
                        =SortByColumns(
                            tmpDSHDSPNHDCollect,
                            "cr282_id",
                            SortOrder.Ascending
                        )
                    Layout: =Layout.Vertical
                    LoadingSpinner: =LoadingSpinner.Data
                    TemplateSize: =220
                    Width: =1267
                    Y: =76
                    ZIndex: =21

                    Label3_59 As label:
                        Height: =25
                        Size: =11
                        Text: ="Mã sản phẩm (*)"
                        Width: =130
                        X: =70
                        Y: =40
                        ZIndex: =2

                    Label3_61 As label:
                        Height: =25
                        Size: =11
                        Text: ="Tên chương trình"
                        Width: =140
                        X: =990
                        Y: =40
                        ZIndex: =3

                    Label3_62 As label:
                        Height: =25
                        Size: =11
                        Text: ="Mã chương trình (*)"
                        Width: =160
                        X: =690
                        Y: =40
                        ZIndex: =4

                    Label3_60 As label:
                        Height: =25
                        Size: =11
                        Text: ="Tên sản phẩm"
                        Width: =140
                        X: =380
                        Y: =40
                        ZIndex: =5

                    tiSoNTGSPNHD As text:
                        Align: =Align.Right
                        BorderColor: =RGBA(72, 163, 62, 1)
                        Default: =ThisItem.SONGUOI_THAMGIA
                        DisplayMode: =DisplayMode.Disabled
                        Format: =TextFormat.Number
                        Height: =32
                        Size: =11
                        Width: =200
                        X: =380
                        Y: =139
                        ZIndex: =7

                    tiTongPhiNHD As text:
                        Align: =Align.Right
                        BorderColor: =RGBA(72, 163, 62, 1)
                        Default: =ThisItem.TONG_TIEN_PHI
                        DisplayMode: =DisplayMode.Disabled
                        Format: =TextFormat.Number
                        Height: =32
                        Size: =11
                        Width: =200
                        X: =690
                        Y: =139
                        ZIndex: =8

                    Label3_64 As label:
                        Height: =25
                        Size: =11
                        Text: ="Số người tham gia"
                        Width: =140
                        X: =380
                        Y: =110
                        ZIndex: =9

                    Label3_65 As label:
                        Height: =25
                        Size: =11
                        Text: ="Tổng phí/Nhóm"
                        Width: =140
                        X: =690
                        Y: =110
                        ZIndex: =10

                    tiTenSPNHD As text:
                        BorderColor: =RGBA(72, 163, 62, 1)
                        Default: =LookUp(DL_SAN_PHAM,MA_SAN_PHAM=cbxMaSPNHD.Selected.MA_SAN_PHAM,TEN_SAN_PHAM)
                        DisplayMode: =DisplayMode.Disabled
                        Height: =32
                        Size: =11
                        Width: =200
                        X: =380
                        Y: =68
                        ZIndex: =11

                    tiTenCTNHD As text:
                        BorderColor: =RGBA(72, 163, 62, 1)
                        Default: =LookUp(' DL_SAN_PHAM_CT',MA_SAN_PHAM=cbxMaSPNHD.Selected.MA_SAN_PHAM && MA_CHUONG_TRINH=cbxMaCTNHD.Selected.MA_CHUONG_TRINH,TEN_CHUONG_TRINH)
                        DisplayMode: =DisplayMode.Disabled
                        Height: =32
                        Size: =11
                        Width: =200
                        X: =990
                        Y: =68
                        ZIndex: =12

                    cbxMaCTNHD As combobox:
                        BorderColor: =RGBA(72, 163, 62, 1)
                        DefaultSelectedItems: |
                            =LookUp(
                                ' DL_SAN_PHAM_CT',
                                MA_SAN_PHAM=cbxMaSPNHD.Selected.MA_SAN_PHAM && MA_CHUONG_TRINH=ThisItem.MA_CHUONG_TRINH
                            )
                        DisplayFields: =["cr282_ma_chuongtrinh","cr282_ten_chuong_trinh"]
                        DisplayMode: =If(ThisItem.edited=1 && ThisItem.added=1,DisplayMode.Edit,DisplayMode.Disabled)
                        Height: =32
                        InputTextPlaceholder: ="Chọn chương trình"
                        Items: =Filter(' DL_SAN_PHAM_CT',MA_SAN_PHAM=cbxMaSPNHD.Selected.MA_SAN_PHAM)
                        SearchFields: =["cr282_ma_chuong_trinh"]
                        SearchItems: =Search(Filter(' DL_SAN_PHAM_CT',MA_SAN_PHAM=cbxMaSPNHD.Selected.MA_SAN_PHAM),cbxMaCTNHD.SearchText,"cr282_ma_chuong_trinh")
                        SelectMultiple: =false
                        Size: =11
                        Template: =ListItemTemplate.Double
                        Width: =200
                        X: =690
                        Y: =68
                        ZIndex: =14

                    cbxMaSPNHD As combobox:
                        BorderColor: =RGBA(72, 163, 62, 1)
                        DefaultSelectedItems: =LookUp(DL_SAN_PHAM,MA_SAN_PHAM=ThisItem.MA_SAN_PHAM)
                        DisplayFields: =["cr282_ma_san_pham","cr282_ten_san_pham"]
                        DisplayMode: =If(ThisItem.edited=1 && ThisItem.added=1,DisplayMode.Edit,DisplayMode.Disabled)
                        Height: =32
                        InputTextPlaceholder: ="Chọn sản phẩm"
                        Items: =DL_SAN_PHAM
                        OnChange: =Reset(cbxMaCTNHD)
                        SearchFields: =["cr282_ma_san_pham"]
                        SearchItems: =Search(DL_SAN_PHAM,cbxMaSPNHD.SearchText,"cr282_ma_san_pham")
                        SelectMultiple: =false
                        Size: =11
                        Template: =ListItemTemplate.Double
                        Width: =200
                        X: =70
                        Y: =68
                        ZIndex: =15

                    btnXoaHDSPNHD As button:
                        Height: =32
                        OnSelect: |-
                            =If(
                                Or(maAddedHDSPNHD<>"",maUpdatedHDSPNHD<>""),
                                Notify("Có dữ liệu chưa được lưu",NotificationType.Warning,2000),
                                Refresh(DL_HOP_DONG_SPS);
                                RemoveIf(DL_HOP_DONG_SPS,ID=ThisItem.ID);
                                RemoveIf(tmpDSHDSPNHDCollect,ID=ThisItem.ID);
                                Notify("Xóa dữ liệu thành công", NotificationType.Success,2000)
                            )
                        Size: =11
                        Text: ="Xóa"
                        Visible: =ThisItem.edited=0
                        Width: =90
                        X: =1063
                        Y: =188
                        ZIndex: =16

                    btnLuuHDSPNHD As button:
                        Height: =32
                        OnSelect: |-
                            =UpdateIf(
                                tmpDSHDSPNHDCollect,
                                ID=ThisItem.ID,
                                {
                                    MA_SAN_PHAM:cbxMaSPNHD.Selected.MA_SAN_PHAM,
                                    TEN_SAN_PHAM:tiTenSPNHD.Text,
                                    MA_CHUONG_TRINH:cbxMaCTNHD.Selected.MA_CHUONG_TRINH,
                                    TEN_CHUONG_TRINH:tiTenCTNHD.Text,
                                    PTHUC_THANH_TOAN:cbxPTTTNHD.Selected.value,
                                    SONGUOI_THAMGIA:Value(tiSoNTGSPNHD.Text),
                                    TONG_TIEN_PHI:Value(tiTongPhiNHD.Text),
                                    edited:0
                                }
                            );
                            UpdateContext({
                                maAddedHDSPNHD:"",
                                maUpdatedHDSPNHD:""
                            });
                        Size: =11
                        Text: ="Lưu"
                        Visible: =ThisItem.edited=1
                        Width: =90
                        X: =953
                        Y: =188
                        ZIndex: =17

                    btnSuaHDSPNHD As button:
                        Height: =32
                        OnSelect: |-
                            =If(
                                Or(maAddedHDSPNHD<>"",maUpdatedHDSPNHD<>""),
                                Notify("Có dữ liệu chưa được lưu",NotificationType.Warning,2000),
                                UpdateIf(
                                    tmpDSHDSPNHDCollect,
                                    ID=ThisItem.ID,
                                    {
                                        edited:1
                                    }
                                );
                                UpdateContext({
                                    maUpdatedHDSPNHD:ThisItem.ID
                                })
                            )
                        Size: =11
                        Text: ="Sửa"
                        Visible: =ThisItem.edited=0
                        Width: =90
                        X: =953
                        Y: =188
                        ZIndex: =18

                    btnHuyHDSPNHD As button:
                        Height: =32
                        OnSelect: |-
                            =If(
                                ThisItem.ID=maAddedHDSPNHD,
                                Remove(tmpDSHDSPNHDCollect,ThisItem),
                                UpdateIf(
                                    tmpDSHDSPNHDCollect,
                                    ID=ThisItem.ID,
                                    {
                                        edited:0
                                    }
                                )
                            );
                            UpdateContext({
                                maAddedHDSPNHD:"",
                                maUpdatedHDSPNHD:""
                            });
                        Size: =11
                        Text: ="Hủy"
                        Visible: =ThisItem.edited=1
                        Width: =90
                        X: =1063
                        Y: =188
                        ZIndex: =19

                    LinkHDLK_1 As text:
                        BorderThickness: =0
                        Color: =RGBA(39, 113, 194, 1)
                        Default: ="Danh sách NĐBH"
                        DisabledBorderColor: =RGBA(255, 255, 255, 1)
                        DisabledFill: =RGBA(255, 255, 255, 1)
                        DisplayMode: =If(ThisItem.edited=1,DisplayMode.Edit,DisplayMode.Disabled)
                        Height: =28
                        HoverBorderColor: =RGBA(255, 255, 255, 1)
                        HoverColor: =RGBA(39, 113, 194, 1)
                        HoverFill: =RGBA(255, 255, 255, 1)
                        OnSelect: |
                            =Set(idColSP,ThisItem.ID);
                            Set(
                                varMaSP,
                                cbxMaSPNHD.Selected.MA_SAN_PHAM
                            );
                            Set(
                                varMaHD,
                                If(IsBlank(tiMaHDNHD.Text),maHopDongFwd,tiMaHDNHD.Text) 
                            );
                            Set(
                                varMaCT,
                                cbxMaCTNHD.Selected.MA_CHUONG_TRINH
                            );
                            Set(
                                varNhomTP,
                                "Nhóm chính"
                            );
                            ClearCollect(
                                tmpNDBH,
                                ShowColumns(
                                    AddColumns(
                                        SortByColumns(
                                            Filter(
                                                DL_HOP_DONG_SP_NDBH,
                                                MA_HOP_DONG = varMaHD && MA_SAN_PHAM = varMaSP && MA_CHUONG_TRINH = varMaCT
                                            ),
                                            "cr282_id",
                                            SortOrder.Descending
                                        ),
                                        "edited",
                                        0
                                    ),
                                    "cr282_id",
                                    "cr282_ma_hop_dong",
                                    "cr282_ma_san_pham",
                                    "cr282_mst",
                                    "cr282_ten_ndbh",
                                    "cr282_dia_chi",
                                    "cr282_sdt",
                                    "cr282_email",
                                    "cr282_ma_gioi__tinh",
                                    "cr282_ma_nhan_vien",
                                    "cr282_ma_tinh_tp",
                                    "cr282_moi_quan_he",
                                    "cr282_ngay_sinh",
                                    "cr282_nhom",
                                    "cr282_so_giay_to",
                                    "cr282_phi_ndbh",
                                    "cr282_ma_chuong_trinh",
                                    "cr282_nhom_tinh_phi",
                                    "edited"
                                )
                            );
                            UpdateContext(
                                {
                                    maAddedNDBH: "",
                                    maUpdatedNDBH: ""
                                }
                            );
                            Navigate(NhapNDBH);
                        Size: =11
                        Underline: =true
                        Width: =142
                        X: =980
                        Y: =145
                        ZIndex: =20

                    Label3_66 As label:
                        Height: =25
                        Size: =11
                        Text: ="LHNV"
                        Width: =140
                        X: =70
                        Y: =110
                        ZIndex: =21

                    tiPhiNGNHD_1 As text:
                        BorderColor: =RGBA(72, 163, 62, 1)
                        Default: =LookUp(DL_SAN_PHAM,MA_SAN_PHAM=cbxMaSPNHD.Selected.MA_SAN_PHAM,LHNV)
                        DisplayMode: =DisplayMode.Disabled
                        Height: =32
                        Size: =11
                        Width: =200
                        X: =70
                        Y: =139
                        ZIndex: =22

                Button2_3 As button:
                    Height: =32
                    OnSelect: |
                        =If(
                            Or(maAddedHDSPNHD<>"",maUpdatedHDSPNHD<>""),
                            Notify("Có dữ liệu chưa được lưu",NotificationType.Warning,2000),
                            Collect(
                                tmpDSHDSPNHDCollect,
                                Defaults(tmpDSHDSPNHDCollect)
                            );
                            UpdateIf(
                                tmpDSHDSPNHDCollect,
                                IsBlank(ID),
                                {
                                    ID:Text(maHDSP+1),
                                    added:1,
                                    edited:1
                                }
                            );
                            UpdateContext({
                                maAddedHDSPNHD:Text(maHDSP+1),
                                maHDSP:maHDSP+1
                            });
                            Reset(LinkHDLK);
                        )
                    Size: =11
                    Text: ="Thêm mới"
                    Width: =100
                    X: =12
                    Y: =36
                    ZIndex: =22

            Container3_6 As groupContainer.manualLayoutContainer:
                Height: =262
                Width: =1267
                X: =16
                Y: =836
                ZIndex: =5

                Label3_67 As label:
                    FontWeight: =FontWeight.Bold
                    Height: =20
                    Size: =11
                    Text: ="5. Hợp đồng liên kết"
                    Width: =254
                    Y: =4
                    ZIndex: =19

                Gallery3_1 As gallery.variableTemplateHeightGallery:
                    DelayItemLoading: =true
                    Height: =190
                    Items: |-
                        =SortByColumns(
                            Filter(
                                DL_HOP_DONG_LIENKETS,
                                SO_HOP_DONG=First(objHD).MA_HOP_DONG
                            ),
                            "cr282_so_hop_dong_lk",
                            SortOrder.Ascending,
                            "cr282_ma_khach_hang",
                            SortOrder.Ascending
                        )
                    Layout: =Layout.Vertical
                    LoadingSpinner: =LoadingSpinner.Data
                    TemplateSize: =170
                    Width: =1267
                    Y: =62
                    ZIndex: =21

                    Label3_68 As label:
                        Height: =25
                        Size: =11
                        Text: ="Số HĐ liên kết"
                        Width: =130
                        X: =40
                        Y: =40
                        ZIndex: =2

                    Label3_71 As label:
                        Height: =25
                        Size: =11
                        Text: ="Mã kênh bán"
                        Width: =140
                        X: =953
                        Y: =40
                        ZIndex: =3

                    Label3_72 As label:
                        Height: =25
                        Size: =11
                        Text: ="Mã sản phẩm"
                        Width: =168
                        X: =40
                        Y: =110
                        ZIndex: =4

                    Label3_70 As label:
                        Height: =25
                        Size: =11
                        Text: ="Tên khách hàng"
                        Width: =140
                        X: =660
                        Y: =40
                        ZIndex: =5

                    Label3_69 As label:
                        Height: =25
                        Size: =11
                        Text: ="Mã khách hàng"
                        Width: =140
                        X: =350
                        Y: =40
                        ZIndex: =6

                    Label3_73 As label:
                        Height: =25
                        Size: =11
                        Text: ="Tên sản phẩm"
                        Width: =140
                        X: =350
                        Y: =110
                        ZIndex: =7

                    tiSoHDLKNHD_1 As text:
                        BorderColor: =RGBA(72, 163, 62, 1)
                        Default: =ThisItem.SO_HOP_DONG_LK
                        DisplayMode: =DisplayMode.Disabled
                        Height: =32
                        Size: =11
                        Width: =200
                        X: =40
                        Y: =68
                        ZIndex: =8

                    tiMaCTLKNHD_1 As text:
                        BorderColor: =RGBA(72, 163, 62, 1)
                        Default: =ThisItem.MA_CHUONG_TRINH
                        DisplayMode: =DisplayMode.Disabled
                        Height: =32
                        Size: =11
                        Width: =200
                        X: =660
                        Y: =138
                        ZIndex: =9

                    tiTenCTLKNHD_1 As text:
                        BorderColor: =RGBA(72, 163, 62, 1)
                        Default: =ThisItem.TEN_CHUONG_TRINH
                        DisplayMode: =DisplayMode.Disabled
                        Height: =32
                        Size: =11
                        Width: =200
                        X: =953
                        Y: =138
                        ZIndex: =10

                    Label3_74 As label:
                        Height: =25
                        Size: =11
                        Text: ="Mã chương trình"
                        Width: =140
                        X: =660
                        Y: =110
                        ZIndex: =11

                    Label3_75 As label:
                        Height: =25
                        Size: =11
                        Text: ="Tên chương trình"
                        Width: =140
                        X: =953
                        Y: =110
                        ZIndex: =12

                    tiMaKHLKNHD_1 As text:
                        BorderColor: =RGBA(72, 163, 62, 1)
                        Default: =ThisItem.MA_KHACH_HANG
                        DisplayMode: =DisplayMode.Disabled
                        Height: =32
                        Size: =11
                        Width: =200
                        X: =350
                        Y: =68
                        ZIndex: =13

                    tiTenKHLKNHD_1 As text:
                        BorderColor: =RGBA(72, 163, 62, 1)
                        Default: =LookUp(DM_KHACH_HANG,MA_KHACH_HANG=ThisItem.MA_KHACH_HANG,TEN_KHACH_HANG)
                        DisplayMode: =DisplayMode.Disabled
                        Height: =32
                        Size: =11
                        Width: =200
                        X: =660
                        Y: =68
                        ZIndex: =14

                    tiTenKBLKNHD_1 As text:
                        BorderColor: =RGBA(72, 163, 62, 1)
                        Default: =ThisItem.MA_KENH_BAN
                        DisplayMode: =DisplayMode.Disabled
                        Height: =32
                        Size: =11
                        Width: =200
                        X: =953
                        Y: =68
                        ZIndex: =15

                    tiMaSPLKNHD_1 As text:
                        BorderColor: =RGBA(72, 163, 62, 1)
                        Default: =ThisItem.MA_SAN_PHAM
                        DisplayMode: =DisplayMode.Disabled
                        Height: =32
                        Size: =11
                        Width: =200
                        X: =40
                        Y: =138
                        ZIndex: =16

                    tiTenSPLKNHD_1 As text:
                        BorderColor: =RGBA(72, 163, 62, 1)
                        Default: =ThisItem.TEN_SAN_PHAM
                        DisplayMode: =DisplayMode.Disabled
                        Height: =32
                        Size: =11
                        Width: =200
                        X: =350
                        Y: =138
                        ZIndex: =17

                LinkHDLK As text:
                    BorderThickness: =0
                    Color: =RGBA(39, 113, 194, 1)
                    Default: ="Hợp đồng liên kết"
                    DisabledBorderColor: =RGBA(255, 255, 255, 1)
                    DisabledFill: =RGBA(255, 255, 255, 1)
                    DisplayMode: =If(CountIf(tmpDSHDSPNHDCollect,edited=1)=0 && CountIf(tmpDSHDSPNHDCollect,added=1)=0 && CountIf(DL_HOP_DONG_SPS,MA_HOP_DONG=tiMaHDNHD.Text)>0,DisplayMode.Edit,DisplayMode.Disabled)
                    Height: =28
                    HoverBorderColor: =RGBA(255, 255, 255, 1)
                    HoverColor: =RGBA(39, 113, 194, 1)
                    HoverFill: =RGBA(255, 255, 255, 1)
                    OnSelect: |-
                        =Set(dsMaSPNLKFwd,Concat(tmpDSHDSPNHDCollect,MA_SAN_PHAM,"|"));
                        Set(maHDNLKFwd,tiMaHDNHD.Text);
                        Set(maKBNLKFwd,cbxMaKBNHD.Selected.MA_KENH_BAN);
                        Set(maKHNLKFwd,cbxMaKHNHD.Selected.MA_KHACH_HANG);
                        Navigate(NhapHopDongLK)
                    Size: =11
                    Underline: =true
                    Width: =142
                    X: =20
                    Y: =30
                    ZIndex: =22

            Container3_8 As groupContainer.manualLayoutContainer:
                Height: =179
                Width: =1267
                X: =16
                Y: =1098
                ZIndex: =8

                Label3_76 As label:
                    FontWeight: =FontWeight.Bold
                    Height: =20
                    Size: =11
                    Text: ="6. Chính sách áp dụng"
                    Width: =254
                    Y: =4
                    ZIndex: =19

                LinkHDLK_2 As text:
                    BorderThickness: =0
                    Color: =RGBA(39, 113, 194, 1)
                    Default: ="Chọn chính sách"
                    DisabledBorderColor: =RGBA(255, 255, 255, 1)
                    DisabledFill: =RGBA(255, 255, 255, 1)
                    Height: =28
                    HoverBorderColor: =RGBA(255, 255, 255, 1)
                    HoverColor: =RGBA(39, 113, 194, 1)
                    HoverFill: =RGBA(255, 255, 255, 1)
                    OnSelect: |
                        =Set(
                            dsMaSPNLKFwd,
                            Concat(
                                tmpDSHDSPNHDCollect,
                                MA_SAN_PHAM,
                                "|"
                            )
                        );
                        Set(
                            maHDNLKFwd,
                            tiMaHDNHD.Text
                        );
                        Set(
                            maKBNLKFwd,
                            cbxMaKBNHD.Selected.MA_KENH_BAN
                        );
                        Set(
                            maKHNLKFwd,
                            cbxMaKHNHD.Selected.MA_KHACH_HANG
                        );
                        // check điều kiện áp dụng
                        // lọc điều kiện áp dụng
                        UpdateContext({errorMsg: ""});
                        // lọc điều kiện
                        // lấy danh sách các điều kiện áp dụng còn hoạt động và ngày hợp đồng nằm trong khoảng hiệu lực
                        ClearCollect (
                            tmpDieuKien,
                            Filter(
                                DL_DIEUKIEN_APDUNG,
                                TRANG_THAI = "true" && DateValue(HIEU_LUC_TU) <= DateValue(dpNgayHDNHD.SelectedDate)
                            )
                        );
                        ClearCollect(
                            tmpError,
                            {}
                        );
                        RemoveIf(
                            tmpError,
                            1 = 1
                        );
                        ClearCollect(
                            tmpPass,
                            {}
                        );
                        ClearCollect(
                            dsCombosp,
                            {}
                        );
                        ClearCollect(
                            dsCombospLt,
                            {}
                        );
                        ClearCollect(
                            GroupedSp,
                            {}
                        );
                        ClearCollect(
                            dsSpKetHop,
                            {}
                        );
                        RemoveIf(
                            tmpPass,
                            1 = 1
                        );
                        // nếu không có điều kiện thỏa mãn thì mặc định 
                        ForAll(
                            tmpDieuKien As dk,
                        //1. kiểm tra kênh bán   
                        //1.1. kiểm tra mã kênh bán
                        // Nếu kênh bán áp dụng cho tất cả và có loại trừ
                        // Tìm giá trị loại trừ mã kênh bán, loại kênh bán, cá nhân/tổ chức, nếu có dữ liệu thì false
                            RemoveIf(
                                tmpError,
                                1 = 1
                            );
                            RemoveIf(
                                dsCombosp,
                                1 = 1
                            );
                            RemoveIf(
                                dsSpKetHop,
                                1 = 1
                            );
                            RemoveIf(
                                GroupedSp,
                                1 = 1
                            );
                            If(
                                IsBlank(
                                    LookUp(
                                        DL_DIEUKIEN_APDUNG_LOAI_CT,
                                        MA_DIEU_KIEN = dk.MA_DIEU_KIEN && THANH_PHAN = "KB" && AP_DUNG = "1" && MA_TIEU_CHI = "MA_KB_DM"
                                    )
                                ) And !IsBlank(
                                    LookUp(
                                        DL_DIEUKIEN_APDUNG_LOAI_CT,
                                        MA_DIEU_KIEN = dk.MA_DIEU_KIEN && THANH_PHAN = "KB" && AP_DUNG = "2" && MA_TIEU_CHI = "MA_KB_DM" && MA_GIA_TRI = cbxMaKBNHD.Selected.MA_KENH_BAN
                                    )
                                ) And !IsBlank(cbxMaKBNHD.Selected.MA_KENH_BAN),
                                Collect(
                                    tmpError,
                                    {ID: 1}
                                );
                            );
                            
                        // Nếu kênh bán áp dụng 1 phần
                        // Tìm trong danh sách áp dụng theo mã kênh bán, loại kênh bán, cá nhân/tổ chức, nếu không có thì false
                        If(
                                !IsBlank(
                                    LookUp(
                                        DL_DIEUKIEN_APDUNG_LOAI_CT,
                                        MA_DIEU_KIEN = dk.MA_DIEU_KIEN && THANH_PHAN = "KB" && AP_DUNG = "1" && KIEU = "2" && MA_TIEU_CHI = "MA_KB_DM"
                                    )
                                ) And IsBlank(
                                    LookUp(
                                        DL_DIEUKIEN_APDUNG_LOAI_CT,
                                        MA_DIEU_KIEN = dk.MA_DIEU_KIEN && THANH_PHAN = "KB" && AP_DUNG = "1" && KIEU = "2" && MA_TIEU_CHI = "MA_KB_DM" && MA_GIA_TRI = cbxMaKBNHD.Selected.MA_KENH_BAN
                                    )
                                ) And !IsBlank(cbxMaKBNHD.Selected.MA_KENH_BAN),
                                Collect(
                                    tmpError,
                                    {ID: 2}
                                );
                            );
                            
                        // Nếu kênh bán áp dụng 1 phần
                        // Tìm trong danh sách áp dụng theo mã kênh bán nếu có dữ liệu
                        // Tìm trong danh sách loại trừ theo mã kênh bán nếu có dữ liệu thì -> false, nếu không có thì  -> pass
                        If(
                                !IsBlank(
                                    LookUp(
                                        DL_DIEUKIEN_APDUNG_LOAI_CT,
                                        MA_DIEU_KIEN = dk.MA_DIEU_KIEN && THANH_PHAN = "KB" && AP_DUNG = "1" && KIEU = "2" && MA_TIEU_CHI = "MA_KB_DM" && MA_GIA_TRI = cbxMaKBNHD.Selected.MA_KENH_BAN
                                    )
                                ) And !IsBlank(
                                    LookUp(
                                        DL_DIEUKIEN_APDUNG_LOAI_CT,
                                        MA_DIEU_KIEN = dk.MA_DIEU_KIEN && THANH_PHAN = "KB" && AP_DUNG = "2" && MA_TIEU_CHI = "MA_KB_DM" && MA_GIA_TRI = cbxMaKBNHD.Selected.MA_KENH_BAN
                                    )
                                ) And !IsBlank(cbxMaKBNHD.Selected.MA_KENH_BAN),
                                Collect(
                                    tmpError,
                                    {ID: 3}
                                );
                            );
                            
                        //1.2. kiểm tra loại kênh bán
                        // Nếu kênh bán áp dụng cho tất cả và có loại trừ
                        // Tìm giá trị loại trừ loại kênh bán nếu có dữ liệu thì false
                        If(
                                IsBlank(
                                    LookUp(
                                        DL_DIEUKIEN_APDUNG_LOAI_CT,
                                        MA_DIEU_KIEN = dk.MA_DIEU_KIEN && THANH_PHAN = "KB" && AP_DUNG = "1" && MA_TIEU_CHI = "MA_KB_LOAI"
                                    )
                                ) And !IsBlank(
                                    LookUp(
                                        DL_DIEUKIEN_APDUNG_LOAI_CT,
                                        MA_DIEU_KIEN = dk.MA_DIEU_KIEN && THANH_PHAN = "KB" && AP_DUNG = "2" && MA_TIEU_CHI = "MA_KB_LOAI" && MA_GIA_TRI = cbxLoaiKBNHD.Selected.MA_LOAI_KB
                                    )
                                ) And !IsBlank(cbxLoaiKBNHD.Selected.MA_LOAI_KB),
                                Collect(
                                    tmpError,
                                    {ID: 4}
                                );
                            );
                            
                        // Nếu kênh bán áp dụng 1 phần
                        // Tìm trong danh sách áp dụng theo mã kênh bán, loại kênh bán, cá nhân/tổ chức, nếu không có thì false
                        If(
                                !IsBlank(
                                    LookUp(
                                        DL_DIEUKIEN_APDUNG_LOAI_CT,
                                        MA_DIEU_KIEN = dk.MA_DIEU_KIEN && THANH_PHAN = "KB" && AP_DUNG = "1" && KIEU = "2" && MA_TIEU_CHI = "MA_KB_LOAI"
                                    )
                                ) And IsBlank(
                                    LookUp(
                                        DL_DIEUKIEN_APDUNG_LOAI_CT,
                                        MA_DIEU_KIEN = dk.MA_DIEU_KIEN && THANH_PHAN = "KB" && AP_DUNG = "1" && KIEU = "2" && MA_TIEU_CHI = "MA_KB_LOAI" && MA_GIA_TRI = cbxLoaiKBNHD.Selected.MA_LOAI_KB
                                    )
                                ) And !IsBlank(cbxLoaiKBNHD.Selected.MA_LOAI_KB),
                                Collect(
                                    tmpError,
                                    {ID: 5}
                                );
                            );
                            
                        // Nếu kênh bán áp dụng 1 phần
                        // Tìm trong danh sách áp dụng theo mã kênh bán, loại kênh bán, cá nhân/tổ chức, nếu có dữ liệu
                        // Tìm trong danh sách loại trừ (theo mã kênh bán, loại kênh bán, cá nhân/tổ chức) nếu có dữ liệu thì -> false, nếu không có thì  -> pass
                        If(
                                !IsBlank(
                                    LookUp(
                                        DL_DIEUKIEN_APDUNG_LOAI_CT,
                                        MA_DIEU_KIEN = dk.MA_DIEU_KIEN && THANH_PHAN = "KB" && AP_DUNG = "1" && KIEU = "2" && MA_TIEU_CHI = "MA_KB_LOAI" && MA_GIA_TRI = cbxMaKBNHD.Selected.MA_KENH_BAN
                                    )
                                ) And !IsBlank(
                                    LookUp(
                                        DL_DIEUKIEN_APDUNG_LOAI_CT,
                                        MA_DIEU_KIEN = dk.MA_DIEU_KIEN && THANH_PHAN = "KB" && AP_DUNG = "2" && (MA_GIA_TRI = cbxLoaiKBNHD.Selected.MA_LOAI_KB Or MA_GIA_TRI = cbxMaKBNHD.Selected.MA_KENH_BAN)
                                    )
                                ) And !IsBlank(cbxLoaiKBNHD.Selected.MA_LOAI_KB),
                                Collect(
                                    tmpError,
                                    {ID: 6}
                                );
                            );
                            
                        //1.3. kiểm tra nhóm KB
                        // Nếu kênh bán áp dụng cho tất cả và có loại trừ
                        // Tìm giá trị loại trừ  cá nhân/tổ chức, nếu có dữ liệu thì false
                        If(
                                IsBlank(
                                    LookUp(
                                        DL_DIEUKIEN_APDUNG_LOAI_CT,
                                        MA_DIEU_KIEN = dk.MA_DIEU_KIEN && THANH_PHAN = "KB" && AP_DUNG = "1" && MA_TIEU_CHI = "MA_KB_NHOM"
                                    )
                                ) And !IsBlank(
                                    LookUp(
                                        DL_DIEUKIEN_APDUNG_LOAI_CT,
                                        MA_DIEU_KIEN = dk.MA_DIEU_KIEN && THANH_PHAN = "KB" && AP_DUNG = "2" && MA_TIEU_CHI = "MA_KB_NHOM" && MA_GIA_TRI = nhomKB
                                    )
                                ) And !IsBlank(cbxMaKBNHD.Selected.MA_KENH_BAN),
                                Collect(
                                    tmpError,
                                    {ID: 7}
                                );
                            );
                            
                        // Nếu kênh bán áp dụng 1 phần
                        // Tìm trong danh sách áp dụng theo mã kênh bán, loại kênh bán, cá nhân/tổ chức, nếu không có thì false
                        If(
                                !IsBlank(
                                    LookUp(
                                        DL_DIEUKIEN_APDUNG_LOAI_CT,
                                        MA_DIEU_KIEN = dk.MA_DIEU_KIEN && THANH_PHAN = "KB" && AP_DUNG = "1" && KIEU = "2" && MA_TIEU_CHI = "MA_KB_NHOM"
                                    )
                                ) And IsBlank(
                                    LookUp(
                                        DL_DIEUKIEN_APDUNG_LOAI_CT,
                                        MA_DIEU_KIEN = dk.MA_DIEU_KIEN && THANH_PHAN = "KB" && AP_DUNG = "1" && KIEU = "2" && MA_TIEU_CHI = "MA_KB_NHOM" && MA_GIA_TRI = nhomKB
                                    )
                                ) And !IsBlank(cbxMaKBNHD.Selected.MA_KENH_BAN),
                                Collect(
                                    tmpError,
                                    {ID: 8}
                                );
                            );
                            
                        // Nếu kênh bán áp dụng 1 phần
                        // Tìm trong danh sách áp dụng theo mã kênh bán nếu có dữ liệu
                        // Tìm trong danh sách loại trừ theo mã kênh bán nếu có dữ liệu thì -> false, nếu không có thì  -> pass
                        If(
                                !IsBlank(
                                    LookUp(
                                        DL_DIEUKIEN_APDUNG_LOAI_CT,
                                        MA_DIEU_KIEN = dk.MA_DIEU_KIEN && THANH_PHAN = "KB" && AP_DUNG = "1" && KIEU = "2" && MA_TIEU_CHI = "MA_KB_NHOM" && MA_GIA_TRI = nhomKB
                                    )
                                ) And !IsBlank(
                                    LookUp(
                                        DL_DIEUKIEN_APDUNG_LOAI_CT,
                                        MA_DIEU_KIEN = dk.MA_DIEU_KIEN && THANH_PHAN = "KB" && AP_DUNG = "2" && MA_TIEU_CHI = "MA_KB_NHOM" && MA_GIA_TRI = nhomKB
                                    )
                                ) And !IsBlank(cbxMaKBNHD.Selected.MA_KENH_BAN),
                                Collect(
                                    tmpError,
                                    {ID: 9}
                                );
                            );
                            
                        //2. Kiểm tra khách hàng     
                        //2.1. kiểm tra nhóm Kh
                        // Nếu kênh bán áp dụng cho tất cả và có loại trừ
                        // Tìm giá trị loại trừ  cá nhân/tổ chức, nếu có dữ liệu thì false
                        If(
                                IsBlank(
                                    LookUp(
                                        DL_DIEUKIEN_APDUNG_LOAI_CT,
                                        MA_DIEU_KIEN = dk.MA_DIEU_KIEN && THANH_PHAN = "KH" && AP_DUNG = "1" && MA_TIEU_CHI = "MA_KH_LOAI"
                                    )
                                ) And !IsBlank(
                                    LookUp(
                                        DL_DIEUKIEN_APDUNG_LOAI_CT,
                                        MA_DIEU_KIEN = dk.MA_DIEU_KIEN && THANH_PHAN = "KH" && AP_DUNG = "2" && MA_TIEU_CHI = "MA_KH_LOAI" && MA_GIA_TRI = cbxLoaiKHNHD.Selected.value
                                    )
                                ) And !IsBlank(cbxLoaiKHNHD.Selected.value),
                                Collect(
                                    tmpError,
                                    {ID: 10}
                                );
                            );
                            
                        // Nếu kênh bán áp dụng 1 phần
                        // Tìm trong danh sách áp dụng theo mã kênh bán, loại kênh bán, cá nhân/tổ chức, nếu không có thì false
                        If(
                                !IsBlank(
                                    LookUp(
                                        DL_DIEUKIEN_APDUNG_LOAI_CT,
                                        MA_DIEU_KIEN = dk.MA_DIEU_KIEN && THANH_PHAN = "KH" && AP_DUNG = "1" && KIEU = "2" && MA_TIEU_CHI = "MA_KH_LOAI"
                                    )
                                ) And IsBlank(
                                    LookUp(
                                        DL_DIEUKIEN_APDUNG_LOAI_CT,
                                        MA_DIEU_KIEN = dk.MA_DIEU_KIEN && THANH_PHAN = "KH" && AP_DUNG = "1" && KIEU = "2" && MA_TIEU_CHI = "MA_KH_LOAI" && MA_GIA_TRI = cbxLoaiKHNHD.Selected.value
                                    )
                                ) And !IsBlank(cbxLoaiKHNHD.Selected.value),
                                Collect(
                                    tmpError,
                                    {ID: 11}
                                );
                            );
                            
                        // Nếu kênh bán áp dụng 1 phần
                        // Tìm trong danh sách áp dụng theo mã kênh bán nếu có dữ liệu
                        // Tìm trong danh sách loại trừ theo mã kênh bán nếu có dữ liệu thì -> false, nếu không có thì  -> pass
                        If(
                                !IsBlank(
                                    LookUp(
                                        DL_DIEUKIEN_APDUNG_LOAI_CT,
                                        MA_DIEU_KIEN = dk.MA_DIEU_KIEN && THANH_PHAN = "KH" && AP_DUNG = "1" && KIEU = "2" && MA_TIEU_CHI = "MA_KH_LOAI" && MA_GIA_TRI = cbxLoaiKHNHD.Selected.value
                                    )
                                ) And !IsBlank(
                                    LookUp(
                                        DL_DIEUKIEN_APDUNG_LOAI_CT,
                                        MA_DIEU_KIEN = dk.MA_DIEU_KIEN && THANH_PHAN = "KH" && AP_DUNG = "2" && MA_TIEU_CHI = "MA_KH_LOAI" && MA_GIA_TRI = cbxLoaiKHNHD.Selected.value
                                    )
                                ) And !IsBlank(cbxLoaiKHNHD.Selected.value),
                                Collect(
                                    tmpError,
                                    {ID: 12}
                                );
                            );
                            
                        //3. Kiểm tra phạm vi
                        //3.1 Kiểm tra tỉnh/thành phố
                        // Nếu áp dụng cho tất cả và có loại trừ
                        // Tìm giá trị loại trừ tỉnh hoặc mã cấp cha của tỉnh nếu có dữ liệu thì false
                        If(
                                IsBlank(
                                    LookUp(
                                        DL_DIEUKIEN_APDUNG_LOAI_CT,
                                        MA_DIEU_KIEN = dk.MA_DIEU_KIEN && THANH_PHAN = "PV" && AP_DUNG = "1" && (MA_TIEU_CHI = "MA_TINH_TP" Or MA_TIEU_CHI = "MA_VUNG_MIEN")
                                    )
                                ) And !IsBlank(
                                    LookUp(
                                        DL_DIEUKIEN_APDUNG_LOAI_CT,
                                        MA_DIEU_KIEN = dk.MA_DIEU_KIEN && THANH_PHAN = "PV" && AP_DUNG = "2" && (MA_TIEU_CHI = "MA_TINH_TP" Or MA_TIEU_CHI = "MA_VUNG_MIEN")
                                    )
                                ) And !IsBlank(
                                    LookUp(
                                        DL_DIEUKIEN_APDUNG_LOAI_CT,
                                        MA_DIEU_KIEN = dk.MA_DIEU_KIEN && THANH_PHAN = "PV" && AP_DUNG = "2" && (MA_GIA_TRI = cbxTinhNHD.Selected.MA_PHAMVI Or MA_GIA_TRI = cbxTinhNHD.Selected.MA_CHA)
                                    )
                                ) And !IsBlank(cbxTinhNHD.Selected.MA_PHAMVI),
                                Collect(
                                    tmpError,
                                    {ID: 13}
                                );
                            );
                            
                        // Nếu phạm vi áp dụng 1 phần
                        // Tìm trong danh sách áp dụng theo tỉnh/thành phố hoặc là mã cha của tỉnh/thành phố nếu không có thì false
                        If(
                                !IsBlank(
                                    LookUp(
                                        DL_DIEUKIEN_APDUNG_LOAI_CT,
                                        MA_DIEU_KIEN = dk.MA_DIEU_KIEN && THANH_PHAN = "PV" && AP_DUNG = "1" && KIEU = "2" && (MA_TIEU_CHI = "MA_TINH_TP" Or MA_TIEU_CHI = "MA_VUNG_MIEN")
                                    )
                                ) And IsBlank(
                                    LookUp(
                                        DL_DIEUKIEN_APDUNG_LOAI_CT,
                                        MA_DIEU_KIEN = dk.MA_DIEU_KIEN && THANH_PHAN = "PV" && AP_DUNG = "1" && KIEU = "2" && (MA_GIA_TRI = cbxTinhNHD.Selected.MA_PHAMVI Or MA_GIA_TRI = cbxTinhNHD.Selected.MA_CHA)
                                    )
                                ) And !IsBlank(cbxTinhNHD.Selected.MA_PHAMVI),
                                Collect(
                                    tmpError,
                                    {ID: 14}
                                );
                            );
                            
                        // Nếu phạm vi áp dụng 1 phần
                        // Tìm trong danh sách áp dụng theo tỉnh/thành phố hoặc mã cha của tỉnh/thành phố nếu có dữ liệu
                        // Tìm trong danh sách loại trừ theo tỉnh/thành phố và mã cha của tỉnh/thành phố nếu có dữ liệu thì -> false, nếu không có thì  -> pass
                        If(
                                !IsBlank(
                                    LookUp(
                                        DL_DIEUKIEN_APDUNG_LOAI_CT,
                                        MA_DIEU_KIEN = dk.MA_DIEU_KIEN && THANH_PHAN = "PV" && AP_DUNG = "1" && KIEU = "2" && (MA_TIEU_CHI = "MA_TINH_TP" Or MA_TIEU_CHI = "MA_VUNG_MIEN")
                                    )
                                ) And !IsBlank(
                                    LookUp(
                                        DL_DIEUKIEN_APDUNG_LOAI_CT,
                                        MA_DIEU_KIEN = dk.MA_DIEU_KIEN && THANH_PHAN = "PV" && AP_DUNG = "1" && KIEU = "2" && (MA_GIA_TRI = cbxTinhNHD.Selected.MA_PHAMVI Or MA_GIA_TRI = cbxTinhNHD.Selected.MA_CHA)
                                    )
                                ) And !IsBlank(
                                    LookUp(
                                        DL_DIEUKIEN_APDUNG_LOAI_CT,
                                        MA_DIEU_KIEN = dk.MA_DIEU_KIEN && THANH_PHAN = "PV" && AP_DUNG = "2" && (MA_GIA_TRI = cbxTinhNHD.Selected.MA_PHAMVI Or MA_GIA_TRI = cbxTinhNHD.Selected.MA_CHA)
                                    )
                                ) And !IsBlank(cbxTinhNHD.Selected.MA_PHAMVI),
                                Collect(
                                    tmpError,
                                    {ID: 15}
                                );
                            );
                            
                        //3.2 Kiểm tra đơn vị quản lý hợp đồng
                        // Nếu áp dụng cho tất cả và có loại trừ
                        // Tìm giá trị loại trừ đơn vị quản lý hợp đồng nếu có dữ liệu thì false
                        If(
                                IsBlank(
                                    LookUp(
                                        DL_DIEUKIEN_APDUNG_LOAI_CT,
                                        MA_DIEU_KIEN = dk.MA_DIEU_KIEN && THANH_PHAN = "PV" && AP_DUNG = "1" && MA_TIEU_CHI = "MA_DON_VI"
                                    )
                                ) And !IsBlank(
                                    LookUp(
                                        DL_DIEUKIEN_APDUNG_LOAI_CT,
                                        MA_DIEU_KIEN = dk.MA_DIEU_KIEN && THANH_PHAN = "PV" && AP_DUNG = "2" && MA_TIEU_CHI = "MA_DON_VI" && MA_GIA_TRI = cbxDVQLNHD.Selected.MA_PHAMVI
                                    )
                                ) And !IsBlank(cbxDVQLNHD.Selected.MA_PHAMVI),
                                Collect(
                                    tmpError,
                                    {ID: 16}
                                );
                            );
                            
                        // Nếu phạm vi áp dụng 1 phần
                        // Tìm trong danh sách áp dụng đơn vị quản lý hợp đồng không có thì false
                        If(
                                !IsBlank(
                                    LookUp(
                                        DL_DIEUKIEN_APDUNG_LOAI_CT,
                                        MA_DIEU_KIEN = dk.MA_DIEU_KIEN && THANH_PHAN = "PV" && AP_DUNG = "1" && KIEU = "2" && MA_TIEU_CHI = "MA_DON_VI"
                                    )
                                ) And IsBlank(
                                    LookUp(
                                        DL_DIEUKIEN_APDUNG_LOAI_CT,
                                        MA_DIEU_KIEN = dk.MA_DIEU_KIEN && THANH_PHAN = "PV" && AP_DUNG = "1" && KIEU = "2" && MA_GIA_TRI = cbxDVQLNHD.Selected.MA_PHAMVI
                                    )
                                ) And !IsBlank(cbxDVQLNHD.Selected.MA_PHAMVI),
                                Collect(
                                    tmpError,
                                    {ID: 17}
                                );
                            );
                            
                        // Nếu phạm vi áp dụng 1 phần
                        // Tìm trong danh sách áp dụng theo đơn vị quản lý hợp đồng nếu có dữ liệu
                        // Tìm trong danh sách loại trừ theo đơn vị quản lý hợp đồng nếu có dữ liệu thì -> false, nếu không có thì  -> pass
                        If(
                                !IsBlank(
                                    LookUp(
                                        DL_DIEUKIEN_APDUNG_LOAI_CT,
                                        MA_DIEU_KIEN = dk.MA_DIEU_KIEN && THANH_PHAN = "PV" && AP_DUNG = "1" && KIEU = "2" && MA_TIEU_CHI = "MA_DON_VI" && MA_GIA_TRI = cbxDVQLNHD.Selected.MA_PHAMVI
                                    )
                                ) And !IsBlank(
                                    LookUp(
                                        DL_DIEUKIEN_APDUNG_LOAI_CT,
                                        MA_DIEU_KIEN = dk.MA_DIEU_KIEN && THANH_PHAN = "PV" && AP_DUNG = "2" && MA_TIEU_CHI = "MA_DON_VI" && MA_GIA_TRI = cbxDVQLNHD.Selected.MA_PHAMVI
                                    )
                                ) And !IsBlank(cbxDVQLNHD.Selected.MA_PHAMVI),
                                Collect(
                                    tmpError,
                                    {ID: 18}
                                );
                            );
                            
                        //4. Kiểm tra sản phẩm
                        ForAll(
                                Gallery3_2.AllItems As sp,
                                    // 4.1.1 Kiểm tra thông tin sản phẩm
                        // Nếu sản phẩm áp dụng cho tất cả và có loại trừ
                        // Tìm giá trị loại trừ mã sản phẩm nếu có dữ liệu thì false
                                If(
                                    IsBlank(
                                        LookUp(
                                            DL_DIEUKIEN_APDUNG_LOAI_CT,
                                            MA_DIEU_KIEN = dk.MA_DIEU_KIEN && THANH_PHAN = "SP" && AP_DUNG = "1" && MA_TIEU_CHI = "MA_SP"
                                        )
                                    ) And !IsBlank(
                                        LookUp(
                                            DL_DIEUKIEN_APDUNG_LOAI_CT,
                                            MA_DIEU_KIEN = dk.MA_DIEU_KIEN && THANH_PHAN = "SP" && AP_DUNG = "2" && MA_TIEU_CHI = "MA_SP" && MA_GIA_TRI = sp.cbxMaSPNHD.Selected.MA_SAN_PHAM
                                        )
                                    ) And !IsBlank(sp.cbxMaSPNHD.Selected.MA_SAN_PHAM),
                                    Collect(
                                        tmpError,
                                        {ID: 19}
                                    );
                                );
                                    // Nếu sản phẩm áp dụng 1 phần
                        // Tìm trong danh sách áp dụng theo mã sản phẩm nếu không có thì false
                        If(
                                    !IsBlank(
                                        LookUp(
                                            DL_DIEUKIEN_APDUNG_LOAI_CT,
                                            MA_DIEU_KIEN = dk.MA_DIEU_KIEN && THANH_PHAN = "SP" && AP_DUNG = "1" && MA_TIEU_CHI = "MA_SP"
                                        )
                                    ) And IsBlank(
                                        LookUp(
                                            DL_DIEUKIEN_APDUNG_LOAI_CT,
                                            MA_DIEU_KIEN = dk.MA_DIEU_KIEN && THANH_PHAN = "SP" && AP_DUNG = "1" && MA_TIEU_CHI = "MA_SP" && KIEU = "2" && MA_GIA_TRI = sp.cbxMaSPNHD.Selected.MA_SAN_PHAM
                                        )
                                    ) And !IsBlank(sp.cbxMaSPNHD.Selected.MA_SAN_PHAM),
                                    Collect(
                                        tmpError,
                                        {ID: 20}
                                    );
                                );
                                
                        // Nếu sản phẩm áp dụng 1 phần
                        // Tìm trong danh sách áp dụng theo mã sản phẩm nếu có dữ liệu
                        // Tìm trong danh sách loại trừ theo mã sản phẩm nếu có dữ liệu thì -> false, nếu không có thì  -> pass
                        If(
                                    !IsBlank(
                                        LookUp(
                                            DL_DIEUKIEN_APDUNG_LOAI_CT,
                                            MA_DIEU_KIEN = dk.MA_DIEU_KIEN && THANH_PHAN = "SP" && AP_DUNG = "1" && MA_TIEU_CHI = "MA_SP" && MA_GIA_TRI = sp.cbxMaSPNHD.Selected.MA_SAN_PHAM
                                        )
                                    ) And !IsBlank(
                                        LookUp(
                                            DL_DIEUKIEN_APDUNG_LOAI_CT,
                                            MA_DIEU_KIEN = dk.MA_DIEU_KIEN && THANH_PHAN = "SP" && AP_DUNG = "2" && MA_TIEU_CHI = "MA_SP" && MA_GIA_TRI = sp.cbxMaSPNHD.Selected.MA_SAN_PHAM
                                        )
                                    ) And !IsBlank(sp.cbxMaSPNHD.Selected.MA_SAN_PHAM),
                                    Collect(
                                        tmpError,
                                        {ID: 21}
                                    );
                                );
                                // 4.1.2 Kiểm tra thông tin chương trình
                        // Nếu chương trình áp dụng cho tất cả và có loại trừ
                        // Tìm giá trị loại trừ chương trình nếu có dữ liệu thì false
                        If(
                                    IsBlank(
                                        LookUp(
                                            DL_DIEUKIEN_APDUNG_LOAI_CT,
                                            MA_DIEU_KIEN = dk.MA_DIEU_KIEN && THANH_PHAN = "SP" && AP_DUNG = "1" && MA_TIEU_CHI = "MA_CT"
                                        )
                                    ) And !IsBlank(
                                        LookUp(
                                            DL_DIEUKIEN_APDUNG_LOAI_CT,
                                            MA_DIEU_KIEN = dk.MA_DIEU_KIEN && THANH_PHAN = "SP" && AP_DUNG = "2" && MA_TIEU_CHI = "MA_CT" && MA_GIA_TRI = sp.cbxMaCTNHD.Selected.MA_CHUONG_TRINH
                                        )
                                    ) And !IsBlank(sp.cbxMaCTNHD.Selected.MA_CHUONG_TRINH),
                                    Collect(
                                        tmpError,
                                        {ID: 22}
                                    );
                                );
                                    // Nếu sản phẩm áp dụng 1 phần
                        // Tìm trong danh sách áp dụng theo mã sản phẩm nếu không có thì false
                        If(
                                    !IsBlank(
                                        LookUp(
                                            DL_DIEUKIEN_APDUNG_LOAI_CT,
                                            MA_DIEU_KIEN = dk.MA_DIEU_KIEN && THANH_PHAN = "SP" && AP_DUNG = "1" && MA_TIEU_CHI = "MA_CT"
                                        )
                                    ) And IsBlank(
                                        LookUp(
                                            DL_DIEUKIEN_APDUNG_LOAI_CT,
                                            MA_DIEU_KIEN = dk.MA_DIEU_KIEN && THANH_PHAN = "SP" && AP_DUNG = "1" && MA_TIEU_CHI = "MA_CT" && KIEU = "2" && MA_GIA_TRI = sp.cbxMaCTNHD.Selected.MA_CHUONG_TRINH
                                        )
                                    ) And !IsBlank(sp.cbxMaCTNHD.Selected.MA_CHUONG_TRINH),
                                    Collect(
                                        tmpError,
                                        {ID: 23}
                                    );
                                );
                                    // Nếu chương trình áp dụng 1 phần
                        // Tìm trong danh sách áp dụng theo mã chương trình nếu có dữ liệu
                        // Tìm trong danh sách loại trừ theo mã chương trình nếu có dữ liệu thì -> false, nếu không có thì  -> pass
                        If(
                                    !IsBlank(
                                        LookUp(
                                            DL_DIEUKIEN_APDUNG_LOAI_CT,
                                            MA_DIEU_KIEN = dk.MA_DIEU_KIEN && THANH_PHAN = "SP" && AP_DUNG = "1" && MA_TIEU_CHI = "MA_CT" && MA_GIA_TRI = sp.cbxMaCTNHD.Selected.MA_CHUONG_TRINH
                                        )
                                    ) And !IsBlank(
                                        LookUp(
                                            DL_DIEUKIEN_APDUNG_LOAI_CT,
                                            MA_DIEU_KIEN = dk.MA_DIEU_KIEN && THANH_PHAN = "SP" && AP_DUNG = "2" && MA_TIEU_CHI = "MA_CT" && MA_GIA_TRI = sp.cbxMaCTNHD.Selected.MA_CHUONG_TRINH
                                        )
                                    ) And !IsBlank(sp.cbxMaCTNHD.Selected.MA_CHUONG_TRINH),
                                    Collect(
                                        tmpError,
                                        {ID: 24}
                                    );
                                );
                         // 4.1.3 Kiểm tra thông tin LHNV
                        // Nếu LHNV áp dụng cho tất cả và có loại trừ
                        // Tìm giá trị loại trừ LHNV nếu có dữ liệu thì false
                        If(
                                    IsBlank(
                                        LookUp(
                                            DL_DIEUKIEN_APDUNG_LOAI_CT,
                                            MA_DIEU_KIEN = dk.MA_DIEU_KIEN && THANH_PHAN = "SP" && AP_DUNG = "1" && MA_TIEU_CHI = "LHNV"
                                        )
                                    ) And !IsBlank(
                                        LookUp(
                                            DL_DIEUKIEN_APDUNG_LOAI_CT,
                                            MA_DIEU_KIEN = dk.MA_DIEU_KIEN && THANH_PHAN = "SP" && AP_DUNG = "2" && MA_TIEU_CHI = "LHNV" && TEN_GIA_TRI = tiPhiNGNHD_1.Text
                                        )
                                    ) And !IsBlank(tiPhiNGNHD_1.Text),
                                    Collect(
                                        tmpError,
                                        {ID: 25}
                                    );
                                );
                                    // Nếu sản phẩm áp dụng 1 phần
                        // Tìm trong danh sách áp dụng theo mã sản phẩm nếu không có thì false
                        If(
                                    !IsBlank(
                                        LookUp(
                                            DL_DIEUKIEN_APDUNG_LOAI_CT,
                                            MA_DIEU_KIEN = dk.MA_DIEU_KIEN && THANH_PHAN = "SP" && AP_DUNG = "1" && MA_TIEU_CHI = "LHNV"
                                        )
                                    ) And IsBlank(
                                        LookUp(
                                            DL_DIEUKIEN_APDUNG_LOAI_CT,
                                            MA_DIEU_KIEN = dk.MA_DIEU_KIEN && THANH_PHAN = "SP" && AP_DUNG = "1" && MA_TIEU_CHI = "LHNV" && KIEU = "2" && TEN_GIA_TRI = tiPhiNGNHD_1.Text
                                        )
                                    ) And !IsBlank(tiPhiNGNHD_1.Text),
                                    Collect(
                                        tmpError,
                                        {ID: 26}
                                    );
                                );
                                    // Nếu chương trình áp dụng 1 phần
                        // Tìm trong danh sách áp dụng theo mã chương trình nếu có dữ liệu
                        // Tìm trong danh sách loại trừ theo mã chương trình nếu có dữ liệu thì -> false, nếu không có thì  -> pass
                        If(
                                    !IsBlank(
                                        LookUp(
                                            DL_DIEUKIEN_APDUNG_LOAI_CT,
                                            MA_DIEU_KIEN = dk.MA_DIEU_KIEN && THANH_PHAN = "SP" && AP_DUNG = "1" && MA_TIEU_CHI = "LHNV" && TEN_GIA_TRI = tiPhiNGNHD_1.Text
                                        )
                                    ) And !IsBlank(
                                        LookUp(
                                            DL_DIEUKIEN_APDUNG_LOAI_CT,
                                            MA_DIEU_KIEN = dk.MA_DIEU_KIEN && THANH_PHAN = "SP" && AP_DUNG = "2" && MA_TIEU_CHI = "LHNV" && TEN_GIA_TRI = tiPhiNGNHD_1.Text
                                        )
                                    ) And !IsBlank(tiPhiNGNHD_1.Text),
                                    Collect(
                                        tmpError,
                                        {ID: 27}
                                    );
                                );
                            );
                            
                        //4.1.4 Kiểm tra combo sản phẩm
                        ForAll(
                                Gallery3_2.AllItems As sp,
                                Collect(
                                    dsSpKetHop,
                                    {MA_SAN_PHAM: sp.cbxMaSPNHD.Selected.MA_SAN_PHAM}
                                )
                            );
                            ForAll(
                                Gallery3_1.AllItems As sp,
                                Collect(
                                    dsSpKetHop,
                                    {MA_SAN_PHAM: sp.tiMaSPLKNHD_1.Text}
                                )
                            );
                            Collect(
                                GroupedSp,
                                GroupBy(
                                    dsSpKetHop,
                                    "MA_SAN_PHAM",
                                    "Grouped"
                                )
                            );
                            If(
                                CountRows(GroupedSp) > 1,
                                Collect(
                                    dsCombosp,
                                    Filter(
                                        DL_DIEUKIEN_APDUNG_LOAI_CT,
                                        MA_GIA_TRI,
                                        MA_DIEU_KIEN = dk.MA_DIEU_KIEN && THANH_PHAN = "SP" && MA_TIEU_CHI = "MA_COMBO_SP" && AP_DUNG = "1"
                                    )
                                );
                                Collect(
                                    dsCombospLt,
                                    Filter(
                                        DL_DIEUKIEN_APDUNG_LOAI_CT,
                                        MA_GIA_TRI,
                                        MA_DIEU_KIEN = dk.MA_DIEU_KIEN && THANH_PHAN = "SP" && MA_TIEU_CHI = "MA_COMBO_SP" && AP_DUNG = "2"
                                    )
                                );
                                ForAll(
                                    GroupedSp As sp,
                                    RemoveIf(
                                        dsCombosp,
                                        cr282_ma_gia_tri = sp.MA_SAN_PHAM
                                    );
                                );
                                ForAll(
                                    GroupedSp As sp,
                                    RemoveIf(
                                        dsCombospLt,
                                        cr282_ma_gia_tri = sp.MA_SAN_PHAM
                                    );
                                );
                                
                        // Nếu COMBO áp dụng cho tất cả và có loại trừ
                        // Tìm giá trị loại trừ theo combo sản phẩm nếu có dữ liệu thì false
                        If(
                                    IsBlank(
                                        LookUp(
                                            DL_DIEUKIEN_APDUNG_LOAI_CT,
                                            MA_DIEU_KIEN = dk.MA_DIEU_KIEN && THANH_PHAN = "SP" && AP_DUNG = "1" && MA_TIEU_CHI = "MA_COMBO_SP"
                                        )
                                    ) And !IsBlank(
                                        LookUp(
                                            DL_DIEUKIEN_APDUNG_LOAI_CT,
                                            MA_DIEU_KIEN = dk.MA_DIEU_KIEN && THANH_PHAN = "SP" && AP_DUNG = "2" && MA_TIEU_CHI = "MA_COMBO_SP"
                                        )
                                    ) And CountRows(dsCombospLt) = 0 And CountRows(GroupedSp) = CountRows(
                                        Filter(
                                            DL_DIEUKIEN_APDUNG_LOAI_CT,
                                            MA_DIEU_KIEN = dk.MA_DIEU_KIEN && THANH_PHAN = "SP" && AP_DUNG = "2" && MA_TIEU_CHI = "MA_COMBO_SP"
                                        )
                                    ),
                                    Collect(
                                        tmpError,
                                        {ID: 28}
                                    );
                                );
                                
                        // Nếu combo sản phẩm áp dụng 1 phần
                        // Tìm trong danh sách áp dụng theo COMBO SẢN PHẨM nếu không khớp có thì false
                        If(
                                    !IsBlank(
                                        LookUp(
                                            DL_DIEUKIEN_APDUNG_LOAI_CT,
                                            MA_DIEU_KIEN = dk.MA_DIEU_KIEN && THANH_PHAN = "SP" && AP_DUNG = "1" && MA_TIEU_CHI = "MA_COMBO_SP"
                                        )
                                    ) And (CountRows(dsCombosp) <> 0),
                                    Collect(
                                        tmpError,
                                        {ID: 29}
                                    );
                                );
                            );
                            
                        // nếu điều kiện nào không lỗi thì đưa vào danh sách
                        If(
                                CountRows(tmpError) <= 0,
                                Collect(
                                    tmpPass,
                                    {ma_dieu_kien: dk.MA_DIEU_KIEN}
                                );
                            )
                        );
                        If(
                            CountRows(tmpPass) <= 0,
                            UpdateContext({errorMsg: "Không có điều kiện áp dụng thoả mãn"})
                        );
                        If(
                            !IsBlank(errorMsg),
                            Notify(
                                errorMsg,
                                NotificationType.Error,
                                800
                            )
                        );
                        // end điều kiện áp dụng
                        // lấy chính sách áp dụng
                        UpdateContext({errorMsg: ""});
                        // lọc điều kiện
                        // lấy danh sách các điều kiện áp dụng còn hoạt động và ngày hợp đồng nằm trong khoảng hiệu lực
                        ClearCollect (
                            tmpChinhsach,
                            Filter(
                                DL_CHINHSACH_CHUNG,
                                HOAT_DONG = "true" && DateValue(HIEU_LUC_TU) <= DateValue(dpNgayHDNHD.SelectedDate)
                            )
                        );
                        ClearCollect(
                            tmpErrorCs,
                            {}
                        );
                        RemoveIf(
                            tmpErrorCs,
                            1 = 1
                        );
                        ClearCollect(
                            tmpPassCs,
                            {}
                        );
                        ClearCollect(
                            dsCombosp,
                            {}
                        );
                        ClearCollect(
                            dsCombospLt,
                            {}
                        );
                        ClearCollect(
                            GroupedSp,
                            {}
                        );
                        ClearCollect(
                            dsSpKetHop,
                            {}
                        );
                        RemoveIf(
                            tmpPassCs,
                            1 = 1
                        );
                        // nếu không có điều kiện thỏa mãn thì báo lỗi
                        If(
                            CountRows(tmpChinhsach) <= 0,
                            UpdateContext({errorMsg: "Không có chính sách thỏa mãn"})
                        );
                        If(
                            !IsBlank(errorMsg),
                            Notify(
                                errorMsg,
                                NotificationType.Error,
                                800
                            )
                        );
                        ForAll(
                            tmpChinhsach As dk,
                        //1. kiểm tra kênh bán   
                        //1.1. kiểm tra mã kênh bán
                        // Nếu kênh bán áp dụng cho tất cả và có loại trừ
                        // Tìm giá trị loại trừ mã kênh bán, loại kênh bán, cá nhân/tổ chức, nếu có dữ liệu thì false
                            RemoveIf(
                                tmpErrorCs,
                                1 = 1
                            );
                            RemoveIf(
                                dsCombosp,
                                1 = 1
                            );
                            RemoveIf(
                                dsCombospLt,
                                1 = 1
                            );
                            RemoveIf(
                                dsSpKetHop,
                                1 = 1
                            );
                            RemoveIf(
                                GroupedSp,
                                1 = 1
                            );
                            If(
                                IsBlank(
                                    LookUp(
                                        DL_CHINHSACH_DOITUONG_CT,
                                        MA_CHINH_SACH = dk.MA_CHINH_SACH && THANH_PHAN = "KB" && AP_DUNG = "1" && MA_TIEU_CHI = "MA_KB_DM"
                                    )
                                ) And !IsBlank(
                                    LookUp(
                                        DL_CHINHSACH_DOITUONG_CT,
                                        MA_CHINH_SACH = dk.MA_CHINH_SACH && THANH_PHAN = "KB" && AP_DUNG = "2" && MA_TIEU_CHI = "MA_KB_DM" && MA_GIA_TRI = cbxMaKBNHD.Selected.MA_KENH_BAN
                                    )
                                ) And !IsBlank(cbxMaKBNHD.Selected.MA_KENH_BAN),
                                Collect(
                                    tmpErrorCs,
                                    {ID: 1}
                                );
                            );
                            
                        // Nếu kênh bán áp dụng 1 phần
                        // Tìm trong danh sách áp dụng theo mã kênh bán, loại kênh bán, cá nhân/tổ chức, nếu không có thì false
                        If(
                                !IsBlank(
                                    LookUp(
                                        DL_CHINHSACH_DOITUONG_CT,
                                        MA_CHINH_SACH = dk.MA_CHINH_SACH && THANH_PHAN = "KB" && AP_DUNG = "1" && KIEU = "2" && MA_TIEU_CHI = "MA_KB_DM"
                                    )
                                ) And IsBlank(
                                    LookUp(
                                        DL_CHINHSACH_DOITUONG_CT,
                                        MA_CHINH_SACH = dk.MA_CHINH_SACH && THANH_PHAN = "KB" && AP_DUNG = "1" && KIEU = "2" && MA_TIEU_CHI = "MA_KB_DM" && MA_GIA_TRI = cbxMaKBNHD.Selected.MA_KENH_BAN
                                    )
                                ) And !IsBlank(cbxMaKBNHD.Selected.MA_KENH_BAN),
                                Collect(
                                    tmpErrorCs,
                                    {ID: 2}
                                );
                            );
                            
                        // Nếu kênh bán áp dụng 1 phần
                        // Tìm trong danh sách áp dụng theo mã kênh bán nếu có dữ liệu
                        // Tìm trong danh sách loại trừ theo mã kênh bán nếu có dữ liệu thì -> false, nếu không có thì  -> pass
                        If(
                                !IsBlank(
                                    LookUp(
                                        DL_CHINHSACH_DOITUONG_CT,
                                        MA_CHINH_SACH = dk.MA_CHINH_SACH && THANH_PHAN = "KB" && AP_DUNG = "1" && KIEU = "2" && MA_TIEU_CHI = "MA_KB_DM" && MA_GIA_TRI = cbxMaKBNHD.Selected.MA_KENH_BAN
                                    )
                                ) And !IsBlank(
                                    LookUp(
                                        DL_CHINHSACH_DOITUONG_CT,
                                        MA_CHINH_SACH = dk.MA_CHINH_SACH && THANH_PHAN = "KB" && AP_DUNG = "2" && MA_TIEU_CHI = "MA_KB_DM" && MA_GIA_TRI = cbxMaKBNHD.Selected.MA_KENH_BAN
                                    )
                                ) And !IsBlank(cbxMaKBNHD.Selected.MA_KENH_BAN),
                                Collect(
                                    tmpErrorCs,
                                    {ID: 3}
                                );
                            );
                            
                        //1.2. kiểm tra loại kênh bán
                        // Nếu kênh bán áp dụng cho tất cả và có loại trừ
                        // Tìm giá trị loại trừ loại kênh bán nếu có dữ liệu thì false
                        If(
                                IsBlank(
                                    LookUp(
                                        DL_CHINHSACH_DOITUONG_CT,
                                        MA_CHINH_SACH = dk.MA_CHINH_SACH && THANH_PHAN = "KB" && AP_DUNG = "1" && MA_TIEU_CHI = "MA_KB_LOAI"
                                    )
                                ) And !IsBlank(
                                    LookUp(
                                        DL_CHINHSACH_DOITUONG_CT,
                                        MA_CHINH_SACH = dk.MA_CHINH_SACH && THANH_PHAN = "KB" && AP_DUNG = "2" && MA_TIEU_CHI = "MA_KB_LOAI" && MA_GIA_TRI = cbxLoaiKBNHD.Selected.MA_LOAI_KB
                                    )
                                ) And !IsBlank(cbxLoaiKBNHD.Selected.MA_LOAI_KB),
                                Collect(
                                    tmpErrorCs,
                                    {ID: 4}
                                );
                            );
                            
                        // Nếu kênh bán áp dụng 1 phần
                        // Tìm trong danh sách áp dụng theo mã kênh bán, loại kênh bán, cá nhân/tổ chức, nếu không có thì false
                        If(
                                !IsBlank(
                                    LookUp(
                                        DL_CHINHSACH_DOITUONG_CT,
                                        MA_CHINH_SACH = dk.MA_CHINH_SACH && THANH_PHAN = "KB" && AP_DUNG = "1" && KIEU = "2" && MA_TIEU_CHI = "MA_KB_LOAI"
                                    )
                                ) And IsBlank(
                                    LookUp(
                                        DL_CHINHSACH_DOITUONG_CT,
                                        MA_CHINH_SACH = dk.MA_CHINH_SACH && THANH_PHAN = "KB" && AP_DUNG = "1" && KIEU = "2" && MA_TIEU_CHI = "MA_KB_LOAI" && MA_GIA_TRI = cbxLoaiKBNHD.Selected.MA_LOAI_KB
                                    )
                                ) And !IsBlank(cbxLoaiKBNHD.Selected.MA_LOAI_KB),
                                Collect(
                                    tmpErrorCs,
                                    {ID: 5}
                                );
                            );
                            
                        // Nếu kênh bán áp dụng 1 phần
                        // Tìm trong danh sách áp dụng theo mã kênh bán, loại kênh bán, cá nhân/tổ chức, nếu có dữ liệu
                        // Tìm trong danh sách loại trừ (theo mã kênh bán, loại kênh bán, cá nhân/tổ chức) nếu có dữ liệu thì -> false, nếu không có thì  -> pass
                        If(
                                !IsBlank(
                                    LookUp(
                                        DL_CHINHSACH_DOITUONG_CT,
                                        MA_CHINH_SACH = dk.MA_CHINH_SACH && THANH_PHAN = "KB" && AP_DUNG = "1" && KIEU = "2" && MA_TIEU_CHI = "MA_KB_LOAI" && MA_GIA_TRI = cbxMaKBNHD.Selected.MA_KENH_BAN
                                    )
                                ) And !IsBlank(
                                    LookUp(
                                        DL_CHINHSACH_DOITUONG_CT,
                                        MA_CHINH_SACH = dk.MA_CHINH_SACH && THANH_PHAN = "KB" && AP_DUNG = "2" && (MA_GIA_TRI = cbxLoaiKBNHD.Selected.MA_LOAI_KB Or MA_GIA_TRI = cbxMaKBNHD.Selected.MA_KENH_BAN)
                                    )
                                ) And !IsBlank(cbxLoaiKBNHD.Selected.MA_LOAI_KB),
                                Collect(
                                    tmpErrorCs,
                                    {ID: 6}
                                );
                            );
                            
                        //1.3. kiểm tra nhóm KB
                        // Nếu kênh bán áp dụng cho tất cả và có loại trừ
                        // Tìm giá trị loại trừ  cá nhân/tổ chức, nếu có dữ liệu thì false
                        If(
                                IsBlank(
                                    LookUp(
                                        DL_CHINHSACH_DOITUONG_CT,
                                        MA_CHINH_SACH = dk.MA_CHINH_SACH && THANH_PHAN = "KB" && AP_DUNG = "1" && MA_TIEU_CHI = "MA_KB_NHOM"
                                    )
                                ) And !IsBlank(
                                    LookUp(
                                        DL_CHINHSACH_DOITUONG_CT,
                                        MA_CHINH_SACH = dk.MA_CHINH_SACH && THANH_PHAN = "KB" && AP_DUNG = "2" && MA_TIEU_CHI = "MA_KB_NHOM" && MA_GIA_TRI = nhomKB
                                    )
                                ) And !IsBlank(cbxMaKBNHD.Selected.MA_KENH_BAN),
                                Collect(
                                    tmpErrorCs,
                                    {ID: 7}
                                );
                            );
                            
                        // Nếu kênh bán áp dụng 1 phần
                        // Tìm trong danh sách áp dụng theo mã kênh bán, loại kênh bán, cá nhân/tổ chức, nếu không có thì false
                        If(
                                !IsBlank(
                                    LookUp(
                                        DL_CHINHSACH_DOITUONG_CT,
                                        MA_CHINH_SACH = dk.MA_CHINH_SACH && THANH_PHAN = "KB" && AP_DUNG = "1" && KIEU = "2" && MA_TIEU_CHI = "MA_KB_NHOM"
                                    )
                                ) And IsBlank(
                                    LookUp(
                                        DL_CHINHSACH_DOITUONG_CT,
                                        MA_CHINH_SACH = dk.MA_CHINH_SACH && THANH_PHAN = "KB" && AP_DUNG = "1" && KIEU = "2" && MA_TIEU_CHI = "MA_KB_NHOM" && MA_GIA_TRI = nhomKB
                                    )
                                ) And !IsBlank(cbxMaKBNHD.Selected.MA_KENH_BAN),
                                Collect(
                                    tmpErrorCs,
                                    {ID: 8}
                                );
                            );
                            
                        // Nếu kênh bán áp dụng 1 phần
                        // Tìm trong danh sách áp dụng theo mã kênh bán nếu có dữ liệu
                        // Tìm trong danh sách loại trừ theo mã kênh bán nếu có dữ liệu thì -> false, nếu không có thì  -> pass
                        If(
                                !IsBlank(
                                    LookUp(
                                        DL_CHINHSACH_DOITUONG_CT,
                                        MA_CHINH_SACH = dk.MA_CHINH_SACH && THANH_PHAN = "KB" && AP_DUNG = "1" && KIEU = "2" && MA_TIEU_CHI = "MA_KB_NHOM" && MA_GIA_TRI = nhomKB
                                    )
                                ) And !IsBlank(
                                    LookUp(
                                        DL_CHINHSACH_DOITUONG_CT,
                                        MA_CHINH_SACH = dk.MA_CHINH_SACH && THANH_PHAN = "KB" && AP_DUNG = "2" && MA_TIEU_CHI = "MA_KB_NHOM" && MA_GIA_TRI = nhomKB
                                    )
                                ) And !IsBlank(cbxMaKBNHD.Selected.MA_KENH_BAN),
                                Collect(
                                    tmpErrorCs,
                                    {ID: 9}
                                );
                            );
                            
                        //2. Kiểm tra khách hàng     
                        //2.1. kiểm tra nhóm Kh
                        // Nếu kênh bán áp dụng cho tất cả và có loại trừ
                        // Tìm giá trị loại trừ  cá nhân/tổ chức, nếu có dữ liệu thì false
                        If(
                                IsBlank(
                                    LookUp(
                                        DL_CHINHSACH_DOITUONG_CT,
                                        MA_CHINH_SACH = dk.MA_CHINH_SACH && THANH_PHAN = "KH" && AP_DUNG = "1" && MA_TIEU_CHI = "MA_KH_LOAI"
                                    )
                                ) And !IsBlank(
                                    LookUp(
                                        DL_CHINHSACH_DOITUONG_CT,
                                        MA_CHINH_SACH = dk.MA_CHINH_SACH && THANH_PHAN = "KH" && AP_DUNG = "2" && MA_TIEU_CHI = "MA_KH_LOAI" && MA_GIA_TRI = cbxLoaiKHNHD.Selected.value
                                    )
                                ) And !IsBlank(cbxLoaiKHNHD.Selected.value),
                                Collect(
                                    tmpErrorCs,
                                    {ID: 10}
                                );
                            );
                            
                        // Nếu kênh bán áp dụng 1 phần
                        // Tìm trong danh sách áp dụng theo mã kênh bán, loại kênh bán, cá nhân/tổ chức, nếu không có thì false
                        If(
                                !IsBlank(
                                    LookUp(
                                        DL_CHINHSACH_DOITUONG_CT,
                                        MA_CHINH_SACH = dk.MA_CHINH_SACH && THANH_PHAN = "KH" && AP_DUNG = "1" && KIEU = "2" && MA_TIEU_CHI = "MA_KH_LOAI"
                                    )
                                ) And IsBlank(
                                    LookUp(
                                        DL_CHINHSACH_DOITUONG_CT,
                                        MA_CHINH_SACH = dk.MA_CHINH_SACH && THANH_PHAN = "KH" && AP_DUNG = "1" && KIEU = "2" && MA_TIEU_CHI = "MA_KH_LOAI" && MA_GIA_TRI = cbxLoaiKHNHD.Selected.value
                                    )
                                ) And !IsBlank(cbxLoaiKHNHD.Selected.value),
                                Collect(
                                    tmpErrorCs,
                                    {ID: 11}
                                );
                            );
                            
                        // Nếu kênh bán áp dụng 1 phần
                        // Tìm trong danh sách áp dụng theo mã kênh bán nếu có dữ liệu
                        // Tìm trong danh sách loại trừ theo mã kênh bán nếu có dữ liệu thì -> false, nếu không có thì  -> pass
                        If(
                                !IsBlank(
                                    LookUp(
                                        DL_CHINHSACH_DOITUONG_CT,
                                        MA_CHINH_SACH = dk.MA_CHINH_SACH && THANH_PHAN = "KH" && AP_DUNG = "1" && KIEU = "2" && MA_TIEU_CHI = "MA_KH_LOAI" && MA_GIA_TRI = cbxLoaiKHNHD.Selected.value
                                    )
                                ) And !IsBlank(
                                    LookUp(
                                        DL_CHINHSACH_DOITUONG_CT,
                                        MA_CHINH_SACH = dk.MA_CHINH_SACH && THANH_PHAN = "KH" && AP_DUNG = "2" && MA_TIEU_CHI = "MA_KH_LOAI" && MA_GIA_TRI = cbxLoaiKHNHD.Selected.value
                                    )
                                ) And !IsBlank(cbxLoaiKHNHD.Selected.value),
                                Collect(
                                    tmpErrorCs,
                                    {ID: 12}
                                );
                            );
                            
                        //3. Kiểm tra phạm vi
                        //3.1 Kiểm tra tỉnh/thành phố
                        // Nếu áp dụng cho tất cả và có loại trừ
                        // Tìm giá trị loại trừ tỉnh hoặc mã cấp cha của tỉnh nếu có dữ liệu thì false
                        If(
                                IsBlank(
                                    LookUp(
                                        DL_CHINHSACH_DOITUONG_CT,
                                        MA_CHINH_SACH = dk.MA_CHINH_SACH && THANH_PHAN = "PV" && AP_DUNG = "1" && (MA_TIEU_CHI = "MA_TINH_TP" Or MA_TIEU_CHI = "MA_VUNG_MIEN")
                                    )
                                ) And !IsBlank(
                                    LookUp(
                                        DL_CHINHSACH_DOITUONG_CT,
                                        MA_CHINH_SACH = dk.MA_CHINH_SACH && THANH_PHAN = "PV" && AP_DUNG = "2" && (MA_TIEU_CHI = "MA_TINH_TP" Or MA_TIEU_CHI = "MA_VUNG_MIEN")
                                    )
                                ) And !IsBlank(
                                    LookUp(
                                        DL_CHINHSACH_DOITUONG_CT,
                                        MA_CHINH_SACH = dk.MA_CHINH_SACH && THANH_PHAN = "PV" && AP_DUNG = "2" && (MA_GIA_TRI = cbxTinhNHD.Selected.MA_PHAMVI Or MA_GIA_TRI = cbxTinhNHD.Selected.MA_CHA)
                                    )
                                ) And !IsBlank(cbxTinhNHD.Selected.MA_PHAMVI),
                                Collect(
                                    tmpErrorCs,
                                    {ID: 13}
                                );
                            );
                            
                        // Nếu phạm vi áp dụng 1 phần
                        // Tìm trong danh sách áp dụng theo tỉnh/thành phố hoặc là mã cha của tỉnh/thành phố nếu không có thì false
                        If(
                                !IsBlank(
                                    LookUp(
                                        DL_CHINHSACH_DOITUONG_CT,
                                        MA_CHINH_SACH = dk.MA_CHINH_SACH && THANH_PHAN = "PV" && AP_DUNG = "1" && KIEU = "2" && (MA_TIEU_CHI = "MA_TINH_TP" Or MA_TIEU_CHI = "MA_VUNG_MIEN")
                                    )
                                ) And IsBlank(
                                    LookUp(
                                        DL_CHINHSACH_DOITUONG_CT,
                                        MA_CHINH_SACH = dk.MA_CHINH_SACH && THANH_PHAN = "PV" && AP_DUNG = "1" && KIEU = "2" && (MA_GIA_TRI = cbxTinhNHD.Selected.MA_PHAMVI Or MA_GIA_TRI = cbxTinhNHD.Selected.MA_CHA)
                                    )
                                ) And !IsBlank(cbxTinhNHD.Selected.MA_PHAMVI),
                                Collect(
                                    tmpErrorCs,
                                    {ID: 14}
                                );
                            );
                            
                        // Nếu phạm vi áp dụng 1 phần
                        // Tìm trong danh sách áp dụng theo tỉnh/thành phố hoặc mã cha của tỉnh/thành phố nếu có dữ liệu
                        // Tìm trong danh sách loại trừ theo tỉnh/thành phố và mã cha của tỉnh/thành phố nếu có dữ liệu thì -> false, nếu không có thì  -> pass
                        If(
                                !IsBlank(
                                    LookUp(
                                        DL_CHINHSACH_DOITUONG_CT,
                                        MA_CHINH_SACH = dk.MA_CHINH_SACH && THANH_PHAN = "PV" && AP_DUNG = "1" && KIEU = "2" && (MA_TIEU_CHI = "MA_TINH_TP" Or MA_TIEU_CHI = "MA_VUNG_MIEN")
                                    )
                                ) And !IsBlank(
                                    LookUp(
                                        DL_CHINHSACH_DOITUONG_CT,
                                        MA_CHINH_SACH = dk.MA_CHINH_SACH && THANH_PHAN = "PV" && AP_DUNG = "1" && KIEU = "2" && (MA_GIA_TRI = cbxTinhNHD.Selected.MA_PHAMVI Or MA_GIA_TRI = cbxTinhNHD.Selected.MA_CHA)
                                    )
                                ) And !IsBlank(
                                    LookUp(
                                        DL_CHINHSACH_DOITUONG_CT,
                                        MA_CHINH_SACH = dk.MA_CHINH_SACH && THANH_PHAN = "PV" && AP_DUNG = "2" && (MA_GIA_TRI = cbxTinhNHD.Selected.MA_PHAMVI Or MA_GIA_TRI = cbxTinhNHD.Selected.MA_CHA)
                                    )
                                ) And !IsBlank(cbxTinhNHD.Selected.MA_PHAMVI),
                                Collect(
                                    tmpErrorCs,
                                    {ID: 15}
                                );
                            );
                            
                        //3.2 Kiểm tra đơn vị quản lý hợp đồng
                        // Nếu áp dụng cho tất cả và có loại trừ
                        // Tìm giá trị loại trừ đơn vị quản lý hợp đồng nếu có dữ liệu thì false
                        If(
                                IsBlank(
                                    LookUp(
                                        DL_CHINHSACH_DOITUONG_CT,
                                        MA_CHINH_SACH = dk.MA_CHINH_SACH && THANH_PHAN = "PV" && AP_DUNG = "1" && MA_TIEU_CHI = "MA_DON_VI"
                                    )
                                ) And !IsBlank(
                                    LookUp(
                                        DL_CHINHSACH_DOITUONG_CT,
                                        MA_CHINH_SACH = dk.MA_CHINH_SACH && THANH_PHAN = "PV" && AP_DUNG = "2" && MA_TIEU_CHI = "MA_DON_VI" && MA_GIA_TRI = cbxDVQLNHD.Selected.MA_PHAMVI
                                    )
                                ) And !IsBlank(cbxDVQLNHD.Selected.MA_PHAMVI),
                                Collect(
                                    tmpErrorCs,
                                    {ID: 16}
                                );
                            );
                            
                        // Nếu phạm vi áp dụng 1 phần
                        // Tìm trong danh sách áp dụng đơn vị quản lý hợp đồng không có thì false
                        If(
                                !IsBlank(
                                    LookUp(
                                        DL_CHINHSACH_DOITUONG_CT,
                                        MA_CHINH_SACH = dk.MA_CHINH_SACH && THANH_PHAN = "PV" && AP_DUNG = "1" && KIEU = "2" && MA_TIEU_CHI = "MA_DON_VI"
                                    )
                                ) And IsBlank(
                                    LookUp(
                                        DL_CHINHSACH_DOITUONG_CT,
                                        MA_CHINH_SACH = dk.MA_CHINH_SACH && THANH_PHAN = "PV" && AP_DUNG = "1" && KIEU = "2" && MA_GIA_TRI = cbxDVQLNHD.Selected.MA_PHAMVI
                                    )
                                ) And !IsBlank(cbxDVQLNHD.Selected.MA_PHAMVI),
                                Collect(
                                    tmpErrorCs,
                                    {ID: 17}
                                );
                            );
                            
                        // Nếu phạm vi áp dụng 1 phần
                        // Tìm trong danh sách áp dụng theo đơn vị quản lý hợp đồng nếu có dữ liệu
                        // Tìm trong danh sách loại trừ theo đơn vị quản lý hợp đồng nếu có dữ liệu thì -> false, nếu không có thì  -> pass
                        If(
                                !IsBlank(
                                    LookUp(
                                        DL_CHINHSACH_DOITUONG_CT,
                                        MA_CHINH_SACH = dk.MA_CHINH_SACH && THANH_PHAN = "PV" && AP_DUNG = "1" && KIEU = "2" && MA_TIEU_CHI = "MA_DON_VI" && MA_GIA_TRI = cbxDVQLNHD.Selected.MA_PHAMVI
                                    )
                                ) And !IsBlank(
                                    LookUp(
                                        DL_CHINHSACH_DOITUONG_CT,
                                        MA_CHINH_SACH = dk.MA_CHINH_SACH && THANH_PHAN = "PV" && AP_DUNG = "2" && MA_TIEU_CHI = "MA_DON_VI" && MA_GIA_TRI = cbxDVQLNHD.Selected.MA_PHAMVI
                                    )
                                ) And !IsBlank(cbxDVQLNHD.Selected.MA_PHAMVI),
                                Collect(
                                    tmpErrorCs,
                                    {ID: 18}
                                );
                            );
                            
                        //4. Kiểm tra sản phẩm
                        ForAll(
                                Gallery3_2.AllItems As sp,
                                    // 4.1.1 Kiểm tra thông tin sản phẩm
                        // Nếu sản phẩm áp dụng cho tất cả và có loại trừ
                        // Tìm giá trị loại trừ mã sản phẩm nếu có dữ liệu thì false
                                If(
                                    IsBlank(
                                        LookUp(
                                            DL_CHINHSACH_DOITUONG_CT,
                                            MA_CHINH_SACH = dk.MA_CHINH_SACH && THANH_PHAN = "SP" && AP_DUNG = "1" && MA_TIEU_CHI = "MA_SP"
                                        )
                                    ) And !IsBlank(
                                        LookUp(
                                            DL_CHINHSACH_DOITUONG_CT,
                                            MA_CHINH_SACH = dk.MA_CHINH_SACH && THANH_PHAN = "SP" && AP_DUNG = "2" && MA_TIEU_CHI = "MA_SP" && MA_GIA_TRI = sp.cbxMaSPNHD.Selected.MA_SAN_PHAM
                                        )
                                    ) And !IsBlank(sp.cbxMaSPNHD.Selected.MA_SAN_PHAM),
                                    Collect(
                                        tmpErrorCs,
                                        {ID: 19}
                                    );
                                );
                                    // Nếu sản phẩm áp dụng 1 phần
                        // Tìm trong danh sách áp dụng theo mã sản phẩm nếu không có thì false
                        If(
                                    !IsBlank(
                                        LookUp(
                                            DL_CHINHSACH_DOITUONG_CT,
                                            MA_CHINH_SACH = dk.MA_CHINH_SACH && THANH_PHAN = "SP" && AP_DUNG = "1" && MA_TIEU_CHI = "MA_SP"
                                        )
                                    ) And IsBlank(
                                        LookUp(
                                            DL_CHINHSACH_DOITUONG_CT,
                                            MA_CHINH_SACH = dk.MA_CHINH_SACH && THANH_PHAN = "SP" && AP_DUNG = "1" && MA_TIEU_CHI = "MA_SP" && KIEU = "2" && MA_GIA_TRI = sp.cbxMaSPNHD.Selected.MA_SAN_PHAM
                                        )
                                    ) And !IsBlank(sp.cbxMaSPNHD.Selected.MA_SAN_PHAM),
                                    Collect(
                                        tmpErrorCs,
                                        {ID: 20}
                                    );
                                );
                                
                        // Nếu sản phẩm áp dụng 1 phần
                        // Tìm trong danh sách áp dụng theo mã sản phẩm nếu có dữ liệu
                        // Tìm trong danh sách loại trừ theo mã sản phẩm nếu có dữ liệu thì -> false, nếu không có thì  -> pass
                        If(
                                    !IsBlank(
                                        LookUp(
                                            DL_CHINHSACH_DOITUONG_CT,
                                            MA_CHINH_SACH = dk.MA_CHINH_SACH && THANH_PHAN = "SP" && AP_DUNG = "1" && MA_TIEU_CHI = "MA_SP" && MA_GIA_TRI = sp.cbxMaSPNHD.Selected.MA_SAN_PHAM
                                        )
                                    ) And !IsBlank(
                                        LookUp(
                                            DL_CHINHSACH_DOITUONG_CT,
                                            MA_CHINH_SACH = dk.MA_CHINH_SACH && THANH_PHAN = "SP" && AP_DUNG = "2" && MA_TIEU_CHI = "MA_SP" && MA_GIA_TRI = sp.cbxMaSPNHD.Selected.MA_SAN_PHAM
                                        )
                                    ) And !IsBlank(sp.cbxMaSPNHD.Selected.MA_SAN_PHAM),
                                    Collect(
                                        tmpErrorCs,
                                        {ID: 21}
                                    );
                                );
                                // 4.1.2 Kiểm tra thông tin chương trình
                        // Nếu chương trình áp dụng cho tất cả và có loại trừ
                        // Tìm giá trị loại trừ chương trình nếu có dữ liệu thì false
                        If(
                                    IsBlank(
                                        LookUp(
                                            DL_CHINHSACH_DOITUONG_CT,
                                            MA_CHINH_SACH = dk.MA_CHINH_SACH && THANH_PHAN = "SP" && AP_DUNG = "1" && MA_TIEU_CHI = "MA_CT"
                                        )
                                    ) And !IsBlank(
                                        LookUp(
                                            DL_CHINHSACH_DOITUONG_CT,
                                            MA_CHINH_SACH = dk.MA_CHINH_SACH && THANH_PHAN = "SP" && AP_DUNG = "2" && MA_TIEU_CHI = "MA_CT" && MA_GIA_TRI = sp.cbxMaCTNHD.Selected.MA_CHUONG_TRINH
                                        )
                                    ) And !IsBlank(sp.cbxMaCTNHD.Selected.MA_CHUONG_TRINH),
                                    Collect(
                                        tmpErrorCs,
                                        {ID: 22}
                                    );
                                );
                                    // Nếu sản phẩm áp dụng 1 phần
                        // Tìm trong danh sách áp dụng theo mã sản phẩm nếu không có thì false
                        If(
                                    !IsBlank(
                                        LookUp(
                                            DL_CHINHSACH_DOITUONG_CT,
                                            MA_CHINH_SACH = dk.MA_CHINH_SACH && THANH_PHAN = "SP" && AP_DUNG = "1" && MA_TIEU_CHI = "MA_CT"
                                        )
                                    ) And IsBlank(
                                        LookUp(
                                            DL_CHINHSACH_DOITUONG_CT,
                                            MA_CHINH_SACH = dk.MA_CHINH_SACH && THANH_PHAN = "SP" && AP_DUNG = "1" && MA_TIEU_CHI = "MA_CT" && KIEU = "2" && MA_GIA_TRI = sp.cbxMaCTNHD.Selected.MA_CHUONG_TRINH
                                        )
                                    ) And !IsBlank(sp.cbxMaCTNHD.Selected.MA_CHUONG_TRINH),
                                    Collect(
                                        tmpErrorCs,
                                        {ID: 23}
                                    );
                                );
                                    // Nếu chương trình áp dụng 1 phần
                        // Tìm trong danh sách áp dụng theo mã chương trình nếu có dữ liệu
                        // Tìm trong danh sách loại trừ theo mã chương trình nếu có dữ liệu thì -> false, nếu không có thì  -> pass
                        If(
                                    !IsBlank(
                                        LookUp(
                                            DL_CHINHSACH_DOITUONG_CT,
                                            MA_CHINH_SACH = dk.MA_CHINH_SACH && THANH_PHAN = "SP" && AP_DUNG = "1" && MA_TIEU_CHI = "MA_CT" && MA_GIA_TRI = sp.cbxMaCTNHD.Selected.MA_CHUONG_TRINH
                                        )
                                    ) And !IsBlank(
                                        LookUp(
                                            DL_CHINHSACH_DOITUONG_CT,
                                            MA_CHINH_SACH = dk.MA_CHINH_SACH && THANH_PHAN = "SP" && AP_DUNG = "2" && MA_TIEU_CHI = "MA_CT" && MA_GIA_TRI = sp.cbxMaCTNHD.Selected.MA_CHUONG_TRINH
                                        )
                                    ) And !IsBlank(sp.cbxMaCTNHD.Selected.MA_CHUONG_TRINH),
                                    Collect(
                                        tmpErrorCs,
                                        {ID: 24}
                                    );
                                );
                         // 4.1.3 Kiểm tra thông tin LHNV
                        // Nếu LHNV áp dụng cho tất cả và có loại trừ
                        // Tìm giá trị loại trừ LHNV nếu có dữ liệu thì false
                        If(
                                    IsBlank(
                                        LookUp(
                                            DL_CHINHSACH_DOITUONG_CT,
                                            MA_CHINH_SACH = dk.MA_CHINH_SACH && THANH_PHAN = "SP" && AP_DUNG = "1" && MA_TIEU_CHI = "LHNV"
                                        )
                                    ) And !IsBlank(
                                        LookUp(
                                            DL_CHINHSACH_DOITUONG_CT,
                                            MA_CHINH_SACH = dk.MA_CHINH_SACH && THANH_PHAN = "SP" && AP_DUNG = "2" && MA_TIEU_CHI = "LHNV" && TEN_GIA_TRI = tiPhiNGNHD_1.Text
                                        )
                                    ) And !IsBlank(tiPhiNGNHD_1.Text),
                                    Collect(
                                        tmpErrorCs,
                                        {ID: 25}
                                    );
                                );
                                    // Nếu sản phẩm áp dụng 1 phần
                        // Tìm trong danh sách áp dụng theo mã sản phẩm nếu không có thì false
                        If(
                                    !IsBlank(
                                        LookUp(
                                            DL_CHINHSACH_DOITUONG_CT,
                                            MA_CHINH_SACH = dk.MA_CHINH_SACH && THANH_PHAN = "SP" && AP_DUNG = "1" && MA_TIEU_CHI = "LHNV"
                                        )
                                    ) And IsBlank(
                                        LookUp(
                                            DL_CHINHSACH_DOITUONG_CT,
                                            MA_CHINH_SACH = dk.MA_CHINH_SACH && THANH_PHAN = "SP" && AP_DUNG = "1" && MA_TIEU_CHI = "LHNV" && KIEU = "2" && TEN_GIA_TRI = tiPhiNGNHD_1.Text
                                        )
                                    ) And !IsBlank(tiPhiNGNHD_1.Text),
                                    Collect(
                                        tmpErrorCs,
                                        {ID: 26}
                                    );
                                );
                                
                        // Nếu chương trình áp dụng 1 phần
                        // Tìm trong danh sách áp dụng theo mã chương trình nếu có dữ liệu
                        // Tìm trong danh sách loại trừ theo mã chương trình nếu có dữ liệu thì -> false, nếu không có thì  -> pass
                        If(
                                    !IsBlank(
                                        LookUp(
                                            DL_CHINHSACH_DOITUONG_CT,
                                            MA_CHINH_SACH = dk.MA_CHINH_SACH && THANH_PHAN = "SP" && AP_DUNG = "1" && MA_TIEU_CHI = "LHNV" && TEN_GIA_TRI = tiPhiNGNHD_1.Text
                                        )
                                    ) And !IsBlank(
                                        LookUp(
                                            DL_CHINHSACH_DOITUONG_CT,
                                            MA_CHINH_SACH = dk.MA_CHINH_SACH && THANH_PHAN = "SP" && AP_DUNG = "2" && MA_TIEU_CHI = "LHNV" && TEN_GIA_TRI = tiPhiNGNHD_1.Text
                                        )
                                    ) And !IsBlank(tiPhiNGNHD_1.Text),
                                    Collect(
                                        tmpErrorCs,
                                        {ID: 27}
                                    );
                                );
                            );
                            
                        //4.1.4 Kiểm tra combo sản phẩm
                        // lấy danh sách sản phẩm trên hợp đồng
                        ForAll(
                                Gallery3_2.AllItems As sp,
                                Collect(
                                    dsSpKetHop,
                                    {MA_SAN_PHAM: sp.cbxMaSPNHD.Selected.MA_SAN_PHAM}
                                )
                            );
                            ForAll(
                                Gallery3_1.AllItems As sp,
                                Collect(
                                    dsSpKetHop,
                                    {MA_SAN_PHAM: sp.tiMaSPLKNHD_1.Text}
                                )
                            );
                            Collect(
                                GroupedSp,
                                GroupBy(
                                    dsSpKetHop,
                                    "MA_SAN_PHAM",
                                    "Grouped"
                                )
                            );
                            If(
                                CountRows(GroupedSp) > 1,
                                Collect(
                                    dsCombosp,
                                    Filter(
                                        DL_CHINHSACH_DOITUONG_CT,
                                        MA_GIA_TRI,
                                        MA_CHINH_SACH = dk.MA_CHINH_SACH && THANH_PHAN = "SP" && MA_TIEU_CHI = "MA_COMBO_SP" && AP_DUNG = "1"
                                    )
                                );
                                Collect(
                                    dsCombospLt,
                                    Filter(
                                        DL_CHINHSACH_DOITUONG_CT,
                                        MA_GIA_TRI,
                                        MA_CHINH_SACH = dk.MA_CHINH_SACH && THANH_PHAN = "SP" && MA_TIEU_CHI = "MA_COMBO_SP" && AP_DUNG = "2"
                                    )
                                );
                                ForAll(
                                    GroupedSp As sp,
                                    RemoveIf(
                                        dsCombosp,
                                        cr282_ma_gia_tri = sp.MA_SAN_PHAM
                                    );
                                );
                                ForAll(
                                    GroupedSp As sp,
                                    RemoveIf(
                                        dsCombospLt,
                                        cr282_ma_gia_tri = sp.MA_SAN_PHAM
                                    );
                                );
                                
                        // Nếu COMBO áp dụng cho tất cả và có loại trừ
                        // Tìm giá trị loại trừ theo combo sản phẩm nếu có dữ liệu thì false
                        If(
                                    IsBlank(
                                        LookUp(
                                            DL_CHINHSACH_DOITUONG_CT,
                                            MA_CHINH_SACH = dk.MA_CHINH_SACH && THANH_PHAN = "SP" && AP_DUNG = "1" && MA_TIEU_CHI = "MA_COMBO_SP"
                                        )
                                    ) And !IsBlank(
                                        LookUp(
                                            DL_CHINHSACH_DOITUONG_CT,
                                            MA_CHINH_SACH = dk.MA_CHINH_SACH && THANH_PHAN = "SP" && AP_DUNG = "2" && MA_TIEU_CHI = "MA_COMBO_SP"
                                        )
                                    ) And CountRows(dsCombospLt) = 0 And CountRows(GroupedSp) = CountRows(
                                        Filter(
                                            DL_CHINHSACH_DOITUONG_CT,
                                            MA_CHINH_SACH = dk.MA_CHINH_SACH && THANH_PHAN = "SP" && AP_DUNG = "2" && MA_TIEU_CHI = "MA_COMBO_SP"
                                        )
                                    ),
                                    Collect(
                                        tmpErrorCs,
                                        {ID: 28}
                                    );
                                );
                                
                        // Nếu combo sản phẩm áp dụng 1 phần
                        // Tìm trong danh sách áp dụng theo COMBO SẢN PHẨM nếu không khớp có thì false
                        If(
                                    !IsBlank(
                                        LookUp(
                                            DL_CHINHSACH_DOITUONG_CT,
                                            MA_CHINH_SACH = dk.MA_CHINH_SACH && THANH_PHAN = "SP" && AP_DUNG = "1" && MA_TIEU_CHI = "MA_COMBO_SP"
                                        )
                                    ) And (CountRows(dsCombosp) <> 0),
                                    Collect(
                                        tmpErrorCs,
                                        {ID: 29}
                                    );
                                );
                                If(
                                    !IsBlank(
                                        LookUp(
                                            DL_CHINHSACH_DOITUONG_CT,
                                            MA_CHINH_SACH = dk.MA_CHINH_SACH && THANH_PHAN = "SP" && AP_DUNG = "1" && MA_TIEU_CHI = "MA_COMBO_SP"
                                        )
                                    ) And CountRows(GroupedSp) <> CountRows(
                                        Filter(
                                            DL_CHINHSACH_DOITUONG_CT,
                                            MA_CHINH_SACH = dk.MA_CHINH_SACH && THANH_PHAN = "SP" && AP_DUNG = "1" && MA_TIEU_CHI = "MA_COMBO_SP"
                                        )
                                    ),
                                    Collect(
                                        tmpErrorCs,
                                        {ID: 30}
                                    );
                                );
                            );
                            
                        // lấy số sản phẩm trong hợp đồng
                        If(
                                CountRows(tmpErrorCs) <= 0,
                                Collect(
                                    tmpPassCs,
                                    {ma_chinh_sach: dk.MA_CHINH_SACH}
                                );
                            )
                        );
                        If(
                            CountRows(tmpPass) <= 0,
                            UpdateContext({errorMsg: "Không có điều kiện áp dụng thoả mãn"})
                        );
                        If(
                            CountRows(tmpPassCs) <= 0,
                            UpdateContext({errorMsg: "Không có chính sách áp dụng"})
                        );
                        // end chính sách áp dụng
                        If(
                            !IsBlank(errorMsg),
                            Notify(
                                errorMsg,
                                NotificationType.Error,
                                800
                            ),
                            Set(
                                varMaHD_CS,
                                If(
                                    IsBlank(tiMaHDNHD.Text),
                                    maHopDongFwd,
                                    tiMaHDNHD.Text
                                )
                            );
                            Navigate(ChonChinhSach);
                            
                        );
                    Size: =11
                    Underline: =true
                    Width: =142
                    X: =11
                    Y: =24
                    ZIndex: =20

            Container3_9 As groupContainer.manualLayoutContainer:
                Height: =218
                Width: =1267
                X: =16
                Y: =1277
                ZIndex: =9

                Label3_63 As label:
                    FontWeight: =FontWeight.Bold
                    Height: =20
                    Size: =11
                    Text: ="7. Thanh toán"
                    Width: =254
                    Y: =4
                    ZIndex: =19

                Gallery3_3 As gallery.variableTemplateHeightGallery:
                    DelayItemLoading: =true
                    Height: =153
                    Items: |-
                        =SortByColumns(
                            tmpKTTNHDCollect,
                            "cr282_thoi_han_ttoan",
                            SortOrder.Ascending
                        )
                    Layout: =Layout.Vertical
                    LoadingSpinner: =LoadingSpinner.Data
                    TemplatePadding: =0
                    TemplateSize: =74
                    Width: =611
                    X: =654
                    Y: =61
                    ZIndex: =21

                    Label3_80 As label:
                        Height: =25
                        Size: =11
                        Text: ="Thời hạn đóng phí"
                        X: =265
                        Y: =5
                        ZIndex: =2

                    Label3_79 As label:
                        Height: =25
                        Size: =11
                        Text: ="Phí thanh toán/kỳ"
                        Width: =140
                        X: =20
                        Y: =5
                        ZIndex: =3

                    tiTenKHLKNHD_2 As text:
                        Align: =Align.Right
                        BorderColor: =RGBA(72, 163, 62, 1)
                        Default: =ThisItem.PHI_THANH_TOAN
                        Format: =TextFormat.Number
                        Height: =32
                        Size: =11
                        Width: =220
                        X: =20
                        Y: =33
                        ZIndex: =4

                    dpNSinhNHD_1 As datepicker:
                        BorderColor: =RGBA(72, 163, 62, 1)
                        DefaultDate: =ThisItem.THOI_HAN_TTOAN
                        EndYear: =2200
                        Format: ="dd/mm/yyyy"
                        Height: =32
                        InputTextPlaceholder: =
                        Size: =11
                        StartYear: =1900
                        Width: =220
                        X: =265
                        Y: =33
                        ZIndex: =5

                    Button2_6 As button:
                        Height: =32
                        OnSelect: |
                            =Remove(tmpKTTNHDCollect,ThisItem)
                        Size: =11
                        Text: ="Xóa"
                        Width: =85
                        X: =504
                        Y: =33
                        ZIndex: =6

                tiTongTPNHD As text:
                    Align: =Align.Right
                    BorderColor: =RGBA(72, 163, 62, 1)
                    Default: =First(objHD).TONG_TIEN_PHI
                    DisplayMode: =DisplayMode.Disabled
                    Format: =TextFormat.Number
                    Height: =32
                    Size: =11
                    Width: =250
                    X: =38
                    Y: =94
                    ZIndex: =22

                Label3_78 As label:
                    Height: =25
                    Size: =11
                    Text: ="Tổng tiền phí"
                    Width: =200
                    X: =38
                    Y: =66
                    ZIndex: =23

                tiSTGiamNHD As text:
                    Align: =Align.Right
                    BorderColor: =RGBA(72, 163, 62, 1)
                    Default: = If(IsBlank(First(objHD).SO_TIEN_GIAM),0,First(objHD).SO_TIEN_GIAM)
                    DisplayMode: =DisplayMode.Disabled
                    Format: =TextFormat.Number
                    Height: =32
                    Size: =11
                    Width: =250
                    X: =38
                    Y: =168
                    ZIndex: =24

                Label3_81 As label:
                    Height: =25
                    Size: =11
                    Text: ="Số tiền giảm"
                    Width: =200
                    X: =38
                    Y: =140
                    ZIndex: =25

                tiTienSauGiamNHD As text:
                    Align: =Align.Right
                    BorderColor: =RGBA(72, 163, 62, 1)
                    Default: =First(objHD).TIEN_PHI_SAU_GIAM
                    DisplayMode: =DisplayMode.Disabled
                    Format: =TextFormat.Number
                    Height: =32
                    Size: =11
                    Width: =250
                    X: =342
                    Y: =168
                    ZIndex: =26

                Label3_82 As label:
                    Height: =25
                    Size: =11
                    Text: ="Tổng tiền phí sau giảm"
                    Width: =200
                    X: =342
                    Y: =140
                    ZIndex: =27

                Label3_77 As label:
                    Height: =25
                    Size: =11
                    Text: ="Mã giảm giá"
                    Width: =200
                    X: =342
                    Y: =66
                    ZIndex: =28

                cbxMaGGNHD As combobox:
                    BorderColor: =RGBA(72, 163, 62, 1)
                    DefaultSelectedItems: =LookUp(DM_MA_GIAMGIAS,MA_GIAM_GIA=First(objHD).MA_GIAM_GIA)
                    DisplayFields: =["cr282_ma_giam_gia"]
                    Height: =32
                    InputTextPlaceholder: ="Chọn mã giảm giá"
                    Items: =DM_MA_GIAMGIAS
                    OnChange: |-
                        =UpdateIf(
                            objHD,
                            true,
                            {
                                SO_TIEN_GIAM:If(
                                    !IsBlank(cbxMaGGNHD.Selected.TY_LE_GIAM),
                                    Value(tiTongTPNHD.Text)*cbxMaGGNHD.Selected.TY_LE_GIAM,
                                    !IsBlank(cbxMaGGNHD.Selected.SO_TIEN),
                                    cbxMaGGNHD.Selected.SO_TIEN
                                )
                            }
                        );
                        UpdateIf(
                            objHD,
                            true,
                            {
                                TIEN_PHI_SAU_GIAM:Value(tiTongTPNHD.Text)-Value(tiSTGiamNHD.Text)
                            }
                        );
                    SearchFields: =["cr282_ma_giam_gia"]
                    SearchItems: =Search(DM_MA_GIAMGIAS,cbxMaGGNHD.SearchText,"cr282_ma_giam_gia")
                    SelectMultiple: =false
                    Size: =11
                    Width: =250
                    X: =342
                    Y: =94
                    ZIndex: =29

                Button2_5 As button:
                    Height: =32
                    OnSelect: |-
                        =Collect(
                            tmpKTTNHDCollect,
                            {
                                ID:Text(maKTT+1)
                            }
                        );
                        UpdateContext({
                            maKTT:maKTT+1
                        });
                    Size: =11
                    Text: ="Thêm mới"
                    Width: =98
                    X: =678
                    Y: =25
                    ZIndex: =30

    LeftNavigation_30 As LeftNavigation_9:
        Width: =LeftNavigation_30.MenuWidth - 10
        ZIndex: =4

    Button2_4 As button:
        FontWeight: =FontWeight.Bold
        Height: =32
        OnSelect: |-
            =If(
                IsBlank(dpNgayHDNHD.SelectedDate),
                Notify("Bắt buộc nhập ngày hợp đồng",NotificationType.Error,2000),
                IsBlank(dpHLTuNHD.SelectedDate),
                Notify("Bắt buộc nhập hiệu lực từ của hợp đồng",NotificationType.Error,2000),
            	IsBlank(dpHLDenNHD.SelectedDate),
            	Notify("Bắt buộc nhập hiệu lực đến của hợp đồng",NotificationType.Error,2000),
            	IsBlank(cbxDVQLNHD.Selected.MA_PHAMVI),
            	Notify("Bắt buộc nhập đơn vị quản lý hợp đồng",NotificationType.Error,2000),
            	IsBlank(cbxDVTienNHD.Selected.TIEN_TE),
            	Notify("Bắt buộc nhập đơn vị tiền",NotificationType.Error,2000),
            	IsBlank(cbxLoaiKBNHD.Selected.MA_LOAI_KB),
            	Notify("Bắt buộc nhập loại kênh bán",NotificationType.Error,2000),
            	IsBlank(cbxMaKBNHD.Selected.MA_KENH_BAN),
            	Notify("Bắt buộc nhập mã kênh bán",NotificationType.Error,2000),
            	IsBlank(tiTenKBNHD.Text),
                Notify("Bắt buộc nhập tên kênh bán",NotificationType.Error,2000),
            	IsBlank(cbxMaKHNHD.Selected.MA_KHACH_HANG),
            	Notify("Bắt buộc nhập mã khách hàng",NotificationType.Error,2000),
            	IsBlank(tiTenKHNHD.Text),
            	Notify("Bắt buộc nhập tên khách hàng",NotificationType.Error,2000),
                dpNgayHDNHD.SelectedDate>dpHLTuNHD.SelectedDate,
            	Notify("Ngày hiệu lực từ phải sau hoặc bằng ngày hợp đồng",NotificationType.Error,2000),
                dpHLDenNHD.SelectedDate<=dpHLTuNHD.SelectedDate,
            	Notify("Ngày hiệu lực đến phải sau ngày hiệu lực từ",NotificationType.Error,2000),
                Refresh(DL_HOP_DONGS);
                If(
                    CountIf(DL_HOP_DONGS,true)=0,
                    UpdateContext({
                        genMaHD:"HD0001"
                    }),
                    UpdateContext({
                        sampleID:"000",
                        maxIdHD:Last(SortByColumns(DL_HOP_DONGS,"cr282_ma_hop_dong",SortOrder.Ascending)).MA_HOP_DONG
                    });
                    UpdateContext({
                        maIdHD:Text((Right(maxIdHD,4))+1)
                    });
                    UpdateContext({
                        genMaHD:Concatenate("HD",If(Len(maIdHD)>3,"",Left(sampleID,4-Len(maIdHD))),maIdHD)
                    });
                );
                If(
                    IsBlank(LookUp(DL_HOP_DONGS,MA_HOP_DONG=tiMaHDNHD.Text)),
                    Patch(
                        DL_HOP_DONGS,
                        {
                            ID:Text(Max(DL_HOP_DONGS,ID)+1),
                            MA_HOP_DONG:genMaHD,
                            DIA_CHI:tiDChiNHD.Text,
                            DONVI_KENHBAN:cbxDVKBNHD.Selected.MA_DON_VI,
                            DONVI_QUANLY_HD:cbxDVQLNHD.Selected.MA_PHAMVI,
                            DONVI_TIEN:cbxDVTienNHD.Selected.TIEN_TE,
                            EMAIL:tiEmailNHD.Text,
                            GIOI_TINH:cbxGTinhNHD.Selected.MA_GIOI_TINH,
                            HIEU_LUC_DEN:dpHLDenNHD.SelectedDate,
                            HIEU_LUC_TU:dpHLTuNHD.SelectedDate,
                            LOAI_KENH_BAN:cbxLoaiKBNHD.Selected.MA_LOAI_KB,
                            LOAI_KHACH_HANG:cbxLoaiKHNHD.Selected.value,
                            MA_KENH_BAN:cbxMaKBNHD.Selected.MA_KENH_BAN,
                            MA_KHACH_HANG:cbxMaKHNHD.Selected.MA_KHACH_HANG,
                            NGAY_HOP_DONG:dpNgayHDNHD.SelectedDate,
                            NGAY_SINH:dpNSinhNHD.SelectedDate,
                            NGHE_NGHIEP:cbxNgheNHD.Selected.MA_NHOM_NGANH,
                            SO_DIEN_THOAI:tiSDTNHD.Text,
                            SO_NGUOI_TGIA:tiSoNTGNHD.Text,
                            TEN_KENH_BAN:tiTenKBNHD.Text,
                            TEN_KHACH_HANG:tiTenKHNHD.Text,
                            TRANG_THAI:"Hoạt động",
                            TINH_TP_KH:cbxTinhNHD.Selected.MA_PHAMVI,
                            PTHUC_THANH_TOAN:cbxPTTTNHD.Selected.value,
                            NHOM_KHACH_HANG:cbxNhomKHNHD.Selected.MA_NHOM_KH,
                            NHOM_KENH_BAN:nhomKB
                        }
                    );
                    ForAll(
                        tmpDSHDSPNHDCollect As dsSP,
                        Patch(
                            DL_HOP_DONG_SPS,
                            {
                                ID:dsSP.ID,
                                MA_HOP_DONG:genMaHD,
                                MA_SAN_PHAM:cbxMaSPNHD.Selected.MA_SAN_PHAM,
                                MA_CHUONG_TRINH:cbxMaCTNHD.Selected.MA_CHUONG_TRINH,
                                TEN_CHUONG_TRINH:tiTenCTNHD.Text,
                                TEN_SAN_PHAM:tiTenSPNHD.Text,
                                DON_VI_TINH:cbxDVTienNHD.Selected.TIEN_TE,
                                SONGUOI_THAMGIA:Value(tiSoNTGSPNHD.Text),
                                TONG_TIEN_PHI:Value(tiTongPhiNHD.Text),
                                MA_KENH_BAN:cbxMaKBNHD.Selected.MA_KENH_BAN,
                                MA_KHACH_HANG:cbxMaKHNHD.Selected.MA_KHACH_HANG,
                                NGAY_HOP_DONG:dpNgayHDNHD.SelectedDate
                            }
                        )
                    );
                    UpdateIf(
                        objHD,
                        true,
                        {
                            MA_HOP_DONG=genMaHD
                        }
                    ),
                    UpdateIf(
                        DL_HOP_DONGS,
                        MA_HOP_DONG=tiMaHDNHD.Text,
                        {
                            DIA_CHI:tiDChiNHD.Text,
                            DONVI_KENHBAN:cbxDVKBNHD.Selected.MA_DON_VI,
                            DONVI_QUANLY_HD:cbxDVQLNHD.Selected.MA_PHAMVI,
                            DONVI_TIEN:cbxDVTienNHD.Selected.TIEN_TE,
                            EMAIL:tiEmailNHD.Text,
                            GIOI_TINH:cbxGTinhNHD.Selected.MA_GIOI_TINH,
                            HIEU_LUC_DEN:dpHLDenNHD.SelectedDate,
                            HIEU_LUC_TU:dpHLTuNHD.SelectedDate,
                            LOAI_KENH_BAN:cbxLoaiKBNHD.Selected.MA_LOAI_KB,
                            LOAI_KHACH_HANG:cbxLoaiKHNHD.Selected.value,
                            MA_KENH_BAN:cbxMaKBNHD.Selected.MA_KENH_BAN,
                            MA_KHACH_HANG:cbxMaKHNHD.Selected.MA_KHACH_HANG,
                            NGAY_HOP_DONG:dpNgayHDNHD.SelectedDate,
                            NGAY_SINH:dpNSinhNHD.SelectedDate,
                            NGHE_NGHIEP:cbxNgheNHD.Selected.MA_NHOM_NGANH,
                            SO_DIEN_THOAI:tiSDTNHD.Text,
                            SO_NGUOI_TGIA:tiSoNTGNHD.Text,
                            TEN_KENH_BAN:tiTenKBNHD.Text,
                            TEN_KHACH_HANG:tiTenKHNHD.Text,
                            TRANG_THAI:"Hoạt động",
                            TINH_TP_KH:cbxTinhNHD.Selected.MA_PHAMVI,
                            PTHUC_THANH_TOAN:cbxPTTTNHD.Selected.value,
                            NHOM_KHACH_HANG:cbxNhomKHNHD.Selected.MA_NHOM_KH,
                            NHOM_KENH_BAN:nhomKB
                        }
                    );
                    ForAll(
                        tmpDSHDSPNHDCollect As dsSP,
                        If(
                            IsBlank(dsSP.added),
                            UpdateIf(
                                DL_HOP_DONG_SPS,
                                ID=dsSP.ID,
                                {
                                    SONGUOI_THAMGIA:Value(tiSoNTGSPNHD.Text),
                                    TONG_TIEN_PHI:Value(tiTongPhiNHD.Text),
                                    MA_KENH_BAN:cbxMaKBNHD.Selected.MA_KENH_BAN,
                                    MA_KHACH_HANG:cbxMaKHNHD.Selected.MA_KHACH_HANG,
                                    NGAY_HOP_DONG:dpNgayHDNHD.SelectedDate
                                }
                            ),
                            dsSP.added=1,
                            Patch(
                                DL_HOP_DONG_SPS,
                                {
                                    ID:dsSP.ID,
                                    MA_HOP_DONG:tiMaHDNHD.Text,
                                    MA_SAN_PHAM:cbxMaSPNHD.Selected.MA_SAN_PHAM,
                                    MA_CHUONG_TRINH:cbxMaCTNHD.Selected.MA_CHUONG_TRINH,
                                    TEN_CHUONG_TRINH:tiTenCTNHD.Text,
                                    TEN_SAN_PHAM:tiTenSPNHD.Text,
                                    DON_VI_TINH:cbxDVTienNHD.Selected.TIEN_TE,
                                    SONGUOI_THAMGIA:Value(tiSoNTGSPNHD.Text),
                                    TONG_TIEN_PHI:Value(tiTongPhiNHD.Text),
                                    MA_KENH_BAN:cbxMaKBNHD.Selected.MA_KENH_BAN,
                                    MA_KHACH_HANG:cbxMaKHNHD.Selected.MA_KHACH_HANG,
                                    NGAY_HOP_DONG:dpNgayHDNHD.SelectedDate
                                }
                            )
                        )
                    )
                );
                Reset(tiMaHDNHD);Reset(LinkHDLK);
                Notify("Lưu dữ liệu thành công",NotificationType.Success,2000);
            )
        Size: =11
        Text: ="Lưu"
        Width: =85
        X: =1260
        Y: =716
        ZIndex: =5

    Button3_15 As button:
        FontWeight: =FontWeight.Bold
        Height: =32
        OnSelect: =Navigate(TraCuuHopDong)
        Size: =11
        Text: ="Hủy"
        Width: =85
        X: =1140
        Y: =716
        ZIndex: =6

