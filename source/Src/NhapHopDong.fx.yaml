"NhapHopDong As screen.'phoneLayout_FluidGridWithHeaderPageLayout_ver3.0'":
    OnVisible: |-
        =If(
            IsBlank(varUnReloadNHD),
            UpdateContext({
                unReloadCbxNHD:"1",
                unReloadMaSP:"1",
                unReloadMaCT:"1"
            });
            Reset(dpNgayHDNHD);
            Reset(dpHLTuNHD);
            Reset(dpHLDenNHD);
            Reset(cbxDVQLNHD);
            Reset(cbxDVTienNHD);
            Reset(cbxLoaiKBNHD);
            Reset(cbxMaKBNHD);
            Reset(tiTenKBNHD);
            Reset(cbxDVKBNHD);
            Reset(cbxMaKHNHD);
            Reset(tiTenKHNHD);
            Reset(tiDChiNHD);
            Reset(dpNSinhNHD);
            Reset(cbxGTinhNHD);
            Reset(tiSDTNHD);
            Reset(tiEmailNHD);
            Reset(cbxLoaiKHNHD);
            Reset(cbxNgheNHD);
            Reset(cbxTinhNHD);
            Reset(LinkHDLK);
            Reset(tiSoNTGNHD);
            Reset(ddLoaiHDNHD);
            If(
                IsBlank(
                    LookUp(
                        DL_HOP_DONGS,
                        MA_HOP_DONG = maHopDongFwd
                    )
                ),
                ClearCollect(
                    objHD,
                    Defaults(DL_HOP_DONGS)
                ),
                ClearCollect(
                    objHD,
                    LookUp(
                        DL_HOP_DONGS,
                        MA_HOP_DONG = maHopDongFwd
                    )
                )
            );
            ClearCollect(
                tmpDSHDSPNHDCollect,
                AddColumns(
                    Filter(
                        DL_HOP_DONG_SPS,
                        MA_HOP_DONG = maHopDongFwd
                    ),
                    "edited",
                    0
                )
            );
            ClearCollect(
                tmpDSNDBHNHDCollect,
                AddColumns(
                    Filter(
                        DL_HOP_DONG_SP_NDBH,
                        MA_HOP_DONG=First(objHD).MA_HOP_DONG
                    ),
                    "edited",
                    0
                )
            );
            ClearCollect(
                tmpQLCTHDSPNHDCollect,
                AddColumns(
                    Filter(
                        DL_HOP_DONG_SP_QLCT,
                        MA_HOP_DONG=First(objHD).MA_HOP_DONG
                    ),
                    "edited",
                    0
                )
            );
            ClearCollect(
                tmpDSHDSPLKNHDCollect,
                Filter(
                    DL_HOP_DONG_LIENKETS,
                    SO_HOP_DONG = maHopDongFwd
                )
            );
            ClearCollect(
                dmMaGiamGiaNHDCollect,
                AddColumns(
                    DM_MA_GIAMGIAS,
                    "title",
                    Concatenate(
                        "Mã: ",MA_GIAM_GIA,", Giảm theo: ",If(LOAI="SO_TIEN","Số tiền","Tỷ lệ"),", Giá trị giảm: ",
                        If(LOAI="SO_TIEN",Text(SO_TIEN),Concatenate(Text(TY_LE_GIAM*100),"%",", Phí giảm tối đa: ",Text(SO_TIEN_TOIDA)))
                    ),
                    "gia_tri_tong",
                    If(LOAI="SO_TIEN",SO_TIEN,SO_TIEN_TOIDA)
                )
            );
            ClearCollect(
                tmpKTTNHDCollect,
                Filter(
                    DL_HOP_DONG_TTOANS,
                    MA_HOP_DONG = maHopDongFwd
                )
            );
            UpdateContext(
                {
                    maAddedHDSPNHD: "",
                    maUpdatedHDSPNHD: "",
                    nhomKB:First(objHD).NHOM_KENH_BAN
                }
            );
            If(
                CountIf(
                    tmpKTTNHDCollect,
                    true
                ) = 0,
                Collect(
                    tmpKTTNHDCollect,
                    Defaults(tmpKTTNHDCollect)
                );
                UpdateContext({
                    maKTT:Max(DL_HOP_DONG_TTOANS,ID)+1
                });
                UpdateIf(
                    tmpKTTNHDCollect,
                    IsBlank(ID),
                    {
                        ID: Text(maKTT)
                    }
                )
            ),
            varUnReloadNHD = "2",
            UpdateIf(
                objHD,
                true,
                {
                    SO_NGUOI_TGIA:Sum(Filter(tmpDSHDSPNHDCollect,ID<>idHopDongSPNDBH),SONGUOI_THAMGIA)+LookUp(tmpMaCTChangeNHD,ID=idHopDongSPNDBH,SONGUOI_THAMGIA)
                }
            ),
            varUnReloadNHD = "3",
            ClearCollect(
                tmpDSHDSPLKNHDCollect,
                Filter(
                    DL_HOP_DONG_LIENKETS,
                    SO_HOP_DONG = First(objHD).MA_HOP_DONG
                )
            );
            
        );
        //Lay muc 6
        Clear(tmpCsDaChon);
        ForAll(
            Filter(
                DL_HOP_DONG_CHON_CS,
                MA_HOP_DONG = tiMaHDNHD.Text
            ) As cs,
            Collect(
                tmpCsDaChon,
                {
                    ID:cs.ID,
                    MA_CHINH_SACH: cs.MA_CHINH_SACH,
                    MO_TA: cs.MO_TA,
                    SO_TIEN: cs.SO_TIEN,
                    TY_LE: cs.TY_LE,
                    SO_TIEN_TOIDA: cs.SO_TIEN_TOIDA
                }
            );
            
        );
        Set(
            maHopDongFwd,
            ""
        );
        Set(
            varUnReloadNHD,
            Blank()
        );
        UpdateContext({
            unReloadCbxNHD:Blank()
        });

    Canvas2 As fluidGrid.fluidGridWithBlankCard:
        BorderThickness: =0
        Height: =768
        Width: =1306
        X: =60
        Y: =
        ZIndex: =3

        DataCard2 As dataCard:
            BorderColor: =RGBA(0, 0, 0, 1)
            BorderStyle: =BorderStyle.Solid
            BorderThickness: =0
            DisplayMode: =DisplayMode.Edit
            Fill: =RGBA(0, 0, 0, 0)
            Height: =1661
            Width: =1306
            X: =0
            Y: =0
            ZIndex: =1

            Container3_2 As groupContainer.manualLayoutContainer:
                Height: =179
                Width: =1267
                X: =16
                Y: =4
                ZIndex: =1

                Label3_32 As label:
                    Height: =25
                    Size: =11
                    Text: ="Số hợp đồng"
                    X: =30
                    Y: =24
                    ZIndex: =1

                tiMaHDNHD As text:
                    BorderColor: =RGBA(72, 163, 62, 1)
                    Default: =If(IsBlank(First(objHD).MA_HOP_DONG),"",First(objHD).MA_HOP_DONG) 
                    DisplayMode: =DisplayMode.Disabled
                    Height: =32
                    HintText: ="Hệ thống tự sinh"
                    RadiusBottomLeft: =0
                    RadiusBottomRight: =0
                    RadiusTopLeft: =0
                    RadiusTopRight: =0
                    Size: =11
                    Width: =250
                    X: =30
                    Y: =52
                    ZIndex: =2

                Label3_35 As label:
                    Height: =25
                    Size: =11
                    Text: ="Hiệu lực đến (*)"
                    Width: =140
                    X: =990
                    Y: =24
                    ZIndex: =3

                Label3_37 As label:
                    Height: =25
                    Size: =11
                    Text: ="Đơn vị quản lý HĐ (*)"
                    Width: =168
                    X: =355
                    Y: =95
                    ZIndex: =7

                cbxDVQLNHD As combobox:
                    BorderColor: =RGBA(72, 163, 62, 1)
                    DefaultSelectedItems: =LookUp(Filter(DM_PHAMVI_DIALYS,LOAI="DON_VI"),MA_PHAMVI=First(objHD).DONVI_QUANLY_HD)
                    DisplayFields: =["cr282_ten_phamvi","cr282_ma_phamvi"]
                    Height: =32
                    InputTextPlaceholder: ="Chọn đơn vị quản lý"
                    Items: =Filter(DM_PHAMVI_DIALYS,LOAI="DON_VI")
                    SearchFields: =["cr282_ten_phamvi"]
                    SearchItems: =Search(Filter(DM_PHAMVI_DIALYS,LOAI="DON_VI"),cbxDVQLNHD.SearchText,"cr282_ten_phamvi")
                    SelectMultiple: =false
                    Size: =11
                    Template: =ListItemTemplate.Double
                    Width: =250
                    X: =355
                    Y: =122
                    ZIndex: =8

                Label3_34 As label:
                    Height: =25
                    Size: =11
                    Text: ="Hiệu lực từ (*)"
                    Width: =140
                    X: =672
                    Y: =24
                    ZIndex: =9

                dpNgayHDNHD As datepicker:
                    BorderColor: =RGBA(72, 163, 62, 1)
                    DefaultDate: =If(IsBlank(First(objHD).MA_HOP_DONG),Today(),First(objHD).NGAY_HOP_DONG)
                    EndYear: =2200
                    Format: ="dd/mm/yyyy"
                    Height: =32
                    InputTextPlaceholder: =
                    IsEditable: =true
                    Size: =11
                    StartYear: =1900
                    Width: =250
                    X: =355
                    Y: =52
                    ZIndex: =13

                Label3_33 As label:
                    Height: =25
                    Size: =11
                    Text: ="Ngày hợp đồng (*)"
                    Width: =140
                    X: =355
                    Y: =24
                    ZIndex: =14

                dpHLTuNHD As datepicker:
                    BorderColor: =RGBA(72, 163, 62, 1)
                    DefaultDate: =First(objHD).HIEU_LUC_TU
                    EndYear: =2200
                    Format: ="dd/mm/yyyy"
                    Height: =32
                    InputTextPlaceholder: =
                    IsEditable: =true
                    OnChange: |-
                        =If(
                            IsBlank(dpHLDenNHD.SelectedDate),
                            UpdateIf(
                                objHD,
                                true,
                                {
                                    HIEU_LUC_DEN:DateAdd(dpHLTuNHD.SelectedDate,364,TimeUnit.Days)
                                }
                            )
                        )
                    Size: =11
                    StartYear: =1900
                    Width: =250
                    X: =672
                    Y: =52
                    ZIndex: =15

                dpHLDenNHD As datepicker:
                    BorderColor: =RGBA(72, 163, 62, 1)
                    DefaultDate: =First(objHD).HIEU_LUC_DEN
                    EndYear: =2200
                    Format: ="dd/mm/yyyy"
                    Height: =32
                    InputTextPlaceholder: =
                    IsEditable: =true
                    Size: =11
                    StartYear: =1900
                    Width: =250
                    X: =990
                    Y: =52
                    ZIndex: =16

                cbxDVTienNHD As combobox:
                    BorderColor: =RGBA(72, 163, 62, 1)
                    DefaultSelectedItems: =If(IsBlank(First(objHD).MA_HOP_DONG),LookUp(BH_DM_TIENTES,TIEN_TE="VND"),LookUp(BH_DM_TIENTES,TIEN_TE=First(objHD).DONVI_TIEN))
                    DisplayFields: =["cr282_tien_te"]
                    Height: =32
                    InputTextPlaceholder: ="Chọn đơn vị tiền"
                    Items: =BH_DM_TIENTES
                    SearchFields: =["cr282_id"]
                    SearchItems: =Search(BH_DM_TIENTES,cbxDVTienNHD.SearchText,"cr282_id")
                    SelectMultiple: =false
                    Size: =11
                    Width: =250
                    X: =672
                    Y: =122
                    ZIndex: =17

                Label3_38 As label:
                    Height: =25
                    Size: =11
                    Text: ="Đơn vị tiền (*)"
                    Width: =140
                    X: =672
                    Y: =95
                    ZIndex: =18

                Label3_36 As label:
                    FontWeight: =FontWeight.Bold
                    Height: =20
                    Size: =11
                    Text: ="1. Thông tin chung"
                    Width: =254
                    Y: =4
                    ZIndex: =19

                Label3_39 As label:
                    Height: =25
                    Size: =11
                    Text: ="Phương thức thanh toán"
                    Width: =190
                    X: =990
                    Y: =95
                    ZIndex: =20

                cbxPTTTNHD As combobox:
                    BorderColor: =RGBA(72, 163, 62, 1)
                    DefaultSelectedItems: |-
                        =LookUp([{title:"Tiền mặt",value:"0"},{title:"Chuyển khoản",value:"1"}],value=First(objHD).PTHUC_THANH_TOAN)
                    DisplayFields: =["title"]
                    Height: =32
                    InputTextPlaceholder: ="Chọn phương thức TT"
                    Items: |-
                        =[{title:"Tiền mặt",value:"0"},{title:"Chuyển khoản",value:"1"}]
                    SearchFields: =["title"]
                    SearchItems: |-
                        =Search([{title:"Tiền mặt",value:"0"},{title:"Chuyển khoản",value:"1"}],cbxPTTTNHD.SearchText,"title")
                    SelectMultiple: =false
                    Size: =11
                    Width: =250
                    X: =990
                    Y: =122
                    ZIndex: =21

                Label3_88 As label:
                    Height: =25
                    Size: =11
                    Text: ="Loại hợp đồng"
                    Width: =168
                    X: =30
                    Y: =95
                    ZIndex: =22

                ddLoaiHDNHD As dropdown:
                    BorderColor: =RGBA(54, 176, 75, 1)
                    Default: ="Lần đầu"
                    Height: =32
                    Items: |-
                        =[{title:"Lần đầu",value:"0"},{title:"Tái tục",value:"1"}]
                    Size: =11
                    Width: =250
                    X: =30
                    Y: =122
                    ZIndex: =24

            Container3_3 As groupContainer.manualLayoutContainer:
                Height: =99
                Width: =1267
                X: =16
                Y: =183
                ZIndex: =2

                Label3_41 As label:
                    Height: =25
                    Size: =11
                    Text: ="Loại kênh bán (*)"
                    Width: =137
                    X: =30
                    Y: =25
                    ZIndex: =1

                Label3_44 As label:
                    Height: =25
                    Size: =11
                    Text: ="Đơn vị kênh bán"
                    Width: =133
                    X: =990
                    Y: =25
                    ZIndex: =3

                Label3_43 As label:
                    Height: =25
                    Size: =11
                    Text: ="Tên kênh bán (*)"
                    Width: =140
                    X: =672
                    Y: =25
                    ZIndex: =9

                Label3_42 As label:
                    Height: =25
                    Size: =11
                    Text: ="Mã kênh bán (*)"
                    Width: =140
                    X: =355
                    Y: =25
                    ZIndex: =14

                Label3_40 As label:
                    FontWeight: =FontWeight.Bold
                    Height: =20
                    Size: =11
                    Text: ="2. Kênh bán"
                    Width: =254
                    Y: =4
                    ZIndex: =19

                tiTenKBNHD As text:
                    BorderColor: =RGBA(72, 163, 62, 1)
                    Default: =First(objHD).TEN_KENH_BAN
                    Height: =32
                    RadiusBottomLeft: =0
                    RadiusBottomRight: =0
                    RadiusTopLeft: =0
                    RadiusTopRight: =0
                    Size: =11
                    Width: =250
                    X: =672
                    Y: =52
                    ZIndex: =20

                cbxLoaiKBNHD As combobox:
                    BorderColor: =RGBA(72, 163, 62, 1)
                    DefaultSelectedItems: =LookUp(DM_LOAI_KENH_BANS,MA_LOAI_KB=First(objHD).LOAI_KENH_BAN)
                    DisplayFields: =["cr282_ten_loai_kb"]
                    Height: =32
                    InputTextPlaceholder: ="Chọn loại kênh bán"
                    Items: =DM_LOAI_KENH_BANS
                    OnChange: =Reset(cbxMaKBNHD)
                    SearchFields: =["cr282_ten_loai_kb"]
                    SearchItems: =Search(DM_LOAI_KENH_BANS,cbxLoaiKBNHD.SearchText,"cr282_ten_loai_kb")
                    SelectMultiple: =false
                    Size: =11
                    Width: =250
                    X: =30
                    Y: =52
                    ZIndex: =21

                cbxMaKBNHD As combobox:
                    BorderColor: =RGBA(72, 163, 62, 1)
                    DefaultSelectedItems: =LookUp(DM_KENH_BANS,MA_KENH_BAN=First(objHD).MA_KENH_BAN && LOAI=cbxLoaiKBNHD.Selected.MA_LOAI_KB)
                    DisplayFields: =["cr282_ma_kenh_ban","cr282_ten_kenh_ban"]
                    Height: =32
                    InputTextPlaceholder: ="Chọn mã kênh bán"
                    Items: =Filter(DM_KENH_BANS,LOAI=cbxLoaiKBNHD.Selected.MA_LOAI_KB)
                    OnChange: |-
                        =If(
                            IsBlank(unReloadCbxNHD),
                            UpdateIf(
                                objHD,
                                true,
                                {
                                    MA_KENH_BAN:cbxMaKBNHD.Selected.MA_KENH_BAN,
                                    TEN_KENH_BAN:LookUp(DM_KENH_BANS,MA_KENH_BAN=cbxMaKBNHD.Selected.MA_KENH_BAN,TEN_KENH_BAN)
                                }
                            );
                            UpdateContext({
                                nhomKB:If(
                                    LookUp(DM_LOAI_KENH_BANS,MA_LOAI_KB=cbxMaKBNHD.Selected.LOAI,CODE_KENH_BAN) in ["TT","CTV"],
                                    "0",
                                    LookUp(DM_LOAI_KENH_BANS,MA_LOAI_KB=cbxMaKBNHD.Selected.LOAI,CODE_KENH_BAN) in ["MG","BA"],
                                    "1",
                                    LookUp(DM_LOAI_KENH_BANS,MA_LOAI_KB=cbxMaKBNHD.Selected.LOAI,CODE_KENH_BAN) = "DL",
                                    cbxMaKBNHD.Selected.LOAI_CANHAN_TOCHUC
                                )
                            })
                        )
                    SearchFields: =["cr282_ma_kenh_ban"]
                    SearchItems: =Search(Filter(DM_KENH_BANS,LOAI=cbxLoaiKBNHD.Selected.MA_LOAI_KB),cbxMaKBNHD.SearchText,"cr282_ma_kenh_ban")
                    SelectMultiple: =false
                    Size: =11
                    Template: =ListItemTemplate.Double
                    Width: =250
                    X: =355
                    Y: =52
                    ZIndex: =22

                cbxDVKBNHD As combobox:
                    BorderColor: =RGBA(72, 163, 62, 1)
                    DefaultSelectedItems: =LookUp(DM_DON_VI,MA_DON_VI=First(objHD).DONVI_KENHBAN)
                    DisplayFields: =["cr282_ten_don_vi","cr282_ma_don_vi"]
                    Height: =32
                    InputTextPlaceholder: ="Chọn đơn vị kênh bán"
                    Items: =DM_DON_VI
                    SearchFields: =["cr282_ten_don_vi"]
                    SearchItems: =Search(DM_DON_VI,cbxDVKBNHD.SearchText,"cr282_ten_don_vi")
                    SelectMultiple: =false
                    Size: =11
                    Template: =ListItemTemplate.Double
                    Width: =250
                    X: =990
                    Y: =52
                    ZIndex: =23

            Container3_4 As groupContainer.manualLayoutContainer:
                Height: =239
                Width: =1267
                X: =16
                Y: =282
                ZIndex: =3

                Label3_46 As label:
                    Height: =25
                    Size: =11
                    Text: ="Mã khách hàng (*)"
                    Width: =137
                    X: =30
                    Y: =25
                    ZIndex: =1

                Label3_49 As label:
                    Height: =25
                    Size: =11
                    Text: ="Ngày sinh/Thành lập"
                    Width: =160
                    X: =30
                    Y: =92
                    ZIndex: =3

                Label3_48 As label:
                    Height: =25
                    Size: =11
                    Text: ="Địa chỉ"
                    Width: =83
                    X: =672
                    Y: =25
                    ZIndex: =9

                Label3_47 As label:
                    Height: =25
                    Size: =11
                    Text: ="Tên khách hàng (*)"
                    Width: =140
                    X: =355
                    Y: =25
                    ZIndex: =14

                dpNSinhNHD As datepicker:
                    BorderColor: =RGBA(72, 163, 62, 1)
                    DefaultDate: =First(objHD).NGAY_SINH
                    EndYear: =2200
                    Format: ="dd/mm/yyyy"
                    Height: =32
                    InputTextPlaceholder: =
                    IsEditable: =true
                    Size: =11
                    StartYear: =1900
                    Width: =250
                    X: =30
                    Y: =120
                    ZIndex: =16

                Label3_45 As label:
                    FontWeight: =FontWeight.Bold
                    Height: =20
                    Size: =11
                    Text: ="3. Khách hàng"
                    Width: =254
                    Y: =4
                    ZIndex: =19

                tiDChiNHD As text:
                    BorderColor: =RGBA(72, 163, 62, 1)
                    Default: =First(objHD).DIA_CHI
                    Height: =32
                    RadiusBottomLeft: =0
                    RadiusBottomRight: =0
                    RadiusTopLeft: =0
                    RadiusTopRight: =0
                    Size: =11
                    Width: =250
                    X: =672
                    Y: =52
                    ZIndex: =20

                cbxMaKHNHD As combobox:
                    BorderColor: =RGBA(72, 163, 62, 1)
                    DefaultSelectedItems: =LookUp(DM_KHACH_HANG,MA_KHACH_HANG=First(objHD).MA_KHACH_HANG)
                    DisplayFields: =["cr282_ma_khach_hang","cr282_ten_khach_hang"]
                    Height: =32
                    InputTextPlaceholder: ="Chọn mã khách hàng"
                    Items: =DM_KHACH_HANG
                    OnChange: |-
                        =If(
                            IsBlank(unReloadCbxNHD),
                            UpdateIf(
                                objHD,
                                true,
                                {
                                    MA_KHACH_HANG:cbxMaKHNHD.Selected.MA_KHACH_HANG,
                                    TEN_KHACH_HANG:LookUp(DM_KHACH_HANG,MA_KHACH_HANG=cbxMaKHNHD.Selected.MA_KHACH_HANG,TEN_KHACH_HANG),
                                    DIA_CHI:LookUp(DM_KHACH_HANG,MA_KHACH_HANG=cbxMaKHNHD.Selected.MA_KHACH_HANG,DIA_CHI_KH),
                                    NGAY_SINH:LookUp(DM_KHACH_HANG,MA_KHACH_HANG=cbxMaKHNHD.Selected.MA_KHACH_HANG,NGAY_SINH),
                                    GIOI_TINH:LookUp(DM_KHACH_HANG,MA_KHACH_HANG=cbxMaKHNHD.Selected.MA_KHACH_HANG,MA_GIOI_TINH),
                                    SO_DIEN_THOAI:LookUp(DM_KHACH_HANG,MA_KHACH_HANG=cbxMaKHNHD.Selected.MA_KHACH_HANG,SDT_KHACH_HANG),
                                    EMAIL:LookUp(DM_KHACH_HANG,MA_KHACH_HANG=cbxMaKHNHD.Selected.MA_KHACH_HANG,EMAIL),
                                    LOAI_KHACH_HANG:LookUp(DM_KHACH_HANG,MA_KHACH_HANG=cbxMaKHNHD.Selected.MA_KHACH_HANG,LOAI_KHACH_HANG),
                                    NGHE_NGHIEP:LookUp(DM_KHACH_HANG,MA_KHACH_HANG=cbxMaKHNHD.Selected.MA_KHACH_HANG,NGANH_NGHE),
                                    TINH_TP_KH:LookUp(DM_KHACH_HANG,MA_KHACH_HANG=cbxMaKHNHD.Selected.MA_KHACH_HANG,MA_TINH),
                                    NHOM_KHACH_HANG:LookUp(DM_KHACH_HANG,MA_KHACH_HANG=cbxMaKHNHD.Selected.MA_KHACH_HANG,MA_NHOM_KH)
                                }
                            );
                            If(
                                LookUp(DM_KHACH_HANG,MA_KHACH_HANG=cbxMaKHNHD.Selected.MA_KHACH_HANG,LOAI_KHACH_HANG)="0",
                                ClearCollect(
                                    dmKhachHangNHDCollect,
                                    RenameColumns(
                                        ShowColumns(
                                            DM_NGHE_NGHIEP,
                                            "cr282_ma_nghe_nghiep",
                                            "cr282_ten_nghe_nghiep"
                                        ),
                                        "cr282_ma_nghe_nghiep",
                                        "value",
                                        "cr282_ten_nghe_nghiep",
                                        "title"
                                    )
                                ),
                                ClearCollect(
                                    dmKhachHangNHDCollect,
                                    RenameColumns(
                                        ShowColumns(
                                            BH_DM_NGANHNGHES,
                                            "cr282_ma_nhom_nganh",
                                            "cr282_ten_nganh"
                                        ),
                                        "cr282_ma_nhom_nganh",
                                        "value",
                                        "cr282_ten_nganh",
                                        "title"
                                    )
                                )
                            );
                            Reset(cbxNgheNHD);
                            If(
                                !IsBlank(First(objHD).TEN_KHACH_HANG_SAVED) && !IsBlank(First(objHD).MA_KHACH_HANG) && First(objHD).MA_KHACH_HANG<>First(objHD).TEN_KHACH_HANG_SAVED,
                                Refresh(DL_HOP_DONG_SP_NDBH);
                                RemoveIf(DL_HOP_DONG_SP_NDBH,MA_HOP_DONG=First(objHD).MA_HOP_DONG);
                                Clear(tmpDSNDBHNHDCollect);
                                UpdateIf(
                                    DL_HOP_DONG_SPS,
                                    MA_HOP_DONG=First(objHD).MA_HOP_DONG,
                                    {
                                        AUTO_GEN_NDBH:Blank(),
                                        SONGUOI_THAMGIA:0,
                                        TONG_TIEN_PHI:0,
                                        TONG_PHI_DANHSACH:0
                                    }
                                );
                                ClearCollect(
                                    tmpDSHDSPNHDCollect1,
                                    tmpDSHDSPNHDCollect
                                );
                                UpdateIf(
                                    tmpDSHDSPNHDCollect,
                                    MA_HOP_DONG=First(objHD).MA_HOP_DONG,
                                    {
                                        AUTO_GEN_NDBH:Blank(),
                                        SONGUOI_THAMGIA:0,
                                        TONG_TIEN_PHI:0,
                                        TONG_PHI_DANHSACH:0
                                    }
                                );
                                ClearCollect(
                                    tmpMaCTChangeNHD,
                                    tmpDSHDSPNHDCollect
                                );
                                UpdateIf(
                                    objHD,
                                    true,
                                    {
                                        SO_NGUOI_TGIA:"0"
                                    }
                                );
                                UpdateIf(
                                    DL_HOP_DONGS,
                                    MA_HOP_DONG=First(objHD).MA_HOP_DONG,
                                    {
                                        DIA_CHI: tiDChiNHD.Text,
                                        EMAIL: tiEmailNHD.Text,
                                        GIOI_TINH: cbxGTinhNHD.Selected.MA_GIOI_TINH,
                                        LOAI_KHACH_HANG: cbxLoaiKHNHD.Selected.value,
                                        MA_KHACH_HANG: cbxMaKHNHD.Selected.MA_KHACH_HANG,
                                        NGAY_SINH: dpNSinhNHD.SelectedDate,
                                        NGHE_NGHIEP: cbxNgheNHD.Selected.value,
                                        SO_DIEN_THOAI: tiSDTNHD.Text,
                                        TEN_KHACH_HANG: tiTenKHNHD.Text,
                                        TINH_TP_KH: cbxTinhNHD.Selected.MA_PHAMVI,
                                        NHOM_KHACH_HANG: cbxNhomKHNHD.Selected.MA_NHOM_KH,
                                        TEN_KHACH_HANG_SAVED:cbxMaKHNHD.Selected.MA_KHACH_HANG,
                                        SO_NGUOI_TGIA:"0"
                                    }
                                )
                            )
                        )
                    OnSelect: |-
                        =UpdateContext({
                            checkChangeKH1:"1"
                        })
                    SearchFields: =["cr282_ma_khach_hang"]
                    SearchItems: =Search(DM_KHACH_HANG,cbxMaKHNHD.SearchText,"cr282_ma_khach_hang")
                    SelectMultiple: =false
                    Size: =11
                    Template: =ListItemTemplate.Double
                    Width: =250
                    X: =30
                    Y: =52
                    ZIndex: =21

                tiTenKHNHD As text:
                    BorderColor: =RGBA(72, 163, 62, 1)
                    Default: =First(objHD).TEN_KHACH_HANG
                    Height: =32
                    RadiusBottomLeft: =0
                    RadiusBottomRight: =0
                    RadiusTopLeft: =0
                    RadiusTopRight: =0
                    Size: =11
                    Width: =250
                    X: =355
                    Y: =52
                    ZIndex: =22

                cbxGTinhNHD As combobox:
                    BorderColor: =RGBA(72, 163, 62, 1)
                    DefaultSelectedItems: =LookUp(DM_GIOI_TINHS,MA_GIOI_TINH=First(objHD).GIOI_TINH)
                    DisplayFields: =["cr282_ten_gioi_tinh"]
                    Height: =32
                    InputTextPlaceholder: ="Chọn giới tính"
                    Items: =DM_GIOI_TINHS
                    SearchFields: =["cr282_ten_gioi_tinh"]
                    SearchItems: =Search(DM_GIOI_TINHS,cbxGTinhNHD.SearchText,"cr282_ten_gioi_tinh")
                    SelectMultiple: =false
                    Size: =11
                    Width: =250
                    X: =355
                    Y: =120
                    ZIndex: =23

                Label3_50 As label:
                    Height: =25
                    Size: =11
                    Text: ="Giới tính"
                    Width: =83
                    X: =355
                    Y: =92
                    ZIndex: =24

                tiSDTNHD As text:
                    BorderColor: =RGBA(72, 163, 62, 1)
                    Default: =First(objHD).SO_DIEN_THOAI
                    Height: =32
                    RadiusBottomLeft: =0
                    RadiusBottomRight: =0
                    RadiusTopLeft: =0
                    RadiusTopRight: =0
                    Size: =11
                    Width: =250
                    X: =672
                    Y: =120
                    ZIndex: =25

                tiEmailNHD As text:
                    BorderColor: =RGBA(72, 163, 62, 1)
                    Default: =First(objHD).EMAIL
                    Height: =32
                    RadiusBottomLeft: =0
                    RadiusBottomRight: =0
                    RadiusTopLeft: =0
                    RadiusTopRight: =0
                    Size: =11
                    Width: =250
                    X: =990
                    Y: =120
                    ZIndex: =26

                tiSoNTGNHD As text:
                    Align: =Align.Right
                    BorderColor: =RGBA(72, 163, 62, 1)
                    Default: =If(IsBlank(First(objHD).SO_NGUOI_TGIA),0,First(objHD).SO_NGUOI_TGIA)
                    DisplayMode: =DisplayMode.Disabled
                    Height: =32
                    RadiusBottomLeft: =0
                    RadiusBottomRight: =0
                    RadiusTopLeft: =0
                    RadiusTopRight: =0
                    Size: =11
                    Width: =250
                    X: =990
                    Y: =190
                    ZIndex: =27

                cbxNgheNHD As combobox:
                    BorderColor: =RGBA(72, 163, 62, 1)
                    DefaultSelectedItems: =LookUp(dmKhachHangNHDCollect,value=First(objHD).NGHE_NGHIEP)
                    DisplayFields: =["title"]
                    Height: =32
                    InputTextPlaceholder: =
                    Items: =SortByColumns(dmKhachHangNHDCollect,"value",SortOrder.Ascending)
                    SearchFields: =["title"]
                    SearchItems: =Search(SortByColumns(dmKhachHangNHDCollect,"value",SortOrder.Ascending),cbxNgheNHD.SearchText,"title")
                    SelectMultiple: =false
                    Size: =11
                    Width: =250
                    X: =672
                    Y: =190
                    ZIndex: =28

                Label3_51 As label:
                    Height: =25
                    Size: =11
                    Text: ="Số điện thoại"
                    Width: =140
                    X: =672
                    Y: =92
                    ZIndex: =29

                Label3_52 As label:
                    Height: =25
                    Size: =11
                    Text: ="Email"
                    Width: =83
                    X: =990
                    Y: =92
                    ZIndex: =30

                cbxLoaiKHNHD As combobox:
                    BorderColor: =RGBA(72, 163, 62, 1)
                    DefaultSelectedItems: |-
                        =LookUp([{title:"Cá nhân",value:"0"},{title:"Tổ chức",value:"1"}],value=First(objHD).LOAI_KHACH_HANG)
                    DisplayFields: =["title"]
                    Height: =32
                    InputTextPlaceholder: ="Chọn loại khách hàng"
                    IsSearchable: =false
                    Items: |-
                        =[{title:"Cá nhân",value:"0"},{title:"Tổ chức",value:"1"}]
                    SearchFields: =["title"]
                    SearchItems: =[]
                    SelectMultiple: =false
                    Size: =11
                    Width: =250
                    X: =30
                    Y: =190
                    ZIndex: =31

                Label3_53 As label:
                    Height: =25
                    Size: =11
                    Text: ="Loại khách hàng"
                    Width: =140
                    X: =30
                    Y: =162
                    ZIndex: =32

                Label3_54 As label:
                    Height: =25
                    Size: =11
                    Text: ="Nghề nghiệp/Nhóm nghề"
                    Width: =200
                    X: =672
                    Y: =162
                    ZIndex: =33

                Label3_55 As label:
                    Height: =25
                    Size: =11
                    Text: ="Tổng số người tham gia"
                    Width: =200
                    X: =990
                    Y: =162
                    ZIndex: =34

                cbxTinhNHD As combobox:
                    BorderColor: =RGBA(72, 163, 62, 1)
                    DefaultSelectedItems: =LookUp(Filter(DM_PHAMVI_DIALYS,LOAI="TINH_TP"),MA_PHAMVI=First(objHD).TINH_TP_KH)
                    DisplayFields: =["cr282_ten_phamvi"]
                    Height: =32
                    InputTextPlaceholder: ="Chọn tỉnh/thành phố"
                    Items: =Filter(DM_PHAMVI_DIALYS,LOAI="TINH_TP")
                    SearchFields: =["cr282_ma_phamvi"]
                    SearchItems: =Search(Filter(DM_PHAMVI_DIALYS,LOAI="TINH_TP"),cbxTinhNHD.SearchText,"cr282_ma_phamvi")
                    SelectMultiple: =false
                    Size: =11
                    Width: =250
                    X: =990
                    Y: =52
                    ZIndex: =35

                Label3_57 As label:
                    Height: =25
                    Size: =11
                    Text: ="Tỉnh/TP"
                    Width: =83
                    X: =990
                    Y: =25
                    ZIndex: =36

                cbxNhomKHNHD As combobox:
                    BorderColor: =RGBA(72, 163, 62, 1)
                    DefaultSelectedItems: =LookUp(DM_NHOM_KH,MA_NHOM_KH=First(objHD).NHOM_KHACH_HANG)
                    DisplayFields: =["cr282_ten_nhom_kh"]
                    Height: =32
                    InputTextPlaceholder: ="Chọn loại khách hàng"
                    IsSearchable: =false
                    Items: =DM_NHOM_KH
                    SearchFields: =["cr282_ten_nhom_kh"]
                    SearchItems: =[]
                    SelectMultiple: =false
                    Size: =11
                    Width: =250
                    X: =355
                    Y: =190
                    ZIndex: =37

                Label3_56 As label:
                    Height: =25
                    Size: =11
                    Text: ="Nhóm khách hàng"
                    Width: =140
                    X: =355
                    Y: =162
                    ZIndex: =38

            Container3_5 As groupContainer.manualLayoutContainer:
                Height: =257
                Width: =1267
                X: =16
                Y: =521
                ZIndex: =4

                Label3_58 As label:
                    FontWeight: =FontWeight.Bold
                    Height: =20
                    Size: =11
                    Text: ="4. Sản phẩm"
                    Width: =254
                    Y: =4
                    ZIndex: =19

                Gallery3_2 As gallery.variableTemplateHeightGallery:
                    DelayItemLoading: =true
                    Height: =184
                    Items: |-
                        =SortByColumns(
                            tmpDSHDSPNHDCollect,
                            "cr282_id",
                            SortOrder.Ascending
                        )
                    Layout: =Layout.Vertical
                    LoadingSpinner: =LoadingSpinner.Data
                    TemplateSize: =184
                    Width: =1267
                    Y: =70
                    ZIndex: =21

                    Label3_59 As label:
                        Height: =25
                        Size: =11
                        Text: ="Mã sản phẩm (*)"
                        Width: =130
                        X: =30
                        Y: =6
                        ZIndex: =2

                    Label3_61 As label:
                        Height: =25
                        Size: =11
                        Text: ="Tên chương trình"
                        Width: =140
                        X: =990
                        Y: =6
                        ZIndex: =3

                    Label3_62 As label:
                        Height: =25
                        Size: =11
                        Text: ="Mã chương trình (*)"
                        Width: =160
                        X: =672
                        Y: =6
                        ZIndex: =4

                    Label3_60 As label:
                        Height: =25
                        Size: =11
                        Text: ="Tên sản phẩm"
                        Width: =140
                        X: =355
                        Y: =6
                        ZIndex: =5

                    tiSoNTGSPNHD As text:
                        Align: =Align.Right
                        BorderColor: =RGBA(72, 163, 62, 1)
                        Default: |-
                            =If (
                                ThisItem.edited=1,
                                LookUp(tmpMaCTChangeNHD,ID=ThisItem.ID,SONGUOI_THAMGIA),
                                ThisItem.SONGUOI_THAMGIA
                            )
                        DisplayMode: =DisplayMode.Disabled
                        Format: =TextFormat.Number
                        Height: =32
                        RadiusBottomLeft: =0
                        RadiusBottomRight: =0
                        RadiusTopLeft: =0
                        RadiusTopRight: =0
                        Size: =11
                        Width: =250
                        X: =672
                        Y: =102
                        ZIndex: =7

                    tiTongPhiNHD As text:
                        Align: =Align.Right
                        BorderColor: =RGBA(72, 163, 62, 1)
                        Default: |-
                            =If (
                                ThisItem.edited=1,
                                LookUp(tmpMaCTChangeNHD,ID=ThisItem.ID,TONG_TIEN_PHI),
                                ThisItem.TONG_TIEN_PHI
                            )
                        DisplayMode: =DisplayMode.Disabled
                        Format: =TextFormat.Number
                        Height: =32
                        RadiusBottomLeft: =0
                        RadiusBottomRight: =0
                        RadiusTopLeft: =0
                        RadiusTopRight: =0
                        Size: =11
                        Width: =250
                        X: =990
                        Y: =102
                        ZIndex: =8

                    Label3_64 As label:
                        Height: =25
                        Size: =11
                        Text: ="Số người tham gia"
                        Width: =140
                        X: =672
                        Y: =74
                        ZIndex: =9

                    Label3_65 As label:
                        Height: =25
                        Size: =11
                        Text: ="Tổng phí/Nhóm"
                        Width: =140
                        X: =990
                        Y: =74
                        ZIndex: =10

                    tiTenSPNHD As text:
                        BorderColor: =RGBA(72, 163, 62, 1)
                        Default: =LookUp(DL_SAN_PHAM,MA_SAN_PHAM=cbxMaSPNHD.Selected.MA_SAN_PHAM,TEN_SAN_PHAM)
                        DisplayMode: =DisplayMode.Disabled
                        Height: =32
                        RadiusBottomLeft: =0
                        RadiusBottomRight: =0
                        RadiusTopLeft: =0
                        RadiusTopRight: =0
                        Size: =11
                        Width: =250
                        X: =355
                        Y: =34
                        ZIndex: =11

                    tiTenCTNHD As text:
                        BorderColor: =RGBA(72, 163, 62, 1)
                        Default: =LookUp(' DL_SAN_PHAM_CT',MA_SAN_PHAM=cbxMaSPNHD.Selected.MA_SAN_PHAM && MA_CHUONG_TRINH=cbxMaCTNHD.Selected.MA_CHUONG_TRINH,TEN_CHUONG_TRINH)
                        DisplayMode: =DisplayMode.Disabled
                        Height: =32
                        RadiusBottomLeft: =0
                        RadiusBottomRight: =0
                        RadiusTopLeft: =0
                        RadiusTopRight: =0
                        Size: =11
                        Width: =250
                        X: =990
                        Y: =34
                        ZIndex: =12

                    cbxMaCTNHD As combobox:
                        BorderColor: =RGBA(72, 163, 62, 1)
                        DefaultSelectedItems: |-
                            =/*If (
                                ThisItem.edited=1,
                                LookUp(
                                    ' DL_SAN_PHAM_CT',
                                    MA_SAN_PHAM=cbxMaSPNHD.Selected.MA_SAN_PHAM && MA_CHUONG_TRINH=tiMaCTNHD.Text
                                ),
                                LookUp(
                                    ' DL_SAN_PHAM_CT',
                                    MA_SAN_PHAM=cbxMaSPNHD.Selected.MA_SAN_PHAM && MA_CHUONG_TRINH=ThisItem.MA_CHUONG_TRINH
                                )
                            )*/
                            
                            LookUp(
                                ' DL_SAN_PHAM_CT',
                                MA_SAN_PHAM=LookUp(tmpMaCTChangeNHD,ID=ThisItem.ID,MA_SAN_PHAM) && MA_CHUONG_TRINH=LookUp(tmpMaCTChangeNHD,ID=ThisItem.ID,MA_CHUONG_TRINH)
                            )
                        DisplayFields: =["cr282_ma_chuongtrinh","cr282_ten_chuong_trinh"]
                        Height: =32
                        InputTextPlaceholder: =""
                        Items: =Filter(' DL_SAN_PHAM_CT',MA_SAN_PHAM=cbxMaSPNHD.Selected.MA_SAN_PHAM)
                        OnChange: |-
                            =If(
                                cbxMaCTNHD.Selected.MA_CHUONG_TRINH<>ThisItem.MA_CHUONG_TRINH && IsBlank(unReloadMaCT),
                                UpdateIf(
                                    tmpMaCTChangeNHD,
                                    ID=ThisItem.ID,
                                    {
                                        NHOM_TINH_PHI:Blank()
                                    }
                                );
                                Reset(cbxNhomTPNHD);
                            );
                        OnSelect: |-
                            =UpdateContext({
                                unReloadMaSP:Blank(),
                                unReloadMaCT:Blank()
                            })
                        SearchFields: =["cr282_ma_chuong_trinh"]
                        SearchItems: =Search(Filter(' DL_SAN_PHAM_CT',MA_SAN_PHAM=cbxMaSPNHD.Selected.MA_SAN_PHAM),cbxMaCTNHD.SearchText,"cr282_ma_chuong_trinh")
                        SelectMultiple: =false
                        Size: =11
                        Template: =ListItemTemplate.Double
                        Width: =250
                        X: =672
                        Y: =34
                        ZIndex: =14

                    cbxMaSPNHD As combobox:
                        BorderColor: =RGBA(72, 163, 62, 1)
                        DefaultSelectedItems: =LookUp(DL_SAN_PHAM,MA_SAN_PHAM=ThisItem.MA_SAN_PHAM)
                        DisplayFields: =["cr282_ma_san_pham","cr282_ten_san_pham"]
                        DisplayMode: =If(ThisItem.edited=1,DisplayMode.Edit,DisplayMode.Disabled)
                        Height: =32
                        InputTextPlaceholder: =""
                        Items: =DL_SAN_PHAM
                        OnChange: |-
                            =If(
                                cbxMaSPNHD.Selected.MA_SAN_PHAM<>ThisItem.MA_SAN_PHAM && IsBlank(unReloadMaSP),
                                UpdateIf(
                                    tmpMaCTChangeNHD,
                                    ID=ThisItem.ID,
                                    {
                                        MA_SAN_PHAM:cbxMaSPNHD.Selected.MA_SAN_PHAM,
                                        MA_CHUONG_TRINH:Blank(),
                                        NHOM_TINH_PHI:Blank()
                                    }
                                );
                                Reset(cbxMaCTNHD);Reset(cbxNhomTPNHD);
                            );
                        OnSelect: |-
                            =UpdateContext({
                                unReloadMaSP:Blank(),
                                unReloadMaCT:Blank()
                            })
                        SearchFields: =["cr282_ma_san_pham"]
                        SearchItems: =Search(DL_SAN_PHAM,cbxMaSPNHD.SearchText,"cr282_ma_san_pham")
                        SelectMultiple: =false
                        Size: =11
                        Template: =ListItemTemplate.Double
                        Width: =250
                        X: =30
                        Y: =34
                        ZIndex: =15

                    btnXoaHDSPNHD As button:
                        Height: =32
                        OnSelect: |-
                            =If(
                                Or(maAddedHDSPNHD<>"",maUpdatedHDSPNHD<>""),
                                Notify("Có dữ liệu chưa được lưu",NotificationType.Warning,2000),
                                Refresh(DL_HOP_DONG_SP_NDBH);
                                RemoveIf(DL_HOP_DONG_SP_NDBH,MA_HOP_DONG=First(objHD).MA_HOP_DONG && ID_HOPDONG_SP=ThisItem.ID);
                                RemoveIf(tmpDSNDBHNHDCollect,ID_HOPDONG_SP=ThisItem.ID);
                                
                                Refresh(DL_HOP_DONG_SP_QLCT);
                                RemoveIf(DL_HOP_DONG_SP_QLCT,MA_HOP_DONG=First(objHD).MA_HOP_DONG && ID_HOPDONG_SP=ThisItem.ID);
                                RemoveIf(tmpDSNDBHNHDCollect,ID_HOPDONG_SP=ThisItem.ID);
                            
                                Refresh(DL_HOP_DONG_SPS);
                                RemoveIf(DL_HOP_DONG_SPS,ID=ThisItem.ID);
                                RemoveIf(tmpDSHDSPNHDCollect,ID=ThisItem.ID);
                                Notify("Xóa dữ liệu thành công", NotificationType.Success,2000);
                                UpdateIf(
                                    objHD,
                                    true,
                                    {
                                        SO_NGUOI_TGIA:Sum(tmpDSHDSPNHDCollect,SONGUOI_THAMGIA)
                                    }
                                );
                                UpdateIf(
                                    DL_HOP_DONG_SPS,
                                    MA_HOP_DONG=First(objHD).MA_HOP_DONG,
                                    {
                                        SO_NGUOI_TGIA:Sum(tmpDSHDSPNHDCollect,SONGUOI_THAMGIA)
                                    }
                                );
                            )
                        Size: =11
                        Text: ="Xóa"
                        Visible: =ThisItem.edited=0
                        Width: =90
                        X: =1100
                        Y: =143
                        ZIndex: =16

                    btnLuuHDSPNHD As button:
                        Height: =32
                        OnSelect: |
                            =If(
                                IsBlank(cbxMaSPNHD.Selected.MA_SAN_PHAM),
                                Notify("Bắt buộc chọn sản phẩm",NotificationType.Error,2000),
                                IsBlank(cbxMaCTNHD.Selected.MA_CHUONG_TRINH),
                                Notify("Bắt buộc chọn chương trình",NotificationType.Error,2000),
                                IsEmpty(cbxNhomTPNHD.SelectedItems),
                                Notify("Bắt buộc chọn nhóm tính phí",NotificationType.Error,2000),
                                UpdateContext({
                                    unReloadMaSP:"1"
                                });
                                If(
                                    ThisItem.ID=maAddedHDSPNHD,
                                    Patch(
                                        DL_HOP_DONG_SPS,
                                        {
                                            ID: ThisItem.ID,
                                            MA_HOP_DONG: First(objHD).MA_HOP_DONG,
                                            MA_SAN_PHAM: cbxMaSPNHD.Selected.MA_SAN_PHAM,
                                            MA_CHUONG_TRINH: cbxMaCTNHD.Selected.MA_CHUONG_TRINH,
                                            TEN_CHUONG_TRINH: tiTenCTNHD.Text,
                                            TEN_SAN_PHAM: tiTenSPNHD.Text,
                                            DON_VI_TINH: cbxDVTienNHD.Selected.TIEN_TE,
                                            SONGUOI_THAMGIA: Value(tiSoNTGSPNHD.Text),
                                            TONG_TIEN_PHI: Value(tiTongPhiNHD.Text),
                                            MA_KENH_BAN: cbxMaKBNHD.Selected.MA_KENH_BAN,
                                            MA_KHACH_HANG: cbxMaKHNHD.Selected.MA_KHACH_HANG,
                                            NGAY_HOP_DONG: dpNgayHDNHD.SelectedDate,
                                            NHOM_TINH_PHI: Concat(
                                                cbxNhomTPNHD.SelectedItems,
                                                Value,
                                                "|"
                                            ),
                                            PHI_DIEU_CHINH:Value(tiPhiDCNHD.Text),
                                            TONG_PHI_DANHSACH:LookUp(tmpMaCTChangeNHD,ID=ThisItem.ID,TONG_PHI_DANHSACH),
                                            AUTO_GEN_NDBH:LookUp(tmpMaCTChangeNHD,ID=ThisItem.ID,AUTO_GEN_NDBH)
                                        }
                                    ),
                                    ThisItem.ID=maUpdatedHDSPNHD,
                                    UpdateIf(
                                        DL_HOP_DONG_SPS,
                                        ID = ThisItem.ID,
                                        {
                                            MA_SAN_PHAM:cbxMaSPNHD.Selected.MA_SAN_PHAM,
                                            TEN_SAN_PHAM:tiTenSPNHD.Text,
                                            MA_CHUONG_TRINH:cbxMaCTNHD.Selected.MA_CHUONG_TRINH,
                                            TEN_CHUONG_TRINH:tiTenCTNHD.Text,
                                            SONGUOI_THAMGIA: Value(tiSoNTGSPNHD.Text),
                                            TONG_TIEN_PHI: Value(tiTongPhiNHD.Text),
                                            MA_KENH_BAN: cbxMaKBNHD.Selected.MA_KENH_BAN,
                                            MA_KHACH_HANG: cbxMaKHNHD.Selected.MA_KHACH_HANG,
                                            NGAY_HOP_DONG: dpNgayHDNHD.SelectedDate,
                                            NHOM_TINH_PHI: Concat(
                                                cbxNhomTPNHD.SelectedItems,
                                                Value,
                                                "|"
                                            ),
                                            PHI_DIEU_CHINH:Value(tiPhiDCNHD.Text),
                                            TONG_PHI_DANHSACH:LookUp(tmpMaCTChangeNHD,ID=ThisItem.ID,TONG_PHI_DANHSACH),
                                            AUTO_GEN_NDBH:LookUp(tmpMaCTChangeNHD,ID=ThisItem.ID,AUTO_GEN_NDBH)
                                        }
                                    )
                                );
                                UpdateIf(
                                    tmpDSHDSPNHDCollect,
                                    ID=ThisItem.ID,
                                    {
                                        MA_SAN_PHAM:cbxMaSPNHD.Selected.MA_SAN_PHAM,
                                        TEN_SAN_PHAM:tiTenSPNHD.Text,
                                        MA_CHUONG_TRINH:cbxMaCTNHD.Selected.MA_CHUONG_TRINH,
                                        TEN_CHUONG_TRINH:tiTenCTNHD.Text,
                                        PTHUC_THANH_TOAN:cbxPTTTNHD.Selected.value,
                                        SONGUOI_THAMGIA:Value(tiSoNTGSPNHD.Text),
                                        TONG_TIEN_PHI:Value(tiTongPhiNHD.Text),
                                        NHOM_TINH_PHI:Concat(cbxNhomTPNHD.SelectedItems, Value,"|"),
                                        PHI_DIEU_CHINH:Value(tiPhiDCNHD.Text),
                                        TONG_PHI_DANHSACH:LookUp(tmpMaCTChangeNHD,ID=ThisItem.ID,TONG_PHI_DANHSACH),
                                        AUTO_GEN_NDBH:LookUp(tmpMaCTChangeNHD,ID=ThisItem.ID,AUTO_GEN_NDBH),
                                        edited:0
                                    }
                                );
                                Refresh(DL_HOP_DONG_SP_NDBH);
                                RemoveIf(
                                    DL_HOP_DONG_SP_NDBH,
                                    MA_HOP_DONG=First(objHD).MA_HOP_DONG && ID_HOPDONG_SP=ThisItem.ID
                                );
                                ForAll(
                                    Filter(
                                        tmpDSNDBHNHDCollect,
                                        ID_HOPDONG_SP=ThisItem.ID
                                    ) As ds,
                                    Patch(
                                        DL_HOP_DONG_SP_NDBH,
                                        {
                                            ID:ds.ID,
                                            MA_HOP_DONG:First(objHD).MA_HOP_DONG,
                                            MA_SAN_PHAM:ThisItem.MA_SAN_PHAM,
                                            MA_CHUONG_TRINH:ThisItem.MA_CHUONG_TRINH,
                                            NHOM_TINH_PHI:ThisItem.NHOM_TINH_PHI,
                                            TEN_NDBH:ds.TEN_NDBH,
                                            MST:ds.MST,
                                            DIA_CHI:ds.DIA_CHI,
                                            MA_GIOI__TINH:ds.MA_GIOI__TINH,
                                            MA_TINH_TP: ds.MA_TINH_TP,
                                            MA_NHAN_VIEN: ds.MA_NHAN_VIEN,
                                            MOI_QUAN_HE: ds.MOI_QUAN_HE,
                                            NGAY_SINH: ds.NGAY_SINH,
                                            NHOM: ds.NHOM,
                                            SO_GIAY_TO: ds.SO_GIAY_TO,
                                            PHI_NDBH: ds.PHI_NDBH,
                                            ID_HOPDONG_SP:ThisItem.ID
                                        }
                                    )
                                );
                                UpdateIf(
                                    DL_HOP_DONGS,
                                    MA_HOP_DONG=First(objHD).MA_HOP_DONG,
                                    {
                                        SO_NGUOI_TGIA:Value(tiSoNTGNHD.Text)
                                    }
                                );
                                Refresh(DL_HOP_DONG_SP_QLCT);
                                ClearCollect(
                                    tmpDSQLCTRemoveNHDCollect,
                                    Filter(
                                        DL_HOP_DONG_SP_QLCT,
                                        MA_HOP_DONG=First(objHD).MA_HOP_DONG && ID_HOPDONG_SP=ThisItem.ID
                                    )
                                );
                                ForAll(
                                    tmpDSQLCTRemoveNHDCollect As ds,
                                    Remove(
                                        DL_HOP_DONG_SP_QLCT,
                                        ds
                                    )
                                );
                                ForAll(
                                    Filter(
                                        tmpQLCTHDSPNHDCollect,
                                        ID_HOPDONG_SP=ThisItem.ID
                                    ) As ds,
                                    Patch(
                                        DL_HOP_DONG_SP_QLCT,
                                        {
                                            MA_HOP_DONG:First(objHD).MA_HOP_DONG,
                                            MA_SAN_PHAM:ThisItem.MA_SAN_PHAM,
                                            MA_CHUONG_TRINH:ThisItem.MA_CHUONG_TRINH,
                                            NHOM_TINH_PHI:ThisItem.NHOM_TINH_PHI,
                                            ID_HOPDONG_SP:ThisItem.ID,
                                            MA_QL_CT:ds.MA_QL_CT,
                                            MA_NHOM_QL:ds.MA_NHOM_QL,
                                            TT_HIENTHI:ds.TT_HIENTHI,
                                            GH_SOLAN_NAM:ds.GH_SOLAN_NAM,
                                            GH_SONGAY_NAM:ds.GH_SONGAY_NAM,
                                            GH_SOTIEN_BENH: ds.GH_SOTIEN_BENH,
                                            GH_SOTIEN_NAM: ds.GH_SOTIEN_NAM,
                                            GH_SOTIEN_NGAY: ds.GH_SOTIEN_NGAY,
                                            GH_SOTIEN_VU: ds.GH_SOTIEN_VU,
                                            PT_TU_CHITRA: ds.PT_TU_CHITRA,
                                            SO_TIEN_BH: ds.SO_TIEN_BH,
                                            TEN_QUYEN_LOI_HT: ds.TEN_QUYEN_LOI_HT
                                        }
                                    )
                                );
                                ClearCollect(
                                    tmpMaCTChangeNHD,
                                    tmpDSHDSPNHDCollect
                                );
                                UpdateContext({
                                    maAddedHDSPNHD:"",
                                    maUpdatedHDSPNHD:""
                                });
                            )
                        Size: =11
                        Text: ="Lưu"
                        Visible: =ThisItem.edited=1
                        Width: =90
                        X: =990
                        Y: =143
                        ZIndex: =17

                    btnSuaHDSPNHD As button:
                        Height: =32
                        OnSelect: |-
                            =If(
                                Or(maAddedHDSPNHD<>"",maUpdatedHDSPNHD<>""),
                                Notify("Có dữ liệu chưa được lưu",NotificationType.Warning,2000),
                                UpdateIf(
                                    tmpDSHDSPNHDCollect,
                                    ID=ThisItem.ID,
                                    {
                                        edited:1
                                    }
                                );
                                ClearCollect(
                                    tmpMaCTChangeNHD,
                                    tmpDSHDSPNHDCollect
                                );
                                UpdateContext({
                                    maUpdatedHDSPNHD:ThisItem.ID
                                })
                            )
                        Size: =11
                        Text: ="Sửa"
                        Visible: =ThisItem.edited=0
                        Width: =90
                        X: =990
                        Y: =143
                        ZIndex: =18

                    btnHuyHDSPNHD As button:
                        Height: =32
                        OnSelect: |-
                            =If(
                                ThisItem.ID=maAddedHDSPNHD,
                                RemoveIf(
                                    tmpDSNDBHNHDCollect,
                                    MA_HOP_DONG=First(objHD).MA_HOP_DONG 
                                    && ID_HOPDONG_SP=ThisItem.ID
                                );
                                RemoveIf(
                                    tmpQLCTHDSPNHDCollect,
                                    MA_HOP_DONG=First(objHD).MA_HOP_DONG 
                                    && ID_HOPDONG_SP=ThisItem.ID
                                );
                                Remove(tmpDSHDSPNHDCollect,ThisItem),
                                RemoveIf(
                                    tmpQLCTHDSPNHDCollect,
                                    MA_HOP_DONG=First(objHD).MA_HOP_DONG 
                                    && ID_HOPDONG_SP=ThisItem.ID
                                );
                                RemoveIf(
                                    tmpDSNDBHNHDCollect,
                                    MA_HOP_DONG=First(objHD).MA_HOP_DONG 
                                    && ID_HOPDONG_SP=ThisItem.ID
                                );
                                Collect(
                                    tmpDSNDBHNHDCollect,
                                    AddColumns(
                                        Filter(
                                            DL_HOP_DONG_SP_NDBH,
                                            MA_HOP_DONG=First(objHD).MA_HOP_DONG && ID_HOPDONG_SP=ThisItem.ID
                                        ),
                                        "edited",
                                        0
                                    )
                                );
                                UpdateIf(
                                    tmpDSHDSPNHDCollect,
                                    ID=ThisItem.ID,
                                    {
                                        /*MA_SAN_PHAM:LookUp(DL_HOP_DONG_SPS,MA_HOP_DONG=First(objHD).MA_HOP_DONG && ID=ThisItem.ID,MA_SAN_PHAM),
                                        MA_CHUONG_TRINH:LookUp(DL_HOP_DONG_SPS,MA_HOP_DONG=First(objHD).MA_HOP_DONG && ID=ThisItem.ID,MA_CHUONG_TRINH),
                                        NHOM_TINH_PHI:LookUp(DL_HOP_DONG_SPS,MA_HOP_DONG=First(objHD).MA_HOP_DONG && ID=ThisItem.ID,NHOM_TINH_PHI),*/
                                        SONGUOI_THAMGIA:LookUp(DL_HOP_DONG_SPS,MA_HOP_DONG=First(objHD).MA_HOP_DONG && ID=ThisItem.ID,SONGUOI_THAMGIA),
                                        TONG_TIEN_PHI:LookUp(DL_HOP_DONG_SPS,MA_HOP_DONG=First(objHD).MA_HOP_DONG && ID=ThisItem.ID,TONG_TIEN_PHI),
                                        TONG_PHI_DANHSACH:LookUp(DL_HOP_DONG_SPS,MA_HOP_DONG=First(objHD).MA_HOP_DONG && ID=ThisItem.ID,TONG_PHI_DANHSACH),
                                        edited:0
                                    }
                                );
                                /*UpdateIf(
                                    tmpMaCTChangeNHD,
                                    ID=ThisItem.ID,
                                    {
                                        MA_CHUONG_TRINH:LookUp(tmpDSHDSPNHDCollect,ID=ThisItem.ID,MA_CHUONG_TRINH),
                                        NHOM_TINH_PHI:LookUp(tmpDSHDSPNHDCollect,ID=ThisItem.ID,NHOM_TINH_PHI)
                                    }
                                );*/
                                UpdateIf(
                                    objHD,
                                    true,
                                    {
                                        SO_NGUOI_TGIA:Sum(tmpDSHDSPNHDCollect,SONGUOI_THAMGIA)
                                    }
                                );
                                UpdateIf(
                                    DL_HOP_DONGS,
                                    MA_HOP_DONG=First(objHD).MA_HOP_DONG,
                                    {
                                        SO_NGUOI_TGIA:Sum(tmpDSHDSPNHDCollect,SONGUOI_THAMGIA)
                                    }
                                );
                                Collect(
                                    tmpQLCTHDSPNHDCollect,
                                    AddColumns(
                                        Filter(
                                            DL_HOP_DONG_SP_QLCT,
                                            MA_HOP_DONG=First(objHD).MA_HOP_DONG && ID_HOPDONG_SP=ThisItem.ID
                                        ),
                                        "edited",
                                        0
                                    )
                                );
                            );
                            UpdateContext({
                                maAddedHDSPNHD:"",
                                maUpdatedHDSPNHD:"",
                                unReloadMaCT:"1",
                                unReloadMaSP:"1"
                            });
                        Size: =11
                        Text: ="Hủy"
                        Visible: =ThisItem.edited=1
                        Width: =90
                        X: =1100
                        Y: =143
                        ZIndex: =19

                    LinkHDLK_1 As text:
                        BorderThickness: =0
                        Color: =RGBA(39, 113, 194, 1)
                        Default: ="Danh sách NĐBH"
                        DisabledBorderColor: =RGBA(255, 255, 255, 1)
                        DisabledFill: =RGBA(255, 255, 255, 1)
                        DisplayMode: |-
                            =//If(ThisItem.edited=0,DisplayMode.Edit,DisplayMode.Disabled) 
                            DisplayMode.Edit
                        Height: =28
                        HoverBorderColor: =RGBA(255, 255, 255, 1)
                        HoverColor: =RGBA(39, 113, 194, 1)
                        HoverFill: =RGBA(255, 255, 255, 1)
                        OnSelect: |-
                            =ClearCollect(
                                dmGioiTinhNDBHCollect,
                                DM_GIOI_TINHS
                            );
                            ClearCollect(
                                dmPhamViNDBHCollect,
                                DM_PHAMVI_DIALYS
                            );
                            If(
                                IsBlank(cbxMaSPNHD.Selected.MA_SAN_PHAM),
                                Notify(
                                    "Bắt buộc chọn sản phẩm",
                                    NotificationType.Error,
                                    2000
                                ),
                                (ThisItem.edited=1 && IsBlank(cbxMaCTNHD.Selected.MA_CHUONG_TRINH)) || (ThisItem.edited=0 && IsBlank(cbxMaCTNHDHide.Selected.MA_CHUONG_TRINH)),
                                Notify(
                                    "Bắt buộc chọn chương trình",
                                    NotificationType.Error,
                                    2000
                                ),
                                IsEmpty(cbxNhomTPNHD.SelectedItems),
                                Notify(
                                    "Bắt buộc chọn nhóm tính phí",
                                    NotificationType.Error,
                                    2000
                                ),
                                Set(
                                    idHopDongSPNDBH,
                                    ThisItem.ID
                                );
                                Set(
                                    maSPNDBH,
                                    cbxMaSPNHD.Selected.MA_SAN_PHAM
                                );
                                Set(
                                    maHDNDBH,
                                    First(objHD).MA_HOP_DONG
                                );
                                Set(
                                    maCTNDBH,
                                    If(
                                        ThisItem.edited=1,
                                        cbxMaCTNHD.Selected.MA_CHUONG_TRINH,
                                        cbxMaCTNHDHide.Selected.MA_CHUONG_TRINH
                                    )
                                );
                                Set(
                                    nhomTPNDBH,
                                    Concat(
                                        cbxNhomTPNHD.SelectedItems,
                                        Value,
                                        "|"
                                    )
                                );
                                Set(
                                    phiDCNDBH,
                                    tiPhiDCNHD.Text
                                );
                                If(
                                    cbxLoaiKHNHD.Selected.value = "0" && IsBlank(
                                        LookUp(
                                            tmpMaCTChangeNHD,
                                            ID = ThisItem.ID,
                                            AUTO_GEN_NDBH
                                        )
                                    ) && ThisItem.edited = 1,
                                    /* 
                                    UpdateContext({varPhiNDBH: 0});
                                    UpdateContext({varTuoi: 0});
                                    UpdateContext({varDVTuoi: 0});
                                    //Tinh tuoi
                                    If(
                                        !IsBlank(dpNSinhNHD.SelectedDate),
                                        If(
                                            DateDiff(
                                                dpNSinhNHD.SelectedDate,
                                                Today(),
                                                TimeUnit.Years
                                            ) > 0,
                                            UpdateContext(
                                                {
                                                    varTuoi: DateDiff(
                                                        dpNSinhNHD.SelectedDate,
                                                        Today(),
                                                        TimeUnit.Years
                                                    )
                                                }
                                            );
                                            UpdateContext({varDVTuoi: 100});
                                            ,
                                            If(
                                                DateDiff(
                                                    dpNSinhNHD.SelectedDate,
                                                    Today(),
                                                    TimeUnit.Months
                                                ) > 0,
                                                UpdateContext({varTuoi: 1});
                                                UpdateContext({varDVTuoi: 200});
                                                ,
                                                If(
                                                    DateDiff(
                                                        dpNSinhNHD.SelectedDate,
                                                        Today(),
                                                        TimeUnit.Days
                                                    ) >= 60,
                                                    UpdateContext({varTuoi: 1});
                                                    UpdateContext({varDVTuoi: 400}),
                                                    UpdateContext({varTuoi: 0})
                                                )
                                            )
                                        )
                                    );
                                    //Kiem tra dap ung chi tieu
                            UpdateContext(
                                        {
                                            varPhiNDBH: Sum(
                                                Filter(
                                                    DL_CHUONG_TRINH_BANG_PHIS,
                                                    MA_SAN_PHAM = maSPNDBH && MA_CHUONG_TRINH = maCTNDBH && !IsBlank(
                                                        Find(
                                                            NHOM_TINH_PHI,
                                                            nhomTPNDBH
                                                        )
                                                    ) && (IsBlank(MA_PHAMVI_DIALY) || (!IsBlank(cbxTinhNHD.Selected.MA_PHAMVI) && MA_PHAMVI_DIALY = cbxTinhNHD.Selected.MA_PHAMVI)) && (IsBlank(MA_GIOI_TINH) || (!IsBlank(cbxGTinhNHD.Selected.MA_GIOI_TINH) && MA_GIOI_TINH = cbxGTinhNHD.Selected.MA_GIOI_TINH)) && (IsBlank(MA_DO_TUOI) || MA_DO_TUOI = LookUp(
                                                        DM_DO_TUOIS,
                                                        (If(
                                                            MO_TA = MA_DO_TUOI && DONVI_TUOI_TU > 100,
                                                            1,
                                                            TUOI_TU
                                                        ) <= varTuoi) && (If(
                                                            DONVI_TUOI_DEN > 100,
                                                            1,
                                                            TUOI_DEN
                                                        ) >= varTuoi)
                                                    ).MO_TA || IsBlank(MA_DO_TUOI))
                                                ),
                                                PHI_BH
                                            )
                                        }
                                    );*/
                                    //Lay phi chuong trinh
                            UpdateContext(
                                        {
                                            idNDBH: If(
                                                CountIf(
                                                    tmpDSNDBHNHDCollect,
                                                    true
                                                ) > 0,
                                                Max(
                                                    tmpDSNDBHNHDCollect,
                                                    ID
                                                ) + 1,
                                                Max(
                                                    DL_HOP_DONG_SP_NDBH,
                                                    ID
                                                ) + 1
                                            )
                                        }
                                    );
                                    Collect(
                                        tmpDSNDBHNHDCollect,
                                        {
                                            ID: idNDBH,
                                            ID_HOPDONG_SP: ThisItem.ID,
                                            MA_HOP_DONG: First(objHD).MA_HOP_DONG,
                                            MA_SAN_PHAM: ThisItem.MA_SAN_PHAM,
                                            MA_CHUONG_TRINH: ThisItem.MA_CHUONG_TRINH,
                                            MST: cbxMaKHNHD.Selected.MST,
                                            TEN_NDBH: tiTenKHNHD.Text,
                                            DIA_CHI: tiDChiNHD.Text,
                                            MA_GIOI__TINH: cbxGTinhNHD.Selected.MA_GIOI_TINH,
                                            MA_NHAN_VIEN: "",
                                            MA_TINH_TP: cbxTinhNHD.Selected.MA_PHAMVI,
                                            MOI_QUAN_HE: "",
                                            NGAY_SINH: dpNSinhNHD.SelectedDate,
                                            NHOM: "",
                                            SO_GIAY_TO: cbxMaKHNHD.Selected.SO_GIAY_TO,
                                            PHI_NDBH: Blank(),
                                            edited: 0
                                        }
                                    );
                                    UpdateIf(
                                        tmpMaCTChangeNHD,
                                        ID = ThisItem.ID,
                                        {AUTO_GEN_NDBH: "1"}
                                    )
                                );
                            	//tinh lai phi neu thay doi san pham, ctrinh hoac nhom tinh phi
                                /*
                                UpdateContext(
                                    {
                                        objChangeNDBH: First(
                                            Filter(
                                                tmpDSNDBHNHDCollect,
                                                ID_HOPDONG_SP = ThisItem.ID
                                            )
                                        )
                                    }
                                );*/
                                ClearCollect(
                                    tmpTinhLaiPhiNDBHCollect,
                                    {
                                        varPhiNDBHCol:0,
                                        varTuoiCol:0,
                                        varDVTuoiCol:0
                                    }
                                );
                                ClearCollect(
                                    tmpKQPhiNDBHCollect,
                                    {
                                        ID:0,
                                        PHI_NDBH:0
                                    }
                                );
                                Clear(tmpKQPhiNDBHCollect);
                                /*
                                ClearCollect(
                                    changeNhomTPNDBH,
                                    {
                                        check:false
                                    }
                                );
                                ForAll(
                                    Split(objChangeNDBH.NHOM_TINH_PHI,"|") As ds,
                                    If(
                                        IsBlank(Find(ds.Value,nhomTPNDBH)),
                                        UpdateIf(
                                            changeNhomTPNDBH,
                                            true,
                                            {
                                                check:true
                                            }
                                        )
                                    )
                                );
                                ForAll(
                                    Split(nhomTPNDBH,"|") As ds,
                                    If(
                                        IsBlank(Find(ds.Value,objChangeNDBH.NHOM_TINH_PHI)),
                                        UpdateIf(
                                            changeNhomTPNDBH,
                                            true,
                                            {
                                                check:true
                                            }
                                        )
                                    )
                                );
                                If(
                                    objChangeNDBH.MA_SAN_PHAM<>maSPNDBH || objChangeNDBH.MA_CHUONG_TRINH<>maCTNDBH || First(changeNhomTPNDBH).check,*/
                                    ForAll(
                                        Filter(
                            				tmpDSNDBHNHDCollect,
                            				ID_HOPDONG_SP = ThisItem.ID
                            			) As ds,
                            			//Tinh tuoi
                            			If(
                            				!IsBlank(ds.NGAY_SINH),
                            				If(
                            					DateDiff(
                            						ds.NGAY_SINH,
                            						Today(),
                            						TimeUnit.Years
                            					) > 0,
                                                UpdateIf(
                                                    tmpTinhLaiPhiNDBHCollect,
                                                    true,
                                                    {
                                                        varTuoiCol:DateDiff(
                            								ds.NGAY_SINH,
                            								Today(),
                            								TimeUnit.Years
                            							),
                                                        varDVTuoiCol: 100
                                                    }
                                                ),
                            					If(
                            						DateDiff(
                            							ds.NGAY_SINH,
                            							Today(),
                            							TimeUnit.Months
                            						) > 0,
                                                    UpdateIf(
                            							tmpTinhLaiPhiNDBHCollect,
                            							true,
                            							{
                            								varTuoiCol:1,
                            								varDVTuoiCol: 200
                            							}
                            						),
                            						If(
                            							DateDiff(
                            								ds.NGAY_SINH,
                            								Today(),
                            								TimeUnit.Days
                            							) >= 60,
                                                        UpdateIf(
                                                            tmpTinhLaiPhiNDBHCollect,
                                                            true,
                                                            {
                                                                varTuoiCol: 1,
                                                                varDVTuoiCol: 400
                                                            }
                                                        ),
                                                        UpdateIf(
                                                            tmpTinhLaiPhiNDBHCollect,
                                                            true,
                                                            {
                                                                varTuoiCol: 0
                                                            }
                                                        )
                            						)
                            					)
                            				)
                            			);
                            			//Kiem tra dap ung chi tieu
                                        UpdateIf(
                                            tmpTinhLaiPhiNDBHCollect,
                                            true,
                                            {
                                                varPhiNDBHCol:Sum(
                            					Filter(
                            						DL_CHUONG_TRINH_BANG_PHIS,MA_SAN_PHAM = maSPNDBH && MA_CHUONG_TRINH = maCTNDBH && 
                                                    !IsBlank(Find(NHOM_TINH_PHI,nhomTPNDBH)) &&
                            						(IsBlank(MA_PHAMVI_DIALY) || (!IsBlank(ds.MA_TINH_TP) && 
                            						MA_PHAMVI_DIALY = LookUp(dmPhamViNDBHCollect,MA_PHAMVI=ds.MA_TINH_TP,TEN_PHAMVI))) && 
                            						(IsBlank(MA_GIOI_TINH) || (!IsBlank(ds.MA_GIOI__TINH) && 
                            						MA_GIOI_TINH = LookUp(dmGioiTinhNDBHCollect,MA_GIOI_TINH=ds.MA_GIOI__TINH,TEN_GIOI_TINH))) && 
                            						(IsBlank(MA_DO_TUOI) || MA_DO_TUOI = LookUp(
                            							DM_DO_TUOIS,
                            							(If(
                            								MO_TA = MA_DO_TUOI && DONVI_TUOI_TU > 100,
                            								1,
                            								TUOI_TU
                            							) <= varTuoiCol) && (If(
                            								DONVI_TUOI_DEN > 100,
                            								1,
                            								TUOI_DEN
                            							) >= varTuoiCol)
                            						).MO_TA || IsBlank(MA_DO_TUOI))
                            					),
                            					PHI_BH
                            				)
                                            }
                                        );
                            			//Lay phi chuong trinh
                                        Collect(
                                            tmpKQPhiNDBHCollect,
                                            {
                                                ID:ds.ID,
                                                PHI_NDBH:First(tmpTinhLaiPhiNDBHCollect).varPhiNDBHCol
                                            }
                                        );
                                        UpdateIf(
                                            tmpTinhLaiPhiNDBHCollect,
                                            true,
                                            {
                                                varPhiNDBHCol:0,
                                                varTuoiCol:0,
                                                varDVTuoiCol:0
                                            }
                                        )
                                    );
                                    ForAll(
                                        tmpKQPhiNDBHCollect As ds,
                                        UpdateIf(
                                            tmpDSNDBHNHDCollect,
                                            ID_HOPDONG_SP=ThisItem.ID && ID=ds.ID,
                                            {
                                                PHI_NDBH:ds.PHI_NDBH
                                            }
                                        )
                                    );
                                //);
                                // end tinh lai phi neu thay doi san pham, ctrinh hoac nhom tinh phi
                                If(
                                    ThisItem.edited = 1,
                                    Set(
                                        modeMHNDBH,
                                        "1"
                                    ),
                                    Set(
                                        modeMHNDBH,
                                        "0"
                                    )
                                );
                                Navigate(NhapNDBH);
                            )
                        Size: =11
                        Underline: =true
                        Width: =142
                        X: =342
                        Y: =145
                        ZIndex: =20

                    Label3_66 As label:
                        Height: =25
                        Size: =11
                        Text: ="Nhóm tính phí"
                        Width: =140
                        X: =30
                        Y: =74
                        ZIndex: =21

                    cbxNhomTPNHD As combobox:
                        BorderColor: =RGBA(72, 163, 62, 1)
                        DefaultSelectedItems: |-
                            =/*If (
                                ThisItem.edited=1,
                                Filter(
                                    ["Nhóm chính","Nhóm bổ sung","Nhóm thai sản","Nha khoa/Chăm sóc răng","Ngoại trú","Nhóm thương tật, tử vong"],
                                    !IsBlank(Find(Value,tiNhomTPHideNHD.Text)) &&
                                    !IsBlank(cbxMaCTNHD.Selected.MA_CHUONG_TRINH)
                                ),
                                Filter(
                                    ["Nhóm chính","Nhóm bổ sung","Nhóm thai sản","Nha khoa/Chăm sóc răng","Ngoại trú","Nhóm thương tật, tử vong"],
                                    !IsBlank(Find(Value,ThisItem.NHOM_TINH_PHI)) &&
                                    !IsBlank(cbxMaCTNHD.Selected.MA_CHUONG_TRINH)
                                )
                            )*/
                            Filter(
                                ["Nhóm chính","Nhóm bổ sung","Nhóm thai sản","Nha khoa/Chăm sóc răng","Ngoại trú","Nhóm thương tật, tử vong"],
                                !IsBlank(Find(Value,LookUp(tmpMaCTChangeNHD,ID=ThisItem.ID,NHOM_TINH_PHI))) &&
                                !IsBlank(cbxMaCTNHD.Selected.MA_CHUONG_TRINH)
                            )
                        DisplayFields: =["Value"]
                        Height: =32
                        InputTextPlaceholder: =""
                        IsSearchable: =false
                        Items: |-
                            =Filter(
                                ["Nhóm chính","Nhóm bổ sung","Nhóm thai sản","Nha khoa/Chăm sóc răng","Ngoại trú","Nhóm thương tật, tử vong"],
                                Value in
                                Distinct(
                                    Filter(
                                        DL_SAN_PHAM_NHOMQLS,
                                        MA_SP=cbxMaSPNHD.Selected.MA_SAN_PHAM && !IsBlank(cbxMaCTNHD.Selected.MA_CHUONG_TRINH) && !IsBlank(Find(cbxMaCTNHD.Selected.MA_CHUONG_TRINH,CHUONGTRINH_APDUNG))
                                    ),
                                    MA_NHOM_TINHPHI
                                )
                            )
                        SearchFields: =["Value"]
                        SearchItems: =[]
                        Size: =11
                        Visible: |
                            =ThisItem.edited=1
                        Width: =250
                        X: =30
                        Y: =102
                        ZIndex: =22

                    LinkHDLK_3 As text:
                        BorderThickness: =0
                        Color: =RGBA(39, 113, 194, 1)
                        Default: ="Quyền lợi chi tiết"
                        DisabledBorderColor: =RGBA(255, 255, 255, 1)
                        DisabledFill: =RGBA(255, 255, 255, 1)
                        Height: =27
                        HoverBorderColor: =RGBA(255, 255, 255, 1)
                        HoverColor: =RGBA(39, 113, 194, 1)
                        HoverFill: =RGBA(255, 255, 255, 1)
                        OnSelect: |
                            =If(
                                IsBlank(cbxMaSPNHD.Selected.MA_SAN_PHAM),
                                Notify(
                                    "Bắt buộc chọn sản phẩm",
                                    NotificationType.Error,
                                    2000
                                ),
                                (ThisItem.edited=1 && IsBlank(cbxMaCTNHD.Selected.MA_CHUONG_TRINH)) || (ThisItem.edited=0 && IsBlank(cbxMaCTNHDHide.Selected.MA_CHUONG_TRINH)),
                                Notify(
                                    "Bắt buộc chọn chương trình",
                                    NotificationType.Error,
                                    2000
                                ),
                                IsEmpty(cbxNhomTPNHD.SelectedItems),
                                Notify(
                                    "Bắt buộc chọn nhóm tính phí",
                                    NotificationType.Error,
                                    2000
                                ),
                                Set(idHopDongSPQLCT,ThisItem.ID);
                                Set(maSPQLCTNHD,cbxMaSPNHD.Selected.MA_SAN_PHAM);
                                Set(maHDQLCTNHD,First(objHD).MA_HOP_DONG);
                                Set(
                                    maCTQLCTNHD,
                                    If(
                                        ThisItem.edited=1,
                                        cbxMaCTNHD.Selected.MA_CHUONG_TRINH,
                                        cbxMaCTNHDHide.Selected.MA_CHUONG_TRINH
                                    )
                                );
                                Set(maNhomTPQLCTNHD,Concat(cbxNhomTPNHD.SelectedItems,Value,"|"));
                                UpdateContext({
                                    objChangeQLCTNHD:First(
                                        Filter(
                                            tmpQLCTHDSPNHDCollect,
                                            ID_HOPDONG_SP=ThisItem.ID
                                        )
                                    )
                                });
                                ClearCollect(
                                    tmpChangeQLCTNHD,
                                    {
                                        check:false
                                    }
                                );
                                If(
                                    objChangeQLCTNHD.MA_SAN_PHAM<>cbxMaSPNHD.Selected.MA_SAN_PHAM || 
                                    objChangeQLCTNHD.MA_CHUONG_TRINH<>maCTQLCTNHD,
                                    UpdateIf(
                                        tmpChangeQLCTNHD,
                                        true,
                                        {
                                            check:true
                                        }
                                    )
                                );
                                ForAll(
                                    Split(maNhomTPQLCTNHD,"|") As ds,
                                    If(
                                        IsBlank(Find(ds.Value,objChangeQLCTNHD.NHOM_TINH_PHI)),
                                        UpdateIf(
                                            tmpChangeQLCTNHD,
                                            true,
                                            {
                                                check:true
                                            }
                                        )
                                    )
                                );
                                ForAll(
                                    Split(objChangeQLCTNHD.NHOM_TINH_PHI,"|") As ds,
                                    If(
                                        IsBlank(Find(ds.Value,maNhomTPQLCTNHD)),
                                        UpdateIf(
                                            tmpChangeQLCTNHD,
                                            true,
                                            {
                                                check:true
                                            }
                                        )
                                    )
                                );
                                If(
                                    First(tmpChangeQLCTNHD).check,
                                    RemoveIf(
                                        tmpQLCTHDSPNHDCollect,
                                        ID_HOPDONG_SP=ThisItem.ID
                                    )
                                );
                                If(
                                    CountIf(Filter(tmpQLCTHDSPNHDCollect,ID_HOPDONG_SP=ThisItem.ID),true)=0,
                                    ForAll(
                                        Filter(
                                            DL_CHUONGTRINH_QLCTS,
                                            MA_CHUONG_TRINH = ThisItem.MA_CHUONG_TRINH && MA_SAN_PHAM = ThisItem.MA_SAN_PHAM &&
                                            MA_NHOM_QL in Distinct(Filter(DL_SAN_PHAM_NHOMQLS,MA_SP = ThisItem.MA_SAN_PHAM && 
                                                !IsBlank(Find(ThisItem.MA_CHUONG_TRINH,CHUONGTRINH_APDUNG)) &&
                                                !IsBlank(Find(MA_NHOM_TINHPHI,ThisItem.NHOM_TINH_PHI))
                                            ),MA_NHOM_QL)
                                        ) As ql,
                                        Collect(
                                            tmpQLCTHDSPNHDCollect,
                                            {
                                                MA_CHUONG_TRINH: maCTQLCTNHD,
                                                MA_SAN_PHAM: cbxMaSPNHD.Selected.MA_SAN_PHAM,
                                                NHOM_TINH_PHI:Concat(cbxNhomTPNHD.SelectedItems,Value,"|"),
                                                MA_QL_CT: ql.MA_QL_CT,
                                                TT_HIENTHI: ql.TT_HIENTHI,
                                                MA_NHOM_QL: ql.MA_NHOM_QL,
                                                GH_SOLAN_NAM: ql.GH_SOLAN_NAM,
                                                GH_SONGAY_NAM: ql.GH_SONGAY_NAM,
                                                GH_SOTIEN_BENH: ql.GH_SOTIEN_BENH,
                                                GH_SOTIEN_NAM: ql.GH_SOTIEN_NAM,
                                                GH_SOTIEN_NGAY: ql.GH_SOTIEN_NGAY,
                                                GH_SOTIEN_VU: ql.GH_SOTIEN_VU,
                                                PT_TU_CHITRA: ql.PT_TU_CHITRA,
                                                SO_TIEN_BH: ql.SO_TIEN_BH,
                                                TEN_QUYEN_LOI_HT: ql.TEN_QUYEN_LOI_HT,
                                                ID_HOPDONG_SP:ThisItem.ID,
                                                edited:0
                                            }
                                        )
                                    )
                                );
                                If(
                                    ThisItem.edited = 1,
                                    Set(
                                        modeMHQLCT,
                                        "1"
                                    ),
                                    Set(
                                        modeMHQLCT,
                                        "0"
                                    )
                                );
                                Navigate(DSQuyenLoiHD)
                            )
                        Size: =11
                        Underline: =true
                        Visible: |-
                            =//If(!IsBlank(tiMaHDNHD.Text),true,false)
                            true
                        Width: =169
                        X: =17
                        Y: =145
                        ZIndex: =23

                    tiPhiDCNHD As text:
                        Align: =Align.Right
                        BorderColor: =RGBA(72, 163, 62, 1)
                        Default: |-
                            =If (
                                ThisItem.edited=1,
                                If(LookUp(tmpMaCTChangeNHD,ID=ThisItem.ID,PHI_DIEU_CHINH)=0,Blank(),LookUp(tmpMaCTChangeNHD,ID=ThisItem.ID,PHI_DIEU_CHINH)),
                                If(ThisItem.PHI_DIEU_CHINH=0,Blank(),ThisItem.PHI_DIEU_CHINH)
                            )
                        DisplayMode: =If(ThisItem.edited=1,DisplayMode.Edit,DisplayMode.Disabled)
                        Format: =TextFormat.Number
                        Height: =32
                        OnChange: |-
                            =If(
                                Value(tiPhiDCNHD.Text)=0,
                                UpdateIf(
                                    tmpMaCTChangeNHD,
                                    ID=ThisItem.ID,
                                    {
                                        PHI_DIEU_CHINH:Blank()
                                    }
                                );
                                Reset(tiPhiDCNHD)
                            );
                            If(
                                IsBlank(tiPhiDCNHD.Text) || Value(tiPhiDCNHD.Text)=0,
                                UpdateContext({
                                    tongPhiNDBH:LookUp(tmpMaCTChangeNHD,ID=ThisItem.ID,TONG_PHI_DANHSACH)
                                });
                                UpdateIf(
                                    tmpMaCTChangeNHD,
                                    ID=ThisItem.ID,
                                    {
                                        TONG_TIEN_PHI:tongPhiNDBH
                                    }
                                );
                                Reset(tiTongPhiNHD),
                                Value(tiPhiDCNHD.Text)<>ThisItem.PHI_DIEU_CHINH && !IsBlank(tiPhiDCNHD.Text) && Value(tiPhiDCNHD.Text)<>0,
                                UpdateIf(
                                    tmpMaCTChangeNHD,
                                    ID=ThisItem.ID,
                                    {
                                        TONG_TIEN_PHI:Value(tiPhiDCNHD.Text)*Value(tiSoNTGSPNHD.Text)
                                    }
                                );
                                Reset(tiTongPhiNHD)
                            )
                        RadiusBottomLeft: =0
                        RadiusBottomRight: =0
                        RadiusTopLeft: =0
                        RadiusTopRight: =0
                        Size: =11
                        Width: =250
                        X: =355
                        Y: =102
                        ZIndex: =24

                    Label3_87 As label:
                        Height: =25
                        Size: =11
                        Text: ="Phí/Người điều chỉnh"
                        Width: =180
                        X: =355
                        Y: =74
                        ZIndex: =25

                    tiNhomTPNHD As text:
                        BorderColor: =RGBA(72, 163, 62, 1)
                        Default: =Concat(Split(ThisItem.NHOM_TINH_PHI,"|"), Value,", ") 
                        DisplayMode: =DisplayMode.Disabled
                        Height: =32
                        RadiusBottomLeft: =0
                        RadiusBottomRight: =0
                        RadiusTopLeft: =0
                        RadiusTopRight: =0
                        Size: =11
                        Visible: |
                            =ThisItem.edited=0
                        Width: =250
                        X: =30
                        Y: =102
                        ZIndex: =26

                    cbxMaCTNHDHide As combobox:
                        BorderColor: =RGBA(72, 163, 62, 1)
                        DefaultSelectedItems: |-
                            =/*If (
                                ThisItem.edited=1,
                                LookUp(
                                    ' DL_SAN_PHAM_CT',
                                    MA_SAN_PHAM=cbxMaSPNHD.Selected.MA_SAN_PHAM && MA_CHUONG_TRINH=tiMaCTNHD.Text
                                ),
                                LookUp(
                                    ' DL_SAN_PHAM_CT',
                                    MA_SAN_PHAM=cbxMaSPNHD.Selected.MA_SAN_PHAM && MA_CHUONG_TRINH=ThisItem.MA_CHUONG_TRINH
                                )
                            )*/
                            LookUp(
                                ' DL_SAN_PHAM_CT',
                                MA_CHUONG_TRINH=ThisItem.MA_CHUONG_TRINH
                            )
                        DisplayFields: =["cr282_ma_chuongtrinh"]
                        DisplayMode: =DisplayMode.Disabled
                        Height: =32
                        InputTextPlaceholder: =""
                        Items: =' DL_SAN_PHAM_CT'
                        SearchFields: =["cr282_ma_chuongtrinh"]
                        SearchItems: =Search(' DL_SAN_PHAM_CT',cbxMaCTNHDHide.SearchText,"cr282_ma_chuongtrinh")
                        SelectMultiple: =false
                        Size: =11
                        Visible: =ThisItem.edited=0
                        Width: =250
                        X: =672
                        Y: =34
                        ZIndex: =29

                Button2_3 As button:
                    DisplayMode: =If(IsBlank(First(objHD).MA_HOP_DONG),DisplayMode.Disabled,DisplayMode.Edit)
                    Height: =32
                    OnSelect: |
                        =If(
                            Or(maAddedHDSPNHD<>"",maUpdatedHDSPNHD<>""),
                            Notify("Có dữ liệu chưa được lưu",NotificationType.Warning,2000),
                            Collect(
                                tmpDSHDSPNHDCollect,
                                Defaults(tmpDSHDSPNHDCollect)
                            );
                            UpdateContext({
                                maHDSP:Max(DL_HOP_DONG_SPS,ID)+1
                            });
                            UpdateIf(
                                tmpDSHDSPNHDCollect,
                                IsBlank(ID),
                                {
                                    ID:Text(maHDSP),
                                    MA_HOP_DONG:First(objHD).MA_HOP_DONG,
                                    edited:1
                                }
                            );
                            ClearCollect(
                                tmpMaCTChangeNHD,
                                tmpDSHDSPNHDCollect
                            );
                            UpdateContext({
                                maAddedHDSPNHD:Text(maHDSP),
                                unReloadMaSP:Blank()
                            });
                            Reset(LinkHDLK);
                        )
                    Size: =11
                    Text: ="Thêm mới"
                    Width: =100
                    X: =30
                    Y: =30
                    ZIndex: =22

            Container3_6 As groupContainer.manualLayoutContainer:
                Height: =210
                Width: =1267
                X: =16
                Y: =778
                ZIndex: =5

                Label3_67 As label:
                    FontWeight: =FontWeight.Bold
                    Height: =20
                    Size: =11
                    Text: ="5. Hợp đồng liên kết"
                    Width: =254
                    Y: =4
                    ZIndex: =19

                Gallery3_1 As gallery.variableTemplateHeightGallery:
                    DelayItemLoading: =true
                    Height: =146
                    Items: |-
                        =SortByColumns(
                            tmpDSHDSPLKNHDCollect,
                            "cr282_so_hop_dong_lk",
                            SortOrder.Ascending,
                            "cr282_ma_khach_hang",
                            SortOrder.Ascending
                        )
                    Layout: =Layout.Vertical
                    LoadingSpinner: =LoadingSpinner.Data
                    TemplateSize: =143
                    Width: =1267
                    Y: =60
                    ZIndex: =21

                    Label3_68 As label:
                        Height: =25
                        Size: =11
                        Text: ="Số HĐ liên kết"
                        Width: =130
                        X: =30
                        Y: =6
                        ZIndex: =2

                    Label3_71 As label:
                        Height: =25
                        Size: =11
                        Text: ="Mã kênh bán"
                        Width: =140
                        X: =990
                        Y: =6
                        ZIndex: =3

                    Label3_72 As label:
                        Height: =25
                        Size: =11
                        Text: ="Mã sản phẩm"
                        Width: =168
                        X: =30
                        Y: =74
                        ZIndex: =4

                    Label3_70 As label:
                        Height: =25
                        Size: =11
                        Text: ="Tên khách hàng"
                        Width: =140
                        X: =672
                        Y: =6
                        ZIndex: =5

                    Label3_69 As label:
                        Height: =25
                        Size: =11
                        Text: ="Mã khách hàng"
                        Width: =140
                        X: =355
                        Y: =6
                        ZIndex: =6

                    Label3_73 As label:
                        Height: =25
                        Size: =11
                        Text: ="Tên sản phẩm"
                        Width: =140
                        X: =355
                        Y: =74
                        ZIndex: =7

                    tiSoHDLKNHD_1 As text:
                        BorderColor: =RGBA(72, 163, 62, 1)
                        Default: =ThisItem.SO_HOP_DONG_LK
                        DisplayMode: =DisplayMode.Disabled
                        Height: =32
                        RadiusBottomLeft: =0
                        RadiusBottomRight: =0
                        RadiusTopLeft: =0
                        RadiusTopRight: =0
                        Size: =11
                        Width: =250
                        X: =30
                        Y: =34
                        ZIndex: =8

                    tiMaCTLKNHD_1 As text:
                        BorderColor: =RGBA(72, 163, 62, 1)
                        Default: =ThisItem.MA_CHUONG_TRINH
                        DisplayMode: =DisplayMode.Disabled
                        Height: =32
                        RadiusBottomLeft: =0
                        RadiusBottomRight: =0
                        RadiusTopLeft: =0
                        RadiusTopRight: =0
                        Size: =11
                        Width: =250
                        X: =672
                        Y: =102
                        ZIndex: =9

                    tiTenCTLKNHD_1 As text:
                        BorderColor: =RGBA(72, 163, 62, 1)
                        Default: =ThisItem.TEN_CHUONG_TRINH
                        DisplayMode: =DisplayMode.Disabled
                        Height: =32
                        RadiusBottomLeft: =0
                        RadiusBottomRight: =0
                        RadiusTopLeft: =0
                        RadiusTopRight: =0
                        Size: =11
                        Width: =250
                        X: =990
                        Y: =102
                        ZIndex: =10

                    Label3_74 As label:
                        Height: =25
                        Size: =11
                        Text: ="Mã chương trình"
                        Width: =140
                        X: =672
                        Y: =74
                        ZIndex: =11

                    Label3_75 As label:
                        Height: =25
                        Size: =11
                        Text: ="Tên chương trình"
                        Width: =140
                        X: =990
                        Y: =74
                        ZIndex: =12

                    tiMaKHLKNHD_1 As text:
                        BorderColor: =RGBA(72, 163, 62, 1)
                        Default: =ThisItem.MA_KHACH_HANG
                        DisplayMode: =DisplayMode.Disabled
                        Height: =32
                        RadiusBottomLeft: =0
                        RadiusBottomRight: =0
                        RadiusTopLeft: =0
                        RadiusTopRight: =0
                        Size: =11
                        Width: =250
                        X: =355
                        Y: =34
                        ZIndex: =13

                    tiTenKHLKNHD_1 As text:
                        BorderColor: =RGBA(72, 163, 62, 1)
                        Default: =LookUp(DM_KHACH_HANG,MA_KHACH_HANG=ThisItem.MA_KHACH_HANG,TEN_KHACH_HANG)
                        DisplayMode: =DisplayMode.Disabled
                        Height: =32
                        RadiusBottomLeft: =0
                        RadiusBottomRight: =0
                        RadiusTopLeft: =0
                        RadiusTopRight: =0
                        Size: =11
                        Width: =250
                        X: =672
                        Y: =34
                        ZIndex: =14

                    tiTenKBLKNHD_1 As text:
                        BorderColor: =RGBA(72, 163, 62, 1)
                        Default: =ThisItem.MA_KENH_BAN
                        DisplayMode: =DisplayMode.Disabled
                        Height: =32
                        RadiusBottomLeft: =0
                        RadiusBottomRight: =0
                        RadiusTopLeft: =0
                        RadiusTopRight: =0
                        Size: =11
                        Width: =250
                        X: =990
                        Y: =34
                        ZIndex: =15

                    tiMaSPLKNHD_1 As text:
                        BorderColor: =RGBA(72, 163, 62, 1)
                        Default: =ThisItem.MA_SAN_PHAM
                        DisplayMode: =DisplayMode.Disabled
                        Height: =32
                        RadiusBottomLeft: =0
                        RadiusBottomRight: =0
                        RadiusTopLeft: =0
                        RadiusTopRight: =0
                        Size: =11
                        Width: =250
                        X: =30
                        Y: =102
                        ZIndex: =16

                    tiTenSPLKNHD_1 As text:
                        BorderColor: =RGBA(72, 163, 62, 1)
                        Default: =ThisItem.TEN_SAN_PHAM
                        DisplayMode: =DisplayMode.Disabled
                        Height: =32
                        RadiusBottomLeft: =0
                        RadiusBottomRight: =0
                        RadiusTopLeft: =0
                        RadiusTopRight: =0
                        Size: =11
                        Width: =250
                        X: =355
                        Y: =102
                        ZIndex: =17

                LinkHDLK As text:
                    BorderThickness: =0
                    Color: =RGBA(39, 113, 194, 1)
                    Default: ="Hợp đồng liên kết"
                    DisabledBorderColor: =RGBA(255, 255, 255, 1)
                    DisabledFill: =RGBA(255, 255, 255, 1)
                    Height: =28
                    HoverBorderColor: =RGBA(255, 255, 255, 1)
                    HoverColor: =RGBA(39, 113, 194, 1)
                    HoverFill: =RGBA(255, 255, 255, 1)
                    OnSelect: |-
                        =Set(dsMaSPNLKFwd,Concat(Filter(DL_HOP_DONG_SPS,MA_HOP_DONG=First(objHD).MA_HOP_DONG),MA_SAN_PHAM,"|"));
                        Set(maHDNLKFwd,tiMaHDNHD.Text);
                        Set(maKBNLKFwd,cbxMaKBNHD.Selected.MA_KENH_BAN);
                        Set(maKHNLKFwd,cbxMaKHNHD.Selected.MA_KHACH_HANG);
                        Navigate(NhapHopDongLK)
                    Size: =11
                    Underline: =true
                    Width: =142
                    X: =24
                    Y: =30
                    ZIndex: =22

            Container3_8 As groupContainer.manualLayoutContainer:
                Height: =379
                Width: =1267
                X: =16
                Y: =988
                ZIndex: =8

                Label3_76 As label:
                    FontWeight: =FontWeight.Bold
                    Height: =20
                    Size: =11
                    Text: ="6. Chính sách áp dụng"
                    Width: =254
                    Y: =4
                    ZIndex: =1

                LinkHDLK_2 As text:
                    BorderThickness: =0
                    Color: =RGBA(39, 113, 194, 1)
                    Default: ="Chọn chính sách"
                    DisabledBorderColor: =RGBA(255, 255, 255, 1)
                    DisabledColor: =RGBA(39, 113, 194, 1)
                    DisabledFill: =RGBA(255, 255, 255, 1)
                    Height: =28
                    HoverBorderColor: =RGBA(255, 255, 255, 1)
                    HoverColor: =RGBA(39, 113, 194, 1)
                    HoverFill: =RGBA(255, 255, 255, 1)
                    OnSelect: |
                        =ClearCollect(
                            dlDKADLoaiCTCCSCollect,
                            DL_DIEUKIEN_APDUNG_LOAI_CT
                        );
                        ClearCollect(
                            dlChinhSachDTCTCCSCollect,
                            DL_CHINHSACH_DOITUONG_CT
                        );
                        Set(
                            dsMaSPNLKFwd,
                            Concat(
                                tmpDSHDSPNHDCollect,
                                MA_SAN_PHAM,
                                "|"
                            )
                        );
                        Set(
                            maHDNLKFwd,
                            tiMaHDNHD.Text
                        );
                        Set(
                            maKBNLKFwd,
                            cbxMaKBNHD.Selected.MA_KENH_BAN
                        );
                        Set(
                            maKHNLKFwd,
                            cbxMaKHNHD.Selected.MA_KHACH_HANG
                        );
                        Set(dsMaSPCCSFwd,Concat(Filter(DL_HOP_DONG_SPS,MA_HOP_DONG=First(objHD).MA_HOP_DONG),MA_SAN_PHAM,"|"));
                        Set(maKBCCSFwd,cbxMaKBNHD.Selected.MA_KENH_BAN);
                        Set(maKHCCSFwd,cbxMaKHNHD.Selected.MA_KHACH_HANG);
                        Set(maDVCCSFwd,cbxDVQLNHD.Selected.MA_PHAMVI);
                        Set(maTinhTPCCSFwd,cbxTinhNHD.Selected.MA_PHAMVI);
                        Set(nhomKBCCSFwd,nhomKB);
                        // check điều kiện áp dụng
                        // lọc điều kiện áp dụng
                        UpdateContext({errorMsg: ""});
                        // lọc điều kiện
                        // lấy danh sách các điều kiện áp dụng còn hoạt động và ngày hợp đồng nằm trong khoảng hiệu lực
                        ClearCollect (
                            tmpDieuKien,
                            Filter(
                                DL_DIEUKIEN_APDUNG,
                                TRANG_THAI = "true" && DateValue(HIEU_LUC_TU) <= DateValue(dpNgayHDNHD.SelectedDate)
                            )
                        );
                        ClearCollect(
                            tmpError,
                            {}
                        );
                        RemoveIf(
                            tmpError,
                            1 = 1
                        );
                        ClearCollect(
                            tmpPass,
                            {}
                        );
                        ClearCollect(
                            dsCombosp,
                            {}
                        );
                        ClearCollect(
                            dsCombospLt,
                            {}
                        );
                        ClearCollect(
                            GroupedSp,
                            {}
                        );
                        ClearCollect(
                            dsSpKetHop,
                            {}
                        );
                        RemoveIf(
                            tmpPass,
                            1 = 1
                        );
                        // NẾU K TÌM THẤY ĐIỀU KIỆN THÌ MẶC ĐỊNH LÀ CÓ
                        If(CountRows(tmpDieuKien) <=0 , Collect(
                                    tmpPass,
                                    {ma_dieu_kien: "1"}
                                ));
                        // nếu không có điều kiện thỏa mãn thì mặc định 
                        ForAll(
                            tmpDieuKien As dk,
                        //1. kiểm tra kênh bán   
                        //1.1. kiểm tra mã kênh bán
                        // Nếu kênh bán áp dụng cho tất cả và có loại trừ
                        // Tìm giá trị loại trừ mã kênh bán, loại kênh bán, cá nhân/tổ chức, nếu có dữ liệu thì false
                            RemoveIf(
                                tmpError,
                                1 = 1
                            );
                            RemoveIf(
                                dsCombosp,
                                1 = 1
                            );
                            RemoveIf(
                                dsSpKetHop,
                                1 = 1
                            );
                            RemoveIf(
                                GroupedSp,
                                1 = 1
                            );
                            If(
                                IsBlank(
                                    LookUp(
                                        dlDKADLoaiCTCCSCollect,
                                        MA_DIEU_KIEN = dk.MA_DIEU_KIEN && THANH_PHAN = "KB" && AP_DUNG = "1" && MA_TIEU_CHI = "MA_KB_DM"
                                    )
                                ) And !IsBlank(
                                    LookUp(
                                        dlDKADLoaiCTCCSCollect,
                                        MA_DIEU_KIEN = dk.MA_DIEU_KIEN && THANH_PHAN = "KB" && AP_DUNG = "2" && MA_TIEU_CHI = "MA_KB_DM" && MA_GIA_TRI = cbxMaKBNHD.Selected.MA_KENH_BAN
                                    )
                                ) And !IsBlank(cbxMaKBNHD.Selected.MA_KENH_BAN),
                                Collect(
                                    tmpError,
                                    {ID: 1}
                                );
                            );
                            
                        // Nếu kênh bán áp dụng 1 phần
                        // Tìm trong danh sách áp dụng theo mã kênh bán, loại kênh bán, cá nhân/tổ chức, nếu không có thì false
                        If(
                                !IsBlank(
                                    LookUp(
                                        dlDKADLoaiCTCCSCollect,
                                        MA_DIEU_KIEN = dk.MA_DIEU_KIEN && THANH_PHAN = "KB" && AP_DUNG = "1" && KIEU = "2" && MA_TIEU_CHI = "MA_KB_DM"
                                    )
                                ) And IsBlank(
                                    LookUp(
                                        dlDKADLoaiCTCCSCollect,
                                        MA_DIEU_KIEN = dk.MA_DIEU_KIEN && THANH_PHAN = "KB" && AP_DUNG = "1" && KIEU = "2" && MA_TIEU_CHI = "MA_KB_DM" && MA_GIA_TRI = cbxMaKBNHD.Selected.MA_KENH_BAN
                                    )
                                ) And !IsBlank(cbxMaKBNHD.Selected.MA_KENH_BAN),
                                Collect(
                                    tmpError,
                                    {ID: 2}
                                );
                            );
                            
                        // Nếu kênh bán áp dụng 1 phần
                        // Tìm trong danh sách áp dụng theo mã kênh bán nếu có dữ liệu
                        // Tìm trong danh sách loại trừ theo mã kênh bán nếu có dữ liệu thì -> false, nếu không có thì  -> pass
                        If(
                                !IsBlank(
                                    LookUp(
                                        dlDKADLoaiCTCCSCollect,
                                        MA_DIEU_KIEN = dk.MA_DIEU_KIEN && THANH_PHAN = "KB" && AP_DUNG = "1" && KIEU = "2" && MA_TIEU_CHI = "MA_KB_DM" && MA_GIA_TRI = cbxMaKBNHD.Selected.MA_KENH_BAN
                                    )
                                ) And !IsBlank(
                                    LookUp(
                                        dlDKADLoaiCTCCSCollect,
                                        MA_DIEU_KIEN = dk.MA_DIEU_KIEN && THANH_PHAN = "KB" && AP_DUNG = "2" && MA_TIEU_CHI = "MA_KB_DM" && MA_GIA_TRI = cbxMaKBNHD.Selected.MA_KENH_BAN
                                    )
                                ) And !IsBlank(cbxMaKBNHD.Selected.MA_KENH_BAN),
                                Collect(
                                    tmpError,
                                    {ID: 3}
                                );
                            );
                            
                        //1.2. kiểm tra loại kênh bán
                        // Nếu kênh bán áp dụng cho tất cả và có loại trừ
                        // Tìm giá trị loại trừ loại kênh bán nếu có dữ liệu thì false
                        If(
                                IsBlank(
                                    LookUp(
                                        dlDKADLoaiCTCCSCollect,
                                        MA_DIEU_KIEN = dk.MA_DIEU_KIEN && THANH_PHAN = "KB" && AP_DUNG = "1" && MA_TIEU_CHI = "MA_KB_LOAI"
                                    )
                                ) And !IsBlank(
                                    LookUp(
                                        dlDKADLoaiCTCCSCollect,
                                        MA_DIEU_KIEN = dk.MA_DIEU_KIEN && THANH_PHAN = "KB" && AP_DUNG = "2" && MA_TIEU_CHI = "MA_KB_LOAI" && MA_GIA_TRI = cbxLoaiKBNHD.Selected.MA_LOAI_KB
                                    )
                                ) And !IsBlank(cbxLoaiKBNHD.Selected.MA_LOAI_KB),
                                Collect(
                                    tmpError,
                                    {ID: 4}
                                );
                            );
                            
                        // Nếu kênh bán áp dụng 1 phần
                        // Tìm trong danh sách áp dụng theo mã kênh bán, loại kênh bán, cá nhân/tổ chức, nếu không có thì false
                        If(
                                !IsBlank(
                                    LookUp(
                                        dlDKADLoaiCTCCSCollect,
                                        MA_DIEU_KIEN = dk.MA_DIEU_KIEN && THANH_PHAN = "KB" && AP_DUNG = "1" && KIEU = "2" && MA_TIEU_CHI = "MA_KB_LOAI"
                                    )
                                ) And IsBlank(
                                    LookUp(
                                        dlDKADLoaiCTCCSCollect,
                                        MA_DIEU_KIEN = dk.MA_DIEU_KIEN && THANH_PHAN = "KB" && AP_DUNG = "1" && KIEU = "2" && MA_TIEU_CHI = "MA_KB_LOAI" && MA_GIA_TRI = cbxLoaiKBNHD.Selected.MA_LOAI_KB
                                    )
                                ) And !IsBlank(cbxLoaiKBNHD.Selected.MA_LOAI_KB),
                                Collect(
                                    tmpError,
                                    {ID: 5}
                                );
                            );
                            
                        // Nếu kênh bán áp dụng 1 phần
                        // Tìm trong danh sách áp dụng theo mã kênh bán, loại kênh bán, cá nhân/tổ chức, nếu có dữ liệu
                        // Tìm trong danh sách loại trừ (theo mã kênh bán, loại kênh bán, cá nhân/tổ chức) nếu có dữ liệu thì -> false, nếu không có thì  -> pass
                        If(
                                !IsBlank(
                                    LookUp(
                                        dlDKADLoaiCTCCSCollect,
                                        MA_DIEU_KIEN = dk.MA_DIEU_KIEN && THANH_PHAN = "KB" && AP_DUNG = "1" && KIEU = "2" && MA_TIEU_CHI = "MA_KB_LOAI" && MA_GIA_TRI = cbxMaKBNHD.Selected.MA_KENH_BAN
                                    )
                                ) And !IsBlank(
                                    LookUp(
                                        dlDKADLoaiCTCCSCollect,
                                        MA_DIEU_KIEN = dk.MA_DIEU_KIEN && THANH_PHAN = "KB" && AP_DUNG = "2" && (MA_GIA_TRI = cbxLoaiKBNHD.Selected.MA_LOAI_KB Or MA_GIA_TRI = cbxMaKBNHD.Selected.MA_KENH_BAN)
                                    )
                                ) And !IsBlank(cbxLoaiKBNHD.Selected.MA_LOAI_KB),
                                Collect(
                                    tmpError,
                                    {ID: 6}
                                );
                            );
                            
                        //1.3. kiểm tra nhóm KB
                        // Nếu kênh bán áp dụng cho tất cả và có loại trừ
                        // Tìm giá trị loại trừ  cá nhân/tổ chức, nếu có dữ liệu thì false
                        If(
                                IsBlank(
                                    LookUp(
                                        dlDKADLoaiCTCCSCollect,
                                        MA_DIEU_KIEN = dk.MA_DIEU_KIEN && THANH_PHAN = "KB" && AP_DUNG = "1" && MA_TIEU_CHI = "MA_KB_NHOM"
                                    )
                                ) And !IsBlank(
                                    LookUp(
                                        dlDKADLoaiCTCCSCollect,
                                        MA_DIEU_KIEN = dk.MA_DIEU_KIEN && THANH_PHAN = "KB" && AP_DUNG = "2" && MA_TIEU_CHI = "MA_KB_NHOM" && MA_GIA_TRI = nhomKB
                                    )
                                ) And !IsBlank(cbxMaKBNHD.Selected.MA_KENH_BAN),
                                Collect(
                                    tmpError,
                                    {ID: 7}
                                );
                            );
                            
                        // Nếu kênh bán áp dụng 1 phần
                        // Tìm trong danh sách áp dụng theo mã kênh bán, loại kênh bán, cá nhân/tổ chức, nếu không có thì false
                        If(
                                !IsBlank(
                                    LookUp(
                                        dlDKADLoaiCTCCSCollect,
                                        MA_DIEU_KIEN = dk.MA_DIEU_KIEN && THANH_PHAN = "KB" && AP_DUNG = "1" && KIEU = "2" && MA_TIEU_CHI = "MA_KB_NHOM"
                                    )
                                ) And IsBlank(
                                    LookUp(
                                        dlDKADLoaiCTCCSCollect,
                                        MA_DIEU_KIEN = dk.MA_DIEU_KIEN && THANH_PHAN = "KB" && AP_DUNG = "1" && KIEU = "2" && MA_TIEU_CHI = "MA_KB_NHOM" && MA_GIA_TRI = nhomKB
                                    )
                                ) And !IsBlank(cbxMaKBNHD.Selected.MA_KENH_BAN),
                                Collect(
                                    tmpError,
                                    {ID: 8}
                                );
                            );
                            
                        // Nếu kênh bán áp dụng 1 phần
                        // Tìm trong danh sách áp dụng theo mã kênh bán nếu có dữ liệu
                        // Tìm trong danh sách loại trừ theo mã kênh bán nếu có dữ liệu thì -> false, nếu không có thì  -> pass
                        If(
                                !IsBlank(
                                    LookUp(
                                        dlDKADLoaiCTCCSCollect,
                                        MA_DIEU_KIEN = dk.MA_DIEU_KIEN && THANH_PHAN = "KB" && AP_DUNG = "1" && KIEU = "2" && MA_TIEU_CHI = "MA_KB_NHOM" && MA_GIA_TRI = nhomKB
                                    )
                                ) And !IsBlank(
                                    LookUp(
                                        dlDKADLoaiCTCCSCollect,
                                        MA_DIEU_KIEN = dk.MA_DIEU_KIEN && THANH_PHAN = "KB" && AP_DUNG = "2" && MA_TIEU_CHI = "MA_KB_NHOM" && MA_GIA_TRI = nhomKB
                                    )
                                ) And !IsBlank(cbxMaKBNHD.Selected.MA_KENH_BAN),
                                Collect(
                                    tmpError,
                                    {ID: 9}
                                );
                            );
                            
                        //2. Kiểm tra khách hàng     
                        //2.1. kiểm tra nhóm Kh
                        // Nếu kênh bán áp dụng cho tất cả và có loại trừ
                        // Tìm giá trị loại trừ  cá nhân/tổ chức, nếu có dữ liệu thì false
                        If(
                                IsBlank(
                                    LookUp(
                                        dlDKADLoaiCTCCSCollect,
                                        MA_DIEU_KIEN = dk.MA_DIEU_KIEN && THANH_PHAN = "KH" && AP_DUNG = "1" && MA_TIEU_CHI = "MA_KH_LOAI"
                                    )
                                ) And !IsBlank(
                                    LookUp(
                                        dlDKADLoaiCTCCSCollect,
                                        MA_DIEU_KIEN = dk.MA_DIEU_KIEN && THANH_PHAN = "KH" && AP_DUNG = "2" && MA_TIEU_CHI = "MA_KH_LOAI" && MA_GIA_TRI = cbxLoaiKHNHD.Selected.value
                                    )
                                ) And !IsBlank(cbxLoaiKHNHD.Selected.value),
                                Collect(
                                    tmpError,
                                    {ID: 10}
                                );
                            );
                            
                        // Nếu kênh bán áp dụng 1 phần
                        // Tìm trong danh sách áp dụng theo mã kênh bán, loại kênh bán, cá nhân/tổ chức, nếu không có thì false
                        If(
                                !IsBlank(
                                    LookUp(
                                        dlDKADLoaiCTCCSCollect,
                                        MA_DIEU_KIEN = dk.MA_DIEU_KIEN && THANH_PHAN = "KH" && AP_DUNG = "1" && KIEU = "2" && MA_TIEU_CHI = "MA_KH_LOAI"
                                    )
                                ) And IsBlank(
                                    LookUp(
                                        dlDKADLoaiCTCCSCollect,
                                        MA_DIEU_KIEN = dk.MA_DIEU_KIEN && THANH_PHAN = "KH" && AP_DUNG = "1" && KIEU = "2" && MA_TIEU_CHI = "MA_KH_LOAI" && MA_GIA_TRI = cbxLoaiKHNHD.Selected.value
                                    )
                                ) And !IsBlank(cbxLoaiKHNHD.Selected.value),
                                Collect(
                                    tmpError,
                                    {ID: 11}
                                );
                            );
                            
                        // Nếu kênh bán áp dụng 1 phần
                        // Tìm trong danh sách áp dụng theo mã kênh bán nếu có dữ liệu
                        // Tìm trong danh sách loại trừ theo mã kênh bán nếu có dữ liệu thì -> false, nếu không có thì  -> pass
                        If(
                                !IsBlank(
                                    LookUp(
                                        dlDKADLoaiCTCCSCollect,
                                        MA_DIEU_KIEN = dk.MA_DIEU_KIEN && THANH_PHAN = "KH" && AP_DUNG = "1" && KIEU = "2" && MA_TIEU_CHI = "MA_KH_LOAI" && MA_GIA_TRI = cbxLoaiKHNHD.Selected.value
                                    )
                                ) And !IsBlank(
                                    LookUp(
                                        dlDKADLoaiCTCCSCollect,
                                        MA_DIEU_KIEN = dk.MA_DIEU_KIEN && THANH_PHAN = "KH" && AP_DUNG = "2" && MA_TIEU_CHI = "MA_KH_LOAI" && MA_GIA_TRI = cbxLoaiKHNHD.Selected.value
                                    )
                                ) And !IsBlank(cbxLoaiKHNHD.Selected.value),
                                Collect(
                                    tmpError,
                                    {ID: 12}
                                );
                            );
                            
                        //3. Kiểm tra phạm vi
                        //3.1 Kiểm tra tỉnh/thành phố
                        // Nếu áp dụng cho tất cả và có loại trừ
                        // Tìm giá trị loại trừ tỉnh hoặc mã cấp cha của tỉnh nếu có dữ liệu thì false
                        If(
                                IsBlank(
                                    LookUp(
                                        dlDKADLoaiCTCCSCollect,
                                        MA_DIEU_KIEN = dk.MA_DIEU_KIEN && THANH_PHAN = "PV" && AP_DUNG = "1" && (MA_TIEU_CHI = "MA_TINH_TP" Or MA_TIEU_CHI = "MA_VUNG_MIEN")
                                    )
                                ) And !IsBlank(
                                    LookUp(
                                        dlDKADLoaiCTCCSCollect,
                                        MA_DIEU_KIEN = dk.MA_DIEU_KIEN && THANH_PHAN = "PV" && AP_DUNG = "2" && (MA_TIEU_CHI = "MA_TINH_TP" Or MA_TIEU_CHI = "MA_VUNG_MIEN")
                                    )
                                ) And !IsBlank(
                                    LookUp(
                                        dlDKADLoaiCTCCSCollect,
                                        MA_DIEU_KIEN = dk.MA_DIEU_KIEN && THANH_PHAN = "PV" && AP_DUNG = "2" && (MA_GIA_TRI = cbxTinhNHD.Selected.MA_PHAMVI Or MA_GIA_TRI = cbxTinhNHD.Selected.MA_CHA)
                                    )
                                ) And !IsBlank(cbxTinhNHD.Selected.MA_PHAMVI),
                                Collect(
                                    tmpError,
                                    {ID: 13}
                                );
                            );
                            
                        // Nếu phạm vi áp dụng 1 phần
                        // Tìm trong danh sách áp dụng theo tỉnh/thành phố hoặc là mã cha của tỉnh/thành phố nếu không có thì false
                        If(
                                !IsBlank(
                                    LookUp(
                                        dlDKADLoaiCTCCSCollect,
                                        MA_DIEU_KIEN = dk.MA_DIEU_KIEN && THANH_PHAN = "PV" && AP_DUNG = "1" && KIEU = "2" && (MA_TIEU_CHI = "MA_TINH_TP" Or MA_TIEU_CHI = "MA_VUNG_MIEN")
                                    )
                                ) And IsBlank(
                                    LookUp(
                                        dlDKADLoaiCTCCSCollect,
                                        MA_DIEU_KIEN = dk.MA_DIEU_KIEN && THANH_PHAN = "PV" && AP_DUNG = "1" && KIEU = "2" && (MA_GIA_TRI = cbxTinhNHD.Selected.MA_PHAMVI Or MA_GIA_TRI = cbxTinhNHD.Selected.MA_CHA)
                                    )
                                ) And !IsBlank(cbxTinhNHD.Selected.MA_PHAMVI),
                                Collect(
                                    tmpError,
                                    {ID: 14}
                                );
                            );
                            
                        // Nếu phạm vi áp dụng 1 phần
                        // Tìm trong danh sách áp dụng theo tỉnh/thành phố hoặc mã cha của tỉnh/thành phố nếu có dữ liệu
                        // Tìm trong danh sách loại trừ theo tỉnh/thành phố và mã cha của tỉnh/thành phố nếu có dữ liệu thì -> false, nếu không có thì  -> pass
                        If(
                                !IsBlank(
                                    LookUp(
                                        dlDKADLoaiCTCCSCollect,
                                        MA_DIEU_KIEN = dk.MA_DIEU_KIEN && THANH_PHAN = "PV" && AP_DUNG = "1" && KIEU = "2" && (MA_TIEU_CHI = "MA_TINH_TP" Or MA_TIEU_CHI = "MA_VUNG_MIEN")
                                    )
                                ) And !IsBlank(
                                    LookUp(
                                        dlDKADLoaiCTCCSCollect,
                                        MA_DIEU_KIEN = dk.MA_DIEU_KIEN && THANH_PHAN = "PV" && AP_DUNG = "1" && KIEU = "2" && (MA_GIA_TRI = cbxTinhNHD.Selected.MA_PHAMVI Or MA_GIA_TRI = cbxTinhNHD.Selected.MA_CHA)
                                    )
                                ) And !IsBlank(
                                    LookUp(
                                        dlDKADLoaiCTCCSCollect,
                                        MA_DIEU_KIEN = dk.MA_DIEU_KIEN && THANH_PHAN = "PV" && AP_DUNG = "2" && (MA_GIA_TRI = cbxTinhNHD.Selected.MA_PHAMVI Or MA_GIA_TRI = cbxTinhNHD.Selected.MA_CHA)
                                    )
                                ) And !IsBlank(cbxTinhNHD.Selected.MA_PHAMVI),
                                Collect(
                                    tmpError,
                                    {ID: 15}
                                );
                            );
                            
                        //3.2 Kiểm tra đơn vị quản lý hợp đồng
                        // Nếu áp dụng cho tất cả và có loại trừ
                        // Tìm giá trị loại trừ đơn vị quản lý hợp đồng nếu có dữ liệu thì false
                        If(
                                IsBlank(
                                    LookUp(
                                        dlDKADLoaiCTCCSCollect,
                                        MA_DIEU_KIEN = dk.MA_DIEU_KIEN && THANH_PHAN = "PV" && AP_DUNG = "1" && MA_TIEU_CHI = "MA_DON_VI"
                                    )
                                ) And !IsBlank(
                                    LookUp(
                                        dlDKADLoaiCTCCSCollect,
                                        MA_DIEU_KIEN = dk.MA_DIEU_KIEN && THANH_PHAN = "PV" && AP_DUNG = "2" && MA_TIEU_CHI = "MA_DON_VI" && MA_GIA_TRI = cbxDVQLNHD.Selected.MA_PHAMVI
                                    )
                                ) And !IsBlank(cbxDVQLNHD.Selected.MA_PHAMVI),
                                Collect(
                                    tmpError,
                                    {ID: 16}
                                );
                            );
                            
                        // Nếu phạm vi áp dụng 1 phần
                        // Tìm trong danh sách áp dụng đơn vị quản lý hợp đồng không có thì false
                        If(
                                !IsBlank(
                                    LookUp(
                                        dlDKADLoaiCTCCSCollect,
                                        MA_DIEU_KIEN = dk.MA_DIEU_KIEN && THANH_PHAN = "PV" && AP_DUNG = "1" && KIEU = "2" && MA_TIEU_CHI = "MA_DON_VI"
                                    )
                                ) And IsBlank(
                                    LookUp(
                                        dlDKADLoaiCTCCSCollect,
                                        MA_DIEU_KIEN = dk.MA_DIEU_KIEN && THANH_PHAN = "PV" && AP_DUNG = "1" && KIEU = "2" && MA_GIA_TRI = cbxDVQLNHD.Selected.MA_PHAMVI
                                    )
                                ) And !IsBlank(cbxDVQLNHD.Selected.MA_PHAMVI),
                                Collect(
                                    tmpError,
                                    {ID: 17}
                                );
                            );
                            
                        // Nếu phạm vi áp dụng 1 phần
                        // Tìm trong danh sách áp dụng theo đơn vị quản lý hợp đồng nếu có dữ liệu
                        // Tìm trong danh sách loại trừ theo đơn vị quản lý hợp đồng nếu có dữ liệu thì -> false, nếu không có thì  -> pass
                        If(
                                !IsBlank(
                                    LookUp(
                                        dlDKADLoaiCTCCSCollect,
                                        MA_DIEU_KIEN = dk.MA_DIEU_KIEN && THANH_PHAN = "PV" && AP_DUNG = "1" && KIEU = "2" && MA_TIEU_CHI = "MA_DON_VI" && MA_GIA_TRI = cbxDVQLNHD.Selected.MA_PHAMVI
                                    )
                                ) And !IsBlank(
                                    LookUp(
                                        dlDKADLoaiCTCCSCollect,
                                        MA_DIEU_KIEN = dk.MA_DIEU_KIEN && THANH_PHAN = "PV" && AP_DUNG = "2" && MA_TIEU_CHI = "MA_DON_VI" && MA_GIA_TRI = cbxDVQLNHD.Selected.MA_PHAMVI
                                    )
                                ) And !IsBlank(cbxDVQLNHD.Selected.MA_PHAMVI),
                                Collect(
                                    tmpError,
                                    {ID: 18}
                                );
                            );
                            
                        //4. Kiểm tra sản phẩm
                        ForAll(
                                Gallery3_2.AllItems As sp,
                                    // 4.1.1 Kiểm tra thông tin sản phẩm
                        // Nếu sản phẩm áp dụng cho tất cả và có loại trừ
                        // Tìm giá trị loại trừ mã sản phẩm nếu có dữ liệu thì false
                                If(
                                    IsBlank(
                                        LookUp(
                                            dlDKADLoaiCTCCSCollect,
                                            MA_DIEU_KIEN = dk.MA_DIEU_KIEN && THANH_PHAN = "SP" && AP_DUNG = "1" && MA_TIEU_CHI = "MA_SP"
                                        )
                                    ) And !IsBlank(
                                        LookUp(
                                            dlDKADLoaiCTCCSCollect,
                                            MA_DIEU_KIEN = dk.MA_DIEU_KIEN && THANH_PHAN = "SP" && AP_DUNG = "2" && MA_TIEU_CHI = "MA_SP" && MA_GIA_TRI = sp.cbxMaSPNHD.Selected.MA_SAN_PHAM
                                        )
                                    ) And !IsBlank(sp.cbxMaSPNHD.Selected.MA_SAN_PHAM),
                                    Collect(
                                        tmpError,
                                        {ID: 19}
                                    );
                                );
                                    // Nếu sản phẩm áp dụng 1 phần
                        // Tìm trong danh sách áp dụng theo mã sản phẩm nếu không có thì false
                        If(
                                    !IsBlank(
                                        LookUp(
                                            dlDKADLoaiCTCCSCollect,
                                            MA_DIEU_KIEN = dk.MA_DIEU_KIEN && THANH_PHAN = "SP" && AP_DUNG = "1" && MA_TIEU_CHI = "MA_SP"
                                        )
                                    ) And IsBlank(
                                        LookUp(
                                            dlDKADLoaiCTCCSCollect,
                                            MA_DIEU_KIEN = dk.MA_DIEU_KIEN && THANH_PHAN = "SP" && AP_DUNG = "1" && MA_TIEU_CHI = "MA_SP" && KIEU = "2" && MA_GIA_TRI = sp.cbxMaSPNHD.Selected.MA_SAN_PHAM
                                        )
                                    ) And !IsBlank(sp.cbxMaSPNHD.Selected.MA_SAN_PHAM),
                                    Collect(
                                        tmpError,
                                        {ID: 20}
                                    );
                                );
                                
                        // Nếu sản phẩm áp dụng 1 phần
                        // Tìm trong danh sách áp dụng theo mã sản phẩm nếu có dữ liệu
                        // Tìm trong danh sách loại trừ theo mã sản phẩm nếu có dữ liệu thì -> false, nếu không có thì  -> pass
                        If(
                                    !IsBlank(
                                        LookUp(
                                            dlDKADLoaiCTCCSCollect,
                                            MA_DIEU_KIEN = dk.MA_DIEU_KIEN && THANH_PHAN = "SP" && AP_DUNG = "1" && MA_TIEU_CHI = "MA_SP" && MA_GIA_TRI = sp.cbxMaSPNHD.Selected.MA_SAN_PHAM
                                        )
                                    ) And !IsBlank(
                                        LookUp(
                                            dlDKADLoaiCTCCSCollect,
                                            MA_DIEU_KIEN = dk.MA_DIEU_KIEN && THANH_PHAN = "SP" && AP_DUNG = "2" && MA_TIEU_CHI = "MA_SP" && MA_GIA_TRI = sp.cbxMaSPNHD.Selected.MA_SAN_PHAM
                                        )
                                    ) And !IsBlank(sp.cbxMaSPNHD.Selected.MA_SAN_PHAM),
                                    Collect(
                                        tmpError,
                                        {ID: 21}
                                    );
                                );
                                // 4.1.2 Kiểm tra thông tin chương trình
                        // Nếu chương trình áp dụng cho tất cả và có loại trừ
                        // Tìm giá trị loại trừ chương trình nếu có dữ liệu thì false
                        If(
                                    IsBlank(
                                        LookUp(
                                            dlDKADLoaiCTCCSCollect,
                                            MA_DIEU_KIEN = dk.MA_DIEU_KIEN && THANH_PHAN = "SP" && AP_DUNG = "1" && MA_TIEU_CHI = "MA_CT"
                                        )
                                    ) And !IsBlank(
                                        LookUp(
                                            dlDKADLoaiCTCCSCollect,
                                            MA_DIEU_KIEN = dk.MA_DIEU_KIEN && THANH_PHAN = "SP" && AP_DUNG = "2" && MA_TIEU_CHI = "MA_CT" && 
                                            MA_GIA_TRI = sp.cbxMaCTNHDHide.Selected.MA_CHUONG_TRINH
                                        )
                                    ) And !IsBlank(sp.cbxMaCTNHDHide.Selected.MA_CHUONG_TRINH),
                                    Collect(
                                        tmpError,
                                        {ID: 22}
                                    );
                                );
                                    // Nếu sản phẩm áp dụng 1 phần
                        // Tìm trong danh sách áp dụng theo mã sản phẩm nếu không có thì false
                        If(
                                    !IsBlank(
                                        LookUp(
                                            dlDKADLoaiCTCCSCollect,
                                            MA_DIEU_KIEN = dk.MA_DIEU_KIEN && THANH_PHAN = "SP" && AP_DUNG = "1" && MA_TIEU_CHI = "MA_CT"
                                        )
                                    ) And IsBlank(
                                        LookUp(
                                            dlDKADLoaiCTCCSCollect,
                                            MA_DIEU_KIEN = dk.MA_DIEU_KIEN && THANH_PHAN = "SP" && AP_DUNG = "1" && MA_TIEU_CHI = "MA_CT" && KIEU = "2" && MA_GIA_TRI = sp.cbxMaCTNHDHide.Selected.MA_CHUONG_TRINH
                                        )
                                    ) And !IsBlank(sp.cbxMaCTNHDHide.Selected.MA_CHUONG_TRINH),
                                    Collect(
                                        tmpError,
                                        {ID: 23}
                                    );
                                );
                                    // Nếu chương trình áp dụng 1 phần
                        // Tìm trong danh sách áp dụng theo mã chương trình nếu có dữ liệu
                        // Tìm trong danh sách loại trừ theo mã chương trình nếu có dữ liệu thì -> false, nếu không có thì  -> pass
                        If(
                                    !IsBlank(
                                        LookUp(
                                            dlDKADLoaiCTCCSCollect,
                                            MA_DIEU_KIEN = dk.MA_DIEU_KIEN && THANH_PHAN = "SP" && AP_DUNG = "1" && MA_TIEU_CHI = "MA_CT" && MA_GIA_TRI = sp.cbxMaCTNHDHide.Selected.MA_CHUONG_TRINH
                                        )
                                    ) And !IsBlank(
                                        LookUp(
                                            dlDKADLoaiCTCCSCollect,
                                            MA_DIEU_KIEN = dk.MA_DIEU_KIEN && THANH_PHAN = "SP" && AP_DUNG = "2" && MA_TIEU_CHI = "MA_CT" && MA_GIA_TRI = sp.cbxMaCTNHDHide.Selected.MA_CHUONG_TRINH
                                        )
                                    ) And !IsBlank(sp.cbxMaCTNHDHide.Selected.MA_CHUONG_TRINH),
                                    Collect(
                                        tmpError,
                                        {ID: 24}
                                    );
                                );
                         // 4.1.3 Kiểm tra thông tin LHNV
                        // Nếu LHNV áp dụng cho tất cả và có loại trừ
                        // Tìm giá trị loại trừ LHNV nếu có dữ liệu thì false
                        If(
                                    IsBlank(
                                        LookUp(
                                            dlDKADLoaiCTCCSCollect,
                                            MA_DIEU_KIEN = dk.MA_DIEU_KIEN && THANH_PHAN = "SP" && AP_DUNG = "1" && MA_TIEU_CHI = "LHNV"
                                        )
                                    ) And !IsBlank(
                                        LookUp(
                                            dlDKADLoaiCTCCSCollect,
                                            MA_DIEU_KIEN = dk.MA_DIEU_KIEN && THANH_PHAN = "SP" && AP_DUNG = "2" && MA_TIEU_CHI = "LHNV" 
                                            && TEN_GIA_TRI = LookUp(DL_SAN_PHAM,MA_SAN_PHAM=cbxMaSPNHD.Selected.MA_SAN_PHAM,LHNV)
                                        )
                                    ) And !IsBlank(LookUp(DL_SAN_PHAM,MA_SAN_PHAM=cbxMaSPNHD.Selected.MA_SAN_PHAM,LHNV)),
                                    Collect(
                                        tmpError,
                                        {ID: 25}
                                    );
                                );
                                    // Nếu sản phẩm áp dụng 1 phần
                        // Tìm trong danh sách áp dụng theo mã sản phẩm nếu không có thì false
                        If(
                                    !IsBlank(
                                        LookUp(
                                            dlDKADLoaiCTCCSCollect,
                                            MA_DIEU_KIEN = dk.MA_DIEU_KIEN && THANH_PHAN = "SP" && AP_DUNG = "1" && MA_TIEU_CHI = "LHNV"
                                        )
                                    ) And IsBlank(
                                        LookUp(
                                            dlDKADLoaiCTCCSCollect,
                                            MA_DIEU_KIEN = dk.MA_DIEU_KIEN && THANH_PHAN = "SP" && AP_DUNG = "1" && MA_TIEU_CHI = "LHNV" && KIEU = "2" && 
                                            TEN_GIA_TRI = LookUp(DL_SAN_PHAM,MA_SAN_PHAM=cbxMaSPNHD.Selected.MA_SAN_PHAM,LHNV)
                                        )
                                    ) And !IsBlank(LookUp(DL_SAN_PHAM,MA_SAN_PHAM=cbxMaSPNHD.Selected.MA_SAN_PHAM,LHNV)),
                                    Collect(
                                        tmpError,
                                        {ID: 26}
                                    );
                                );
                                    // Nếu chương trình áp dụng 1 phần
                        // Tìm trong danh sách áp dụng theo mã chương trình nếu có dữ liệu
                        // Tìm trong danh sách loại trừ theo mã chương trình nếu có dữ liệu thì -> false, nếu không có thì  -> pass
                        If(
                                    !IsBlank(
                                        LookUp(
                                            dlDKADLoaiCTCCSCollect,
                                            MA_DIEU_KIEN = dk.MA_DIEU_KIEN && THANH_PHAN = "SP" && AP_DUNG = "1" && MA_TIEU_CHI = "LHNV" && 
                                            TEN_GIA_TRI = LookUp(DL_SAN_PHAM,MA_SAN_PHAM=cbxMaSPNHD.Selected.MA_SAN_PHAM,LHNV)
                                        )
                                    ) And !IsBlank(
                                        LookUp(
                                            dlDKADLoaiCTCCSCollect,
                                            MA_DIEU_KIEN = dk.MA_DIEU_KIEN && THANH_PHAN = "SP" && AP_DUNG = "2" && MA_TIEU_CHI = "LHNV" && 
                                            TEN_GIA_TRI = LookUp(DL_SAN_PHAM,MA_SAN_PHAM=cbxMaSPNHD.Selected.MA_SAN_PHAM,LHNV)
                                        )
                                    ) And !IsBlank(LookUp(DL_SAN_PHAM,MA_SAN_PHAM=cbxMaSPNHD.Selected.MA_SAN_PHAM,LHNV)),
                                    Collect(
                                        tmpError,
                                        {ID: 27}
                                    );
                                );
                            );
                            
                        //4.1.4 Kiểm tra combo sản phẩm
                        ForAll(
                                Gallery3_2.AllItems As sp,
                                Collect(
                                    dsSpKetHop,
                                    {MA_SAN_PHAM: sp.cbxMaSPNHD.Selected.MA_SAN_PHAM}
                                )
                            );
                            ForAll(
                                Gallery3_1.AllItems As sp,
                                Collect(
                                    dsSpKetHop,
                                    {MA_SAN_PHAM: sp.tiMaSPLKNHD_1.Text}
                                )
                            );
                            Collect(
                                GroupedSp,
                                GroupBy(
                                    dsSpKetHop,
                                    "MA_SAN_PHAM",
                                    "Grouped"
                                )
                            );
                            If(
                                CountRows(GroupedSp) > 1,
                                Collect(
                                    dsCombosp,
                                    Filter(
                                        dlDKADLoaiCTCCSCollect,
                                        MA_GIA_TRI,
                                        MA_DIEU_KIEN = dk.MA_DIEU_KIEN && THANH_PHAN = "SP" && MA_TIEU_CHI = "MA_COMBO_SP" && AP_DUNG = "1"
                                    )
                                );
                                Collect(
                                    dsCombospLt,
                                    Filter(
                                        dlDKADLoaiCTCCSCollect,
                                        MA_GIA_TRI,
                                        MA_DIEU_KIEN = dk.MA_DIEU_KIEN && THANH_PHAN = "SP" && MA_TIEU_CHI = "MA_COMBO_SP" && AP_DUNG = "2"
                                    )
                                );
                                ForAll(
                                    GroupedSp As sp,
                                    RemoveIf(
                                        dsCombosp,
                                        cr282_ma_gia_tri = sp.MA_SAN_PHAM
                                    );
                                );
                                ForAll(
                                    GroupedSp As sp,
                                    RemoveIf(
                                        dsCombospLt,
                                        cr282_ma_gia_tri = sp.MA_SAN_PHAM
                                    );
                                );
                                
                        // Nếu COMBO áp dụng cho tất cả và có loại trừ
                        // Tìm giá trị loại trừ theo combo sản phẩm nếu có dữ liệu thì false
                        If(
                                    IsBlank(
                                        LookUp(
                                            dlDKADLoaiCTCCSCollect,
                                            MA_DIEU_KIEN = dk.MA_DIEU_KIEN && THANH_PHAN = "SP" && AP_DUNG = "1" && MA_TIEU_CHI = "MA_COMBO_SP"
                                        )
                                    ) And !IsBlank(
                                        LookUp(
                                            dlDKADLoaiCTCCSCollect,
                                            MA_DIEU_KIEN = dk.MA_DIEU_KIEN && THANH_PHAN = "SP" && AP_DUNG = "2" && MA_TIEU_CHI = "MA_COMBO_SP"
                                        )
                                    ) And CountRows(dsCombospLt) = 0 And CountRows(GroupedSp) = CountRows(
                                        Filter(
                                            dlDKADLoaiCTCCSCollect,
                                            MA_DIEU_KIEN = dk.MA_DIEU_KIEN && THANH_PHAN = "SP" && AP_DUNG = "2" && MA_TIEU_CHI = "MA_COMBO_SP"
                                        )
                                    ),
                                    Collect(
                                        tmpError,
                                        {ID: 28}
                                    );
                                );
                                
                        // Nếu combo sản phẩm áp dụng 1 phần
                        // Tìm trong danh sách áp dụng theo COMBO SẢN PHẨM nếu không khớp có thì false
                        If(
                                    !IsBlank(
                                        LookUp(
                                            dlDKADLoaiCTCCSCollect,
                                            MA_DIEU_KIEN = dk.MA_DIEU_KIEN && THANH_PHAN = "SP" && AP_DUNG = "1" && MA_TIEU_CHI = "MA_COMBO_SP"
                                        )
                                    ) And (CountRows(dsCombosp) <> 0),
                                    Collect(
                                        tmpError,
                                        {ID: 29}
                                    );
                                );
                            );
                            
                        // nếu điều kiện nào không lỗi thì đưa vào danh sách
                        If(
                                CountRows(tmpError) <= 0,
                                Collect(
                                    tmpPass,
                                    {ma_dieu_kien: dk.MA_DIEU_KIEN}
                                );
                            )
                        );
                        // end điều kiện áp dụng
                        // lấy chính sách áp dụng
                        UpdateContext({errorMsg: ""});
                        // lọc điều kiện
                        // lấy danh sách các điều kiện áp dụng còn hoạt động và ngày hợp đồng nằm trong khoảng hiệu lực
                        ClearCollect (
                            tmpChinhsach,
                            Filter(
                                DL_CHINHSACH_CHUNG,
                                HOAT_DONG = "true" && DateValue(HIEU_LUC_TU) <= DateValue(dpNgayHDNHD.SelectedDate)
                            )
                        );
                        ClearCollect(
                            tmpErrorCs,
                            {}
                        );
                        RemoveIf(
                            tmpErrorCs,
                            1 = 1
                        );
                        ClearCollect(
                            tmpPassCs,
                            {}
                        );
                        ClearCollect(
                            dsCombosp,
                            {}
                        );
                        ClearCollect(
                            dsCombospLt,
                            {}
                        );
                        ClearCollect(
                            GroupedSp,
                            {}
                        );
                        ClearCollect(
                            dsSpKetHop,
                            {}
                        );
                        RemoveIf(
                            tmpPassCs,
                            1 = 1
                        );
                        ForAll(
                            tmpChinhsach As dk,
                        //1. kiểm tra kênh bán   
                        //1.1. kiểm tra mã kênh bán
                        // Nếu kênh bán áp dụng cho tất cả và có loại trừ
                        // Tìm giá trị loại trừ mã kênh bán, loại kênh bán, cá nhân/tổ chức, nếu có dữ liệu thì false
                            RemoveIf(
                                tmpErrorCs,
                                1 = 1
                            );
                            RemoveIf(
                                dsCombosp,
                                1 = 1
                            );
                            RemoveIf(
                                dsCombospLt,
                                1 = 1
                            );
                            RemoveIf(
                                dsSpKetHop,
                                1 = 1
                            );
                            RemoveIf(
                                GroupedSp,
                                1 = 1
                            );
                            If(
                                IsBlank(
                                    LookUp(
                                        dlChinhSachDTCTCCSCollect,
                                        MA_CHINH_SACH = dk.MA_CHINH_SACH && THANH_PHAN = "KB" && AP_DUNG = "1" && MA_TIEU_CHI = "MA_KB_DM"
                                    )
                                ) And !IsBlank(
                                    LookUp(
                                        dlChinhSachDTCTCCSCollect,
                                        MA_CHINH_SACH = dk.MA_CHINH_SACH && THANH_PHAN = "KB" && AP_DUNG = "2" && MA_TIEU_CHI = "MA_KB_DM" && MA_GIA_TRI = cbxMaKBNHD.Selected.MA_KENH_BAN
                                    )
                                ) And !IsBlank(cbxMaKBNHD.Selected.MA_KENH_BAN),
                                Collect(
                                    tmpErrorCs,
                                    {ID: 1}
                                );
                            );
                            
                        // Nếu kênh bán áp dụng 1 phần
                        // Tìm trong danh sách áp dụng theo mã kênh bán, loại kênh bán, cá nhân/tổ chức, nếu không có thì false
                        If(
                                !IsBlank(
                                    LookUp(
                                        dlChinhSachDTCTCCSCollect,
                                        MA_CHINH_SACH = dk.MA_CHINH_SACH && THANH_PHAN = "KB" && AP_DUNG = "1" && KIEU = "2" && MA_TIEU_CHI = "MA_KB_DM"
                                    )
                                ) And IsBlank(
                                    LookUp(
                                        dlChinhSachDTCTCCSCollect,
                                        MA_CHINH_SACH = dk.MA_CHINH_SACH && THANH_PHAN = "KB" && AP_DUNG = "1" && KIEU = "2" && MA_TIEU_CHI = "MA_KB_DM" && MA_GIA_TRI = cbxMaKBNHD.Selected.MA_KENH_BAN
                                    )
                                ) And !IsBlank(cbxMaKBNHD.Selected.MA_KENH_BAN),
                                Collect(
                                    tmpErrorCs,
                                    {ID: 2}
                                );
                            );
                            
                        // Nếu kênh bán áp dụng 1 phần
                        // Tìm trong danh sách áp dụng theo mã kênh bán nếu có dữ liệu
                        // Tìm trong danh sách loại trừ theo mã kênh bán nếu có dữ liệu thì -> false, nếu không có thì  -> pass
                        If(
                                !IsBlank(
                                    LookUp(
                                        dlChinhSachDTCTCCSCollect,
                                        MA_CHINH_SACH = dk.MA_CHINH_SACH && THANH_PHAN = "KB" && AP_DUNG = "1" && KIEU = "2" && MA_TIEU_CHI = "MA_KB_DM" && MA_GIA_TRI = cbxMaKBNHD.Selected.MA_KENH_BAN
                                    )
                                ) And !IsBlank(
                                    LookUp(
                                        dlChinhSachDTCTCCSCollect,
                                        MA_CHINH_SACH = dk.MA_CHINH_SACH && THANH_PHAN = "KB" && AP_DUNG = "2" && MA_TIEU_CHI = "MA_KB_DM" && MA_GIA_TRI = cbxMaKBNHD.Selected.MA_KENH_BAN
                                    )
                                ) And !IsBlank(cbxMaKBNHD.Selected.MA_KENH_BAN),
                                Collect(
                                    tmpErrorCs,
                                    {ID: 3}
                                );
                            );
                            
                        //1.2. kiểm tra loại kênh bán
                        // Nếu kênh bán áp dụng cho tất cả và có loại trừ
                        // Tìm giá trị loại trừ loại kênh bán nếu có dữ liệu thì false
                        If(
                                IsBlank(
                                    LookUp(
                                        dlChinhSachDTCTCCSCollect,
                                        MA_CHINH_SACH = dk.MA_CHINH_SACH && THANH_PHAN = "KB" && AP_DUNG = "1" && MA_TIEU_CHI = "MA_KB_LOAI"
                                    )
                                ) And !IsBlank(
                                    LookUp(
                                        dlChinhSachDTCTCCSCollect,
                                        MA_CHINH_SACH = dk.MA_CHINH_SACH && THANH_PHAN = "KB" && AP_DUNG = "2" && MA_TIEU_CHI = "MA_KB_LOAI" && MA_GIA_TRI = cbxLoaiKBNHD.Selected.MA_LOAI_KB
                                    )
                                ) And !IsBlank(cbxLoaiKBNHD.Selected.MA_LOAI_KB),
                                Collect(
                                    tmpErrorCs,
                                    {ID: 4}
                                );
                            );
                            
                        // Nếu kênh bán áp dụng 1 phần
                        // Tìm trong danh sách áp dụng theo mã kênh bán, loại kênh bán, cá nhân/tổ chức, nếu không có thì false
                        If(
                                !IsBlank(
                                    LookUp(
                                        dlChinhSachDTCTCCSCollect,
                                        MA_CHINH_SACH = dk.MA_CHINH_SACH && THANH_PHAN = "KB" && AP_DUNG = "1" && KIEU = "2" && MA_TIEU_CHI = "MA_KB_LOAI"
                                    )
                                ) And IsBlank(
                                    LookUp(
                                        dlChinhSachDTCTCCSCollect,
                                        MA_CHINH_SACH = dk.MA_CHINH_SACH && THANH_PHAN = "KB" && AP_DUNG = "1" && KIEU = "2" && MA_TIEU_CHI = "MA_KB_LOAI" && MA_GIA_TRI = cbxLoaiKBNHD.Selected.MA_LOAI_KB
                                    )
                                ) And !IsBlank(cbxLoaiKBNHD.Selected.MA_LOAI_KB),
                                Collect(
                                    tmpErrorCs,
                                    {ID: 5}
                                );
                            );
                            
                        // Nếu kênh bán áp dụng 1 phần
                        // Tìm trong danh sách áp dụng theo mã kênh bán, loại kênh bán, cá nhân/tổ chức, nếu có dữ liệu
                        // Tìm trong danh sách loại trừ (theo mã kênh bán, loại kênh bán, cá nhân/tổ chức) nếu có dữ liệu thì -> false, nếu không có thì  -> pass
                        If(
                                !IsBlank(
                                    LookUp(
                                        dlChinhSachDTCTCCSCollect,
                                        MA_CHINH_SACH = dk.MA_CHINH_SACH && THANH_PHAN = "KB" && AP_DUNG = "1" && KIEU = "2" && MA_TIEU_CHI = "MA_KB_LOAI" && MA_GIA_TRI = cbxMaKBNHD.Selected.MA_KENH_BAN
                                    )
                                ) And !IsBlank(
                                    LookUp(
                                        dlChinhSachDTCTCCSCollect,
                                        MA_CHINH_SACH = dk.MA_CHINH_SACH && THANH_PHAN = "KB" && AP_DUNG = "2" && (MA_GIA_TRI = cbxLoaiKBNHD.Selected.MA_LOAI_KB Or MA_GIA_TRI = cbxMaKBNHD.Selected.MA_KENH_BAN)
                                    )
                                ) And !IsBlank(cbxLoaiKBNHD.Selected.MA_LOAI_KB),
                                Collect(
                                    tmpErrorCs,
                                    {ID: 6}
                                );
                            );
                            
                        //1.3. kiểm tra nhóm KB
                        // Nếu kênh bán áp dụng cho tất cả và có loại trừ
                        // Tìm giá trị loại trừ  cá nhân/tổ chức, nếu có dữ liệu thì false
                        If(
                                IsBlank(
                                    LookUp(
                                        dlChinhSachDTCTCCSCollect,
                                        MA_CHINH_SACH = dk.MA_CHINH_SACH && THANH_PHAN = "KB" && AP_DUNG = "1" && MA_TIEU_CHI = "MA_KB_NHOM"
                                    )
                                ) And !IsBlank(
                                    LookUp(
                                        dlChinhSachDTCTCCSCollect,
                                        MA_CHINH_SACH = dk.MA_CHINH_SACH && THANH_PHAN = "KB" && AP_DUNG = "2" && MA_TIEU_CHI = "MA_KB_NHOM" && MA_GIA_TRI = nhomKB
                                    )
                                ) And !IsBlank(cbxMaKBNHD.Selected.MA_KENH_BAN),
                                Collect(
                                    tmpErrorCs,
                                    {ID: 7}
                                );
                            );
                            
                        // Nếu kênh bán áp dụng 1 phần
                        // Tìm trong danh sách áp dụng theo mã kênh bán, loại kênh bán, cá nhân/tổ chức, nếu không có thì false
                        If(
                                !IsBlank(
                                    LookUp(
                                        dlChinhSachDTCTCCSCollect,
                                        MA_CHINH_SACH = dk.MA_CHINH_SACH && THANH_PHAN = "KB" && AP_DUNG = "1" && KIEU = "2" && MA_TIEU_CHI = "MA_KB_NHOM"
                                    )
                                ) And IsBlank(
                                    LookUp(
                                        dlChinhSachDTCTCCSCollect,
                                        MA_CHINH_SACH = dk.MA_CHINH_SACH && THANH_PHAN = "KB" && AP_DUNG = "1" && KIEU = "2" && MA_TIEU_CHI = "MA_KB_NHOM" && MA_GIA_TRI = nhomKB
                                    )
                                ) And !IsBlank(cbxMaKBNHD.Selected.MA_KENH_BAN),
                                Collect(
                                    tmpErrorCs,
                                    {ID: 8}
                                );
                            );
                            
                        // Nếu kênh bán áp dụng 1 phần
                        // Tìm trong danh sách áp dụng theo mã kênh bán nếu có dữ liệu
                        // Tìm trong danh sách loại trừ theo mã kênh bán nếu có dữ liệu thì -> false, nếu không có thì  -> pass
                        If(
                                !IsBlank(
                                    LookUp(
                                        dlChinhSachDTCTCCSCollect,
                                        MA_CHINH_SACH = dk.MA_CHINH_SACH && THANH_PHAN = "KB" && AP_DUNG = "1" && KIEU = "2" && MA_TIEU_CHI = "MA_KB_NHOM" && MA_GIA_TRI = nhomKB
                                    )
                                ) And !IsBlank(
                                    LookUp(
                                        dlChinhSachDTCTCCSCollect,
                                        MA_CHINH_SACH = dk.MA_CHINH_SACH && THANH_PHAN = "KB" && AP_DUNG = "2" && MA_TIEU_CHI = "MA_KB_NHOM" && MA_GIA_TRI = nhomKB
                                    )
                                ) And !IsBlank(cbxMaKBNHD.Selected.MA_KENH_BAN),
                                Collect(
                                    tmpErrorCs,
                                    {ID: 9}
                                );
                            );
                            
                        //2. Kiểm tra khách hàng     
                        //2.1. kiểm tra nhóm Kh
                        // Nếu kênh bán áp dụng cho tất cả và có loại trừ
                        // Tìm giá trị loại trừ  cá nhân/tổ chức, nếu có dữ liệu thì false
                        If(
                                IsBlank(
                                    LookUp(
                                        dlChinhSachDTCTCCSCollect,
                                        MA_CHINH_SACH = dk.MA_CHINH_SACH && THANH_PHAN = "KH" && AP_DUNG = "1" && MA_TIEU_CHI = "MA_KH_LOAI"
                                    )
                                ) And !IsBlank(
                                    LookUp(
                                        dlChinhSachDTCTCCSCollect,
                                        MA_CHINH_SACH = dk.MA_CHINH_SACH && THANH_PHAN = "KH" && AP_DUNG = "2" && MA_TIEU_CHI = "MA_KH_LOAI" && MA_GIA_TRI = cbxLoaiKHNHD.Selected.value
                                    )
                                ) And !IsBlank(cbxLoaiKHNHD.Selected.value),
                                Collect(
                                    tmpErrorCs,
                                    {ID: 10}
                                );
                            );
                            
                        // Nếu kênh bán áp dụng 1 phần
                        // Tìm trong danh sách áp dụng theo mã kênh bán, loại kênh bán, cá nhân/tổ chức, nếu không có thì false
                        If(
                                !IsBlank(
                                    LookUp(
                                        dlChinhSachDTCTCCSCollect,
                                        MA_CHINH_SACH = dk.MA_CHINH_SACH && THANH_PHAN = "KH" && AP_DUNG = "1" && KIEU = "2" && MA_TIEU_CHI = "MA_KH_LOAI"
                                    )
                                ) And IsBlank(
                                    LookUp(
                                        dlChinhSachDTCTCCSCollect,
                                        MA_CHINH_SACH = dk.MA_CHINH_SACH && THANH_PHAN = "KH" && AP_DUNG = "1" && KIEU = "2" && MA_TIEU_CHI = "MA_KH_LOAI" && MA_GIA_TRI = cbxLoaiKHNHD.Selected.value
                                    )
                                ) And !IsBlank(cbxLoaiKHNHD.Selected.value),
                                Collect(
                                    tmpErrorCs,
                                    {ID: 11}
                                );
                            );
                            
                        // Nếu kênh bán áp dụng 1 phần
                        // Tìm trong danh sách áp dụng theo mã kênh bán nếu có dữ liệu
                        // Tìm trong danh sách loại trừ theo mã kênh bán nếu có dữ liệu thì -> false, nếu không có thì  -> pass
                        If(
                                !IsBlank(
                                    LookUp(
                                        dlChinhSachDTCTCCSCollect,
                                        MA_CHINH_SACH = dk.MA_CHINH_SACH && THANH_PHAN = "KH" && AP_DUNG = "1" && KIEU = "2" && MA_TIEU_CHI = "MA_KH_LOAI" && MA_GIA_TRI = cbxLoaiKHNHD.Selected.value
                                    )
                                ) And !IsBlank(
                                    LookUp(
                                        dlChinhSachDTCTCCSCollect,
                                        MA_CHINH_SACH = dk.MA_CHINH_SACH && THANH_PHAN = "KH" && AP_DUNG = "2" && MA_TIEU_CHI = "MA_KH_LOAI" && MA_GIA_TRI = cbxLoaiKHNHD.Selected.value
                                    )
                                ) And !IsBlank(cbxLoaiKHNHD.Selected.value),
                                Collect(
                                    tmpErrorCs,
                                    {ID: 12}
                                );
                            );
                            
                        //3. Kiểm tra phạm vi
                        //3.1 Kiểm tra tỉnh/thành phố
                        // Nếu áp dụng cho tất cả và có loại trừ
                        // Tìm giá trị loại trừ tỉnh hoặc mã cấp cha của tỉnh nếu có dữ liệu thì false
                        If(
                                IsBlank(
                                    LookUp(
                                        dlChinhSachDTCTCCSCollect,
                                        MA_CHINH_SACH = dk.MA_CHINH_SACH && THANH_PHAN = "PV" && AP_DUNG = "1" && (MA_TIEU_CHI = "MA_TINH_TP" Or MA_TIEU_CHI = "MA_VUNG_MIEN")
                                    )
                                ) And !IsBlank(
                                    LookUp(
                                        dlChinhSachDTCTCCSCollect,
                                        MA_CHINH_SACH = dk.MA_CHINH_SACH && THANH_PHAN = "PV" && AP_DUNG = "2" && (MA_TIEU_CHI = "MA_TINH_TP" Or MA_TIEU_CHI = "MA_VUNG_MIEN")
                                    )
                                ) And !IsBlank(
                                    LookUp(
                                        dlChinhSachDTCTCCSCollect,
                                        MA_CHINH_SACH = dk.MA_CHINH_SACH && THANH_PHAN = "PV" && AP_DUNG = "2" && (MA_GIA_TRI = cbxTinhNHD.Selected.MA_PHAMVI Or MA_GIA_TRI = cbxTinhNHD.Selected.MA_CHA)
                                    )
                                ) And !IsBlank(cbxTinhNHD.Selected.MA_PHAMVI),
                                Collect(
                                    tmpErrorCs,
                                    {ID: 13}
                                );
                            );
                            
                        // Nếu phạm vi áp dụng 1 phần
                        // Tìm trong danh sách áp dụng theo tỉnh/thành phố hoặc là mã cha của tỉnh/thành phố nếu không có thì false
                        If(
                                !IsBlank(
                                    LookUp(
                                        dlChinhSachDTCTCCSCollect,
                                        MA_CHINH_SACH = dk.MA_CHINH_SACH && THANH_PHAN = "PV" && AP_DUNG = "1" && KIEU = "2" && (MA_TIEU_CHI = "MA_TINH_TP" Or MA_TIEU_CHI = "MA_VUNG_MIEN")
                                    )
                                ) And IsBlank(
                                    LookUp(
                                        dlChinhSachDTCTCCSCollect,
                                        MA_CHINH_SACH = dk.MA_CHINH_SACH && THANH_PHAN = "PV" && AP_DUNG = "1" && KIEU = "2" && (MA_GIA_TRI = cbxTinhNHD.Selected.MA_PHAMVI Or MA_GIA_TRI = cbxTinhNHD.Selected.MA_CHA)
                                    )
                                ) And !IsBlank(cbxTinhNHD.Selected.MA_PHAMVI),
                                Collect(
                                    tmpErrorCs,
                                    {ID: 14}
                                );
                            );
                            
                        // Nếu phạm vi áp dụng 1 phần
                        // Tìm trong danh sách áp dụng theo tỉnh/thành phố hoặc mã cha của tỉnh/thành phố nếu có dữ liệu
                        // Tìm trong danh sách loại trừ theo tỉnh/thành phố và mã cha của tỉnh/thành phố nếu có dữ liệu thì -> false, nếu không có thì  -> pass
                        If(
                                !IsBlank(
                                    LookUp(
                                        dlChinhSachDTCTCCSCollect,
                                        MA_CHINH_SACH = dk.MA_CHINH_SACH && THANH_PHAN = "PV" && AP_DUNG = "1" && KIEU = "2" && (MA_TIEU_CHI = "MA_TINH_TP" Or MA_TIEU_CHI = "MA_VUNG_MIEN")
                                    )
                                ) And !IsBlank(
                                    LookUp(
                                        dlChinhSachDTCTCCSCollect,
                                        MA_CHINH_SACH = dk.MA_CHINH_SACH && THANH_PHAN = "PV" && AP_DUNG = "1" && KIEU = "2" && (MA_GIA_TRI = cbxTinhNHD.Selected.MA_PHAMVI Or MA_GIA_TRI = cbxTinhNHD.Selected.MA_CHA)
                                    )
                                ) And !IsBlank(
                                    LookUp(
                                        dlChinhSachDTCTCCSCollect,
                                        MA_CHINH_SACH = dk.MA_CHINH_SACH && THANH_PHAN = "PV" && AP_DUNG = "2" && (MA_GIA_TRI = cbxTinhNHD.Selected.MA_PHAMVI Or MA_GIA_TRI = cbxTinhNHD.Selected.MA_CHA)
                                    )
                                ) And !IsBlank(cbxTinhNHD.Selected.MA_PHAMVI),
                                Collect(
                                    tmpErrorCs,
                                    {ID: 15}
                                );
                            );
                            
                        //3.2 Kiểm tra đơn vị quản lý hợp đồng
                        // Nếu áp dụng cho tất cả và có loại trừ
                        // Tìm giá trị loại trừ đơn vị quản lý hợp đồng nếu có dữ liệu thì false
                        If(
                                IsBlank(
                                    LookUp(
                                        dlChinhSachDTCTCCSCollect,
                                        MA_CHINH_SACH = dk.MA_CHINH_SACH && THANH_PHAN = "PV" && AP_DUNG = "1" && MA_TIEU_CHI = "MA_DON_VI"
                                    )
                                ) And !IsBlank(
                                    LookUp(
                                        dlChinhSachDTCTCCSCollect,
                                        MA_CHINH_SACH = dk.MA_CHINH_SACH && THANH_PHAN = "PV" && AP_DUNG = "2" && MA_TIEU_CHI = "MA_DON_VI" && MA_GIA_TRI = cbxDVQLNHD.Selected.MA_PHAMVI
                                    )
                                ) And !IsBlank(cbxDVQLNHD.Selected.MA_PHAMVI),
                                Collect(
                                    tmpErrorCs,
                                    {ID: 16}
                                );
                            );
                            
                        // Nếu phạm vi áp dụng 1 phần
                        // Tìm trong danh sách áp dụng đơn vị quản lý hợp đồng không có thì false
                        If(
                                !IsBlank(
                                    LookUp(
                                        dlChinhSachDTCTCCSCollect,
                                        MA_CHINH_SACH = dk.MA_CHINH_SACH && THANH_PHAN = "PV" && AP_DUNG = "1" && KIEU = "2" && MA_TIEU_CHI = "MA_DON_VI"
                                    )
                                ) And IsBlank(
                                    LookUp(
                                        dlChinhSachDTCTCCSCollect,
                                        MA_CHINH_SACH = dk.MA_CHINH_SACH && THANH_PHAN = "PV" && AP_DUNG = "1" && KIEU = "2" && MA_GIA_TRI = cbxDVQLNHD.Selected.MA_PHAMVI
                                    )
                                ) And !IsBlank(cbxDVQLNHD.Selected.MA_PHAMVI),
                                Collect(
                                    tmpErrorCs,
                                    {ID: 17}
                                );
                            );
                            
                        // Nếu phạm vi áp dụng 1 phần
                        // Tìm trong danh sách áp dụng theo đơn vị quản lý hợp đồng nếu có dữ liệu
                        // Tìm trong danh sách loại trừ theo đơn vị quản lý hợp đồng nếu có dữ liệu thì -> false, nếu không có thì  -> pass
                        If(
                                !IsBlank(
                                    LookUp(
                                        dlChinhSachDTCTCCSCollect,
                                        MA_CHINH_SACH = dk.MA_CHINH_SACH && THANH_PHAN = "PV" && AP_DUNG = "1" && KIEU = "2" && MA_TIEU_CHI = "MA_DON_VI" && MA_GIA_TRI = cbxDVQLNHD.Selected.MA_PHAMVI
                                    )
                                ) And !IsBlank(
                                    LookUp(
                                        dlChinhSachDTCTCCSCollect,
                                        MA_CHINH_SACH = dk.MA_CHINH_SACH && THANH_PHAN = "PV" && AP_DUNG = "2" && MA_TIEU_CHI = "MA_DON_VI" && MA_GIA_TRI = cbxDVQLNHD.Selected.MA_PHAMVI
                                    )
                                ) And !IsBlank(cbxDVQLNHD.Selected.MA_PHAMVI),
                                Collect(
                                    tmpErrorCs,
                                    {ID: 18}
                                );
                            );
                            
                        //4. Kiểm tra sản phẩm
                        ForAll(
                                Gallery3_2.AllItems As sp,
                                    // 4.1.1 Kiểm tra thông tin sản phẩm
                        // Nếu sản phẩm áp dụng cho tất cả và có loại trừ
                        // Tìm giá trị loại trừ mã sản phẩm nếu có dữ liệu thì false
                                If(
                                    IsBlank(
                                        LookUp(
                                            dlChinhSachDTCTCCSCollect,
                                            MA_CHINH_SACH = dk.MA_CHINH_SACH && THANH_PHAN = "SP" && AP_DUNG = "1" && MA_TIEU_CHI = "MA_SP"
                                        )
                                    ) And !IsBlank(
                                        LookUp(
                                            dlChinhSachDTCTCCSCollect,
                                            MA_CHINH_SACH = dk.MA_CHINH_SACH && THANH_PHAN = "SP" && AP_DUNG = "2" && MA_TIEU_CHI = "MA_SP" && MA_GIA_TRI = sp.cbxMaSPNHD.Selected.MA_SAN_PHAM
                                        )
                                    ) And !IsBlank(sp.cbxMaSPNHD.Selected.MA_SAN_PHAM),
                                    Collect(
                                        tmpErrorCs,
                                        {ID: 19}
                                    );
                                );
                                    // Nếu sản phẩm áp dụng 1 phần
                        // Tìm trong danh sách áp dụng theo mã sản phẩm nếu không có thì false
                        If(
                                    !IsBlank(
                                        LookUp(
                                            dlChinhSachDTCTCCSCollect,
                                            MA_CHINH_SACH = dk.MA_CHINH_SACH && THANH_PHAN = "SP" && AP_DUNG = "1" && MA_TIEU_CHI = "MA_SP"
                                        )
                                    ) And IsBlank(
                                        LookUp(
                                            dlChinhSachDTCTCCSCollect,
                                            MA_CHINH_SACH = dk.MA_CHINH_SACH && THANH_PHAN = "SP" && AP_DUNG = "1" && MA_TIEU_CHI = "MA_SP" && KIEU = "2" && MA_GIA_TRI = sp.cbxMaSPNHD.Selected.MA_SAN_PHAM
                                        )
                                    ) And !IsBlank(sp.cbxMaSPNHD.Selected.MA_SAN_PHAM),
                                    Collect(
                                        tmpErrorCs,
                                        {ID: 20}
                                    );
                                );
                                
                        // Nếu sản phẩm áp dụng 1 phần
                        // Tìm trong danh sách áp dụng theo mã sản phẩm nếu có dữ liệu
                        // Tìm trong danh sách loại trừ theo mã sản phẩm nếu có dữ liệu thì -> false, nếu không có thì  -> pass
                        If(
                                    !IsBlank(
                                        LookUp(
                                            dlChinhSachDTCTCCSCollect,
                                            MA_CHINH_SACH = dk.MA_CHINH_SACH && THANH_PHAN = "SP" && AP_DUNG = "1" && MA_TIEU_CHI = "MA_SP" && MA_GIA_TRI = sp.cbxMaSPNHD.Selected.MA_SAN_PHAM
                                        )
                                    ) And !IsBlank(
                                        LookUp(
                                            dlChinhSachDTCTCCSCollect,
                                            MA_CHINH_SACH = dk.MA_CHINH_SACH && THANH_PHAN = "SP" && AP_DUNG = "2" && MA_TIEU_CHI = "MA_SP" && MA_GIA_TRI = sp.cbxMaSPNHD.Selected.MA_SAN_PHAM
                                        )
                                    ) And !IsBlank(sp.cbxMaSPNHD.Selected.MA_SAN_PHAM),
                                    Collect(
                                        tmpErrorCs,
                                        {ID: 21}
                                    );
                                );
                                // 4.1.2 Kiểm tra thông tin chương trình
                        // Nếu chương trình áp dụng cho tất cả và có loại trừ
                        // Tìm giá trị loại trừ chương trình nếu có dữ liệu thì false
                        If(
                                    IsBlank(
                                        LookUp(
                                            dlChinhSachDTCTCCSCollect,
                                            MA_CHINH_SACH = dk.MA_CHINH_SACH && THANH_PHAN = "SP" && AP_DUNG = "1" && MA_TIEU_CHI = "MA_CT"
                                        )
                                    ) And !IsBlank(
                                        LookUp(
                                            dlChinhSachDTCTCCSCollect,
                                            MA_CHINH_SACH = dk.MA_CHINH_SACH && THANH_PHAN = "SP" && AP_DUNG = "2" && MA_TIEU_CHI = "MA_CT" && MA_GIA_TRI = sp.cbxMaCTNHDHide.Selected.MA_CHUONG_TRINH
                                        )
                                    ) And !IsBlank(sp.cbxMaCTNHDHide.Selected.MA_CHUONG_TRINH),
                                    Collect(
                                        tmpErrorCs,
                                        {ID: 22}
                                    );
                                );
                                    // Nếu sản phẩm áp dụng 1 phần
                        // Tìm trong danh sách áp dụng theo mã sản phẩm nếu không có thì false
                        If(
                                    !IsBlank(
                                        LookUp(
                                            dlChinhSachDTCTCCSCollect,
                                            MA_CHINH_SACH = dk.MA_CHINH_SACH && THANH_PHAN = "SP" && AP_DUNG = "1" && MA_TIEU_CHI = "MA_CT"
                                        )
                                    ) And IsBlank(
                                        LookUp(
                                            dlChinhSachDTCTCCSCollect,
                                            MA_CHINH_SACH = dk.MA_CHINH_SACH && THANH_PHAN = "SP" && AP_DUNG = "1" && MA_TIEU_CHI = "MA_CT" && KIEU = "2" && MA_GIA_TRI = sp.cbxMaCTNHDHide.Selected.MA_CHUONG_TRINH
                                        )
                                    ) And !IsBlank(sp.cbxMaCTNHDHide.Selected.MA_CHUONG_TRINH),
                                    Collect(
                                        tmpErrorCs,
                                        {ID: 23}
                                    );
                                );
                                    // Nếu chương trình áp dụng 1 phần
                        // Tìm trong danh sách áp dụng theo mã chương trình nếu có dữ liệu
                        // Tìm trong danh sách loại trừ theo mã chương trình nếu có dữ liệu thì -> false, nếu không có thì  -> pass
                        If(
                                    !IsBlank(
                                        LookUp(
                                            dlChinhSachDTCTCCSCollect,
                                            MA_CHINH_SACH = dk.MA_CHINH_SACH && THANH_PHAN = "SP" && AP_DUNG = "1" && MA_TIEU_CHI = "MA_CT" && MA_GIA_TRI = sp.cbxMaCTNHDHide.Selected.MA_CHUONG_TRINH
                                        )
                                    ) And !IsBlank(
                                        LookUp(
                                            dlChinhSachDTCTCCSCollect,
                                            MA_CHINH_SACH = dk.MA_CHINH_SACH && THANH_PHAN = "SP" && AP_DUNG = "2" && MA_TIEU_CHI = "MA_CT" && MA_GIA_TRI = sp.cbxMaCTNHDHide.Selected.MA_CHUONG_TRINH
                                        )
                                    ) And !IsBlank(sp.cbxMaCTNHDHide.Selected.MA_CHUONG_TRINH),
                                    Collect(
                                        tmpErrorCs,
                                        {ID: 24}
                                    );
                                );
                         // 4.1.3 Kiểm tra thông tin LHNV
                        // Nếu LHNV áp dụng cho tất cả và có loại trừ
                        // Tìm giá trị loại trừ LHNV nếu có dữ liệu thì false
                        If(
                                    IsBlank(
                                        LookUp(
                                            dlChinhSachDTCTCCSCollect,
                                            MA_CHINH_SACH = dk.MA_CHINH_SACH && THANH_PHAN = "SP" && AP_DUNG = "1" && MA_TIEU_CHI = "LHNV"
                                        )
                                    ) And !IsBlank(
                                        LookUp(
                                            dlChinhSachDTCTCCSCollect,
                                            MA_CHINH_SACH = dk.MA_CHINH_SACH && THANH_PHAN = "SP" && AP_DUNG = "2" && MA_TIEU_CHI = "LHNV" && 
                                            TEN_GIA_TRI = LookUp(DL_SAN_PHAM,MA_SAN_PHAM=cbxMaSPNHD.Selected.MA_SAN_PHAM,LHNV)
                                        )
                                    ) And !IsBlank(LookUp(DL_SAN_PHAM,MA_SAN_PHAM=cbxMaSPNHD.Selected.MA_SAN_PHAM,LHNV)),
                                    Collect(
                                        tmpErrorCs,
                                        {ID: 25}
                                    );
                                );
                                    // Nếu sản phẩm áp dụng 1 phần
                        // Tìm trong danh sách áp dụng theo mã sản phẩm nếu không có thì false
                        If(
                                    !IsBlank(
                                        LookUp(
                                            dlChinhSachDTCTCCSCollect,
                                            MA_CHINH_SACH = dk.MA_CHINH_SACH && THANH_PHAN = "SP" && AP_DUNG = "1" && MA_TIEU_CHI = "LHNV"
                                        )
                                    ) And IsBlank(
                                        LookUp(
                                            dlChinhSachDTCTCCSCollect,
                                            MA_CHINH_SACH = dk.MA_CHINH_SACH && THANH_PHAN = "SP" && AP_DUNG = "1" && MA_TIEU_CHI = "LHNV" && KIEU = "2" && 
                                            TEN_GIA_TRI = LookUp(DL_SAN_PHAM,MA_SAN_PHAM=cbxMaSPNHD.Selected.MA_SAN_PHAM,LHNV)
                                        )
                                    ) And !IsBlank(LookUp(DL_SAN_PHAM,MA_SAN_PHAM=cbxMaSPNHD.Selected.MA_SAN_PHAM,LHNV)),
                                    Collect(
                                        tmpErrorCs,
                                        {ID: 26}
                                    );
                                );
                                
                        // Nếu chương trình áp dụng 1 phần
                        // Tìm trong danh sách áp dụng theo mã chương trình nếu có dữ liệu
                        // Tìm trong danh sách loại trừ theo mã chương trình nếu có dữ liệu thì -> false, nếu không có thì  -> pass
                        If(
                                    !IsBlank(
                                        LookUp(
                                            dlChinhSachDTCTCCSCollect,
                                            MA_CHINH_SACH = dk.MA_CHINH_SACH && THANH_PHAN = "SP" && AP_DUNG = "1" && MA_TIEU_CHI = "LHNV" && 
                                            TEN_GIA_TRI = LookUp(DL_SAN_PHAM,MA_SAN_PHAM=cbxMaSPNHD.Selected.MA_SAN_PHAM,LHNV)
                                        )
                                    ) And !IsBlank(
                                        LookUp(
                                            dlChinhSachDTCTCCSCollect,
                                            MA_CHINH_SACH = dk.MA_CHINH_SACH && THANH_PHAN = "SP" && AP_DUNG = "2" && MA_TIEU_CHI = "LHNV" && 
                                            TEN_GIA_TRI = LookUp(DL_SAN_PHAM,MA_SAN_PHAM=cbxMaSPNHD.Selected.MA_SAN_PHAM,LHNV)
                                        )
                                    ) And !IsBlank(LookUp(DL_SAN_PHAM,MA_SAN_PHAM=cbxMaSPNHD.Selected.MA_SAN_PHAM,LHNV)),
                                    Collect(
                                        tmpErrorCs,
                                        {ID: 27}
                                    );
                                );
                            );
                            
                        //4.1.4 Kiểm tra combo sản phẩm
                        // lấy danh sách sản phẩm trên hợp đồng
                        ForAll(
                                Gallery3_2.AllItems As sp,
                                Collect(
                                    dsSpKetHop,
                                    {MA_SAN_PHAM: sp.cbxMaSPNHD.Selected.MA_SAN_PHAM}
                                )
                            );
                            ForAll(
                                Gallery3_1.AllItems As sp,
                                Collect(
                                    dsSpKetHop,
                                    {MA_SAN_PHAM: sp.tiMaSPLKNHD_1.Text}
                                )
                            );
                            Collect(
                                GroupedSp,
                                GroupBy(
                                    dsSpKetHop,
                                    "MA_SAN_PHAM",
                                    "Grouped"
                                )
                            );
                            If(
                                CountRows(GroupedSp) > 1,
                                Collect(
                                    dsCombosp,
                                    Filter(
                                        dlChinhSachDTCTCCSCollect,
                                        MA_GIA_TRI,
                                        MA_CHINH_SACH = dk.MA_CHINH_SACH && THANH_PHAN = "SP" && MA_TIEU_CHI = "MA_COMBO_SP" && AP_DUNG = "1"
                                    )
                                );
                                Collect(
                                    dsCombospLt,
                                    Filter(
                                        dlChinhSachDTCTCCSCollect,
                                        MA_GIA_TRI,
                                        MA_CHINH_SACH = dk.MA_CHINH_SACH && THANH_PHAN = "SP" && MA_TIEU_CHI = "MA_COMBO_SP" && AP_DUNG = "2"
                                    )
                                );
                                ForAll(
                                    GroupedSp As sp,
                                    RemoveIf(
                                        dsCombosp,
                                        cr282_ma_gia_tri = sp.MA_SAN_PHAM
                                    );
                                );
                                ForAll(
                                    GroupedSp As sp,
                                    RemoveIf(
                                        dsCombospLt,
                                        cr282_ma_gia_tri = sp.MA_SAN_PHAM
                                    );
                                );
                                
                        // Nếu COMBO áp dụng cho tất cả và có loại trừ
                        // Tìm giá trị loại trừ theo combo sản phẩm nếu có dữ liệu thì false
                        If(
                                    IsBlank(
                                        LookUp(
                                            dlChinhSachDTCTCCSCollect,
                                            MA_CHINH_SACH = dk.MA_CHINH_SACH && THANH_PHAN = "SP" && AP_DUNG = "1" && MA_TIEU_CHI = "MA_COMBO_SP"
                                        )
                                    ) And !IsBlank(
                                        LookUp(
                                            dlChinhSachDTCTCCSCollect,
                                            MA_CHINH_SACH = dk.MA_CHINH_SACH && THANH_PHAN = "SP" && AP_DUNG = "2" && MA_TIEU_CHI = "MA_COMBO_SP"
                                        )
                                    ) And CountRows(dsCombospLt) = 0 And CountRows(GroupedSp) = CountRows(
                                        Filter(
                                            dlChinhSachDTCTCCSCollect,
                                            MA_CHINH_SACH = dk.MA_CHINH_SACH && THANH_PHAN = "SP" && AP_DUNG = "2" && MA_TIEU_CHI = "MA_COMBO_SP"
                                        )
                                    ),
                                    Collect(
                                        tmpErrorCs,
                                        {ID: 28}
                                    );
                                );
                                
                        // Nếu combo sản phẩm áp dụng 1 phần
                        // Tìm trong danh sách áp dụng theo COMBO SẢN PHẨM nếu không khớp có thì false
                        If(
                                    !IsBlank(
                                        LookUp(
                                            dlChinhSachDTCTCCSCollect,
                                            MA_CHINH_SACH = dk.MA_CHINH_SACH && THANH_PHAN = "SP" && AP_DUNG = "1" && MA_TIEU_CHI = "MA_COMBO_SP"
                                        )
                                    ) And (CountRows(dsCombosp) <> 0),
                                    Collect(
                                        tmpErrorCs,
                                        {ID: 29}
                                    );
                                );
                                If(
                                    !IsBlank(
                                        LookUp(
                                            dlChinhSachDTCTCCSCollect,
                                            MA_CHINH_SACH = dk.MA_CHINH_SACH && THANH_PHAN = "SP" && AP_DUNG = "1" && MA_TIEU_CHI = "MA_COMBO_SP"
                                        )
                                    ) And CountRows(GroupedSp) <> CountRows(
                                        Filter(
                                            dlChinhSachDTCTCCSCollect,
                                            MA_CHINH_SACH = dk.MA_CHINH_SACH && THANH_PHAN = "SP" && AP_DUNG = "1" && MA_TIEU_CHI = "MA_COMBO_SP"
                                        )
                                    ),
                                    Collect(
                                        tmpErrorCs,
                                        {ID: 30}
                                    );
                                );
                            );
                            
                        // lấy số sản phẩm trong hợp đồng
                        If(
                                CountRows(tmpErrorCs) <= 0,
                                Collect(
                                    tmpPassCs,
                                    {ma_chinh_sach: dk.MA_CHINH_SACH}
                                );
                            )
                        );
                        If(
                            CountRows(tmpPass) <= 0,
                            UpdateContext({errorMsg: "Các thông tin không đủ điều kiện để cấp hợp đồng"})
                        );
                        If(
                            CountRows(tmpPassCs) <= 0,
                            UpdateContext({errorMsg: "Không có chính sách thỏa mãn điều kiện"})
                        );
                        // end chính sách áp dụng
                        If(
                            !IsBlank(errorMsg),
                            Notify(
                                errorMsg,
                                NotificationType.Error,
                                5000
                            ),
                            //xu ly chon cs
                            Set(
                                varMaHD_CS,
                                If(
                                    IsBlank(tiMaHDNHD.Text),
                                    maHopDongFwd,
                                    tiMaHDNHD.Text
                                )
                            );
                            Set(varNgayHD, dpNgayHDNHD.SelectedDate);
                            ClearCollect(// lay gia tri cs chung
                                tmpChonTCCSDT,
                                ShowColumns(
                                    AddColumns(
                                        SortByColumns(
                                            DL_CHINHSACH_CHUNG,
                                            "cr282_ma_chinh_sach",
                                            SortOrder.Ascending
                                        ),
                                        "hinh_thuc",
                                        "",
                                        "loai_dieu_kien",
                                        "",
                                        "loai_cs",
                                        "",
                                        "so_tien",
                                        0,
                                        "ty_le",
                                        0,
                                        "so_tien_max",
                                        0,
                                        "donvi_tien",
                                        "",
                                        "pass",
                                        0,
                                        "tich_chon",
                                        false
                                    ),
                                    "cr282_id",
                                    "cr282_ma_chinh_sach",
                                    "cr282_mo_ta",
                                    "cr282_san_pham",
                                    "cr282_kenh_ban",
                                    "cr282_khach_hang",
                                    "cr282_pham_vi",
                                    "cr282_hieu_luc_tu",
                                    "cr282_hieu_luc_den",
                                    "hinh_thuc",
                                    "loai_dieu_kien",
                                    "loai_cs",
                                    "so_tien",
                                    "ty_le",
                                    "so_tien_max",
                                    "donvi_tien",
                                    "pass",
                                    "tich_chon"
                                )
                            );
                            ForAll(//Lay gia tri cs ap dung
                                DL_CHINHSACH_APDUNG As cs,
                                UpdateIf(
                                    tmpChonTCCSDT,
                                    cr282_ma_chinh_sach = cs.MA_CHINH_SACH,
                                    {
                                        hinh_thuc: cs.HINH_THUC,
                                        loai_dieu_kien: cs.LOAI_DK,
                                        loai_cs: cs.ANH_HUONG,
                                        so_tien: cs.SO_TIEN,
                                        ty_le: cs.TY_LE,
                                        so_tien_max: cs.SO_TIEN_TOI_DA,
                                        donvi_tien: cs.DONVI_TIEN_TE,
                                        tich_chon: If(
                                            !IsBlank(
                                                LookUp(
                                                    DL_HOP_DONG_CHON_CS,
                                                    MA_CHINH_SACH = cs.MA_CHINH_SACH && MA_HOP_DONG = varMaHD_CS
                                                ).MA_CHINH_SACH
                                            ),
                                            true,
                                            false
                                        )
                                    }
                                )
                            );
                            ForAll(
                                tmpPassCs As ps,
                                UpdateIf(
                                    tmpChonTCCSDT,
                                    cr282_ma_chinh_sach = ps.ma_chinh_sach,
                                    {pass: 1}
                                )
                            );
                            RemoveIf(
                                tmpChonTCCSDT,
                                pass <> 1
                            );
                            Navigate(ChonChinhSach);
                            
                        );
                    Size: =11
                    Underline: =true
                    Width: =142
                    X: =24
                    Y: =24
                    ZIndex: =2

                FormKQCS_1 As form:
                    DataSource: =DL_HOP_DONG_KETQUA_CS
                    Height: =123
                    Item: =LookUp(DL_HOP_DONG_KETQUA_CS, MA_HOP_DONG=If(!IsBlank(tiMaHDNHD.Text),tiMaHDNHD.Text,maHopDongFwd))
                    NumberOfColumns: =4
                    Visible: =If(!IsBlank(LookUp(DL_HOP_DONG_KETQUA_CS, MA_HOP_DONG=If(!IsBlank(tiMaHDNHD.Text),tiMaHDNHD.Text,maHopDongFwd)).MA_HOP_DONG), true,false)
                    Width: =1267
                    Y: =251
                    ZIndex: =3

                    LOAI_TAC_DONG_DataCard1_1 As typedDataCard.textualEditCard:
                        BorderStyle: =BorderStyle.Solid
                        DataField: ="cr282_loai_tac_dong"
                        Default: =ThisItem.LOAI_TAC_DONG
                        DisplayMode: =Parent.DisplayMode
                        DisplayName: =DataSourceInfo([@DL_HOP_DONG_KETQUA_CS],DataSourceInfo.DisplayName,"cr282_loai_tac_dong")
                        Fill: =RGBA(0, 0, 0, 0)
                        Height: =50
                        MaxLength: =DataSourceInfo([@DL_HOP_DONG_KETQUA_CS], DataSourceInfo.MaxLength, "cr282_loai_tac_dong")
                        Required: =false
                        Update: =DataCardValue21_1.Selected.MA
                        Width: =326
                        X: =0
                        Y: =0
                        ZIndex: =6

                        DataCardKey38_1 As label:
                            AutoHeight: =true
                            Color: =RGBA(0, 0, 0, 1)
                            Height: =34
                            Size: =11
                            Text: ="Loại tác động"
                            Width: =Parent.Width - 60
                            Wrap: =false
                            X: =30
                            Y: =10
                            ZIndex: =1

                        ErrorMessage35_1 As label:
                            AutoHeight: =true
                            Height: =10
                            Live: =Live.Assertive
                            PaddingBottom: =0
                            PaddingLeft: =0
                            PaddingRight: =0
                            PaddingTop: =0
                            Text: =Parent.Error
                            Visible: =Parent.DisplayMode=DisplayMode.Edit
                            Width: =Parent.Width - 60
                            X: =30
                            Y: =DataCardValue21_1.Y + DataCardValue21_1.Height
                            ZIndex: =3

                        StarVisible36_1 As label:
                            Align: =Align.Center
                            Height: =DataCardKey38_1.Height
                            Text: ="*"
                            Visible: =And(Parent.Required, Parent.DisplayMode=DisplayMode.Edit)
                            Width: =30
                            Wrap: =false
                            Y: =DataCardKey38_1.Y
                            ZIndex: =4

                        DataCardValue21_1 As dropdown:
                            ChevronDisabledBackground: =RGBA(122, 138, 143, 1)
                            Default: =If(Parent.Default="1","Tăng",If(Parent.Default="2","Giảm"))
                            DisabledBorderColor: =RGBA(180, 214, 250, 1)
                            DisabledColor: =RGBA(0, 0, 0, 1)
                            DisabledFill: =RGBA(214, 221, 224, 1)
                            DisplayMode: =DisplayMode.Disabled
                            Items: |-
                                =[{MA:"1",TEN:"Tăng"},{MA:"2",TEN:"Giảm"}]
                            Width: =266
                            X: =30
                            Y: =45
                            ZIndex: =5

                    KIEU_DU_LIEU_DataCard2_1 As typedDataCard.textualEditCard:
                        BorderStyle: =BorderStyle.Solid
                        DataField: ="cr282_kieu_du_lieu"
                        Default: =ThisItem.KIEU_DU_LIEU
                        DisplayMode: =Parent.DisplayMode
                        DisplayName: =DataSourceInfo([@DL_HOP_DONG_KETQUA_CS],DataSourceInfo.DisplayName,"cr282_kieu_du_lieu")
                        Fill: =RGBA(0, 0, 0, 0)
                        Height: =50
                        MaxLength: =DataSourceInfo([@DL_HOP_DONG_KETQUA_CS], DataSourceInfo.MaxLength, "cr282_kieu_du_lieu")
                        Required: =false
                        Update: =DataCardValue19_1.Selected.MA
                        Width: =326
                        X: =1
                        Y: =0
                        ZIndex: =6

                        DataCardKey37_1 As label:
                            AutoHeight: =true
                            Color: =RGBA(0, 0, 0, 1)
                            Height: =34
                            Size: =11
                            Text: ="Kiểu dữ liệu"
                            Width: =Parent.Width - 60
                            Wrap: =false
                            X: =30
                            Y: =10
                            ZIndex: =1

                        ErrorMessage34_1 As label:
                            AutoHeight: =true
                            Height: =10
                            Live: =Live.Assertive
                            PaddingBottom: =0
                            PaddingLeft: =0
                            PaddingRight: =0
                            PaddingTop: =0
                            Text: =Parent.Error
                            Visible: =Parent.DisplayMode=DisplayMode.Edit
                            Width: =Parent.Width - 60
                            X: =30
                            Y: =DataCardValue19_1.Y + DataCardValue19_1.Height
                            ZIndex: =3

                        StarVisible35_1 As label:
                            Align: =Align.Center
                            Height: =DataCardKey37_1.Height
                            Text: ="*"
                            Visible: =And(Parent.Required, Parent.DisplayMode=DisplayMode.Edit)
                            Width: =30
                            Wrap: =false
                            Y: =DataCardKey37_1.Y
                            ZIndex: =4

                        DataCardValue19_1 As dropdown:
                            ChevronDisabledBackground: =RGBA(122, 138, 143, 1)
                            Default: =If(Parent.Default="001","Tỷ lệ (%)",If(Parent.Default="002","Số tiền"))
                            DisabledBorderColor: =RGBA(180, 214, 250, 1)
                            DisabledColor: =RGBA(0, 0, 0, 1)
                            DisabledFill: =RGBA(214, 221, 224, 1)
                            DisplayMode: =DisplayMode.Disabled
                            Items: |-
                                =[{MA:"001",TEN:"Tỷ lệ (%)"},{MA:"002",TEN:"Số tiền"}]
                            Width: =266
                            X: =30
                            Y: =45
                            ZIndex: =5

                    GIA_TRI_DataCard1_1 As typedDataCard.numberEditCard:
                        BorderStyle: =BorderStyle.Solid
                        DataField: ="cr282_gia_tri"
                        Default: =ThisItem.GIA_TRI
                        DisplayMode: =Parent.DisplayMode
                        DisplayName: =DataSourceInfo([@DL_HOP_DONG_KETQUA_CS],DataSourceInfo.DisplayName,"cr282_gia_tri")
                        Fill: =RGBA(0, 0, 0, 0)
                        Height: =50
                        Required: =false
                        Update: =Value(DataCardValue14_1.Text)
                        Width: =326
                        X: =2
                        Y: =0
                        ZIndex: =6

                        DataCardKey35_1 As label:
                            AutoHeight: =true
                            Color: =RGBA(0, 0, 0, 1)
                            Height: =34
                            Size: =11
                            Text: ="Giá trị"
                            Width: =Parent.Width - 60
                            Wrap: =false
                            X: =30
                            Y: =10
                            ZIndex: =1

                        DataCardValue14_1 As text:
                            Align: =Align.Right
                            BorderColor: =If(IsBlank(Parent.Error), Parent.BorderColor, Color.Red)
                            Default: =Parent.Default
                            DelayOutput: =true
                            DisabledBorderColor: =RGBA(180, 214, 250, 1)
                            DisabledColor: =RGBA(0, 0, 0, 1)
                            DisabledFill: =RGBA(214, 221, 224, 1)
                            DisplayMode: =DisplayMode.Disabled
                            Format: =TextFormat.Number
                            PaddingLeft: =5
                            RadiusBottomLeft: =0
                            RadiusBottomRight: =0
                            RadiusTopLeft: =0
                            RadiusTopRight: =0
                            Size: =11
                            Tooltip: =Parent.DisplayName
                            Width: =Parent.Width - 60
                            X: =30
                            Y: =DataCardKey35_1.Y + DataCardKey35_1.Height + 5
                            ZIndex: =2

                        ErrorMessage32_1 As label:
                            AutoHeight: =true
                            Height: =10
                            Live: =Live.Assertive
                            PaddingBottom: =0
                            PaddingLeft: =0
                            PaddingRight: =0
                            PaddingTop: =0
                            Text: =Parent.Error
                            Visible: =Parent.DisplayMode=DisplayMode.Edit
                            Width: =Parent.Width - 60
                            X: =30
                            Y: =DataCardValue14_1.Y + DataCardValue14_1.Height
                            ZIndex: =3

                        StarVisible33_1 As label:
                            Align: =Align.Center
                            Height: =DataCardKey35_1.Height
                            Text: ="*"
                            Visible: =And(Parent.Required, Parent.DisplayMode=DisplayMode.Edit)
                            Width: =30
                            Wrap: =false
                            Y: =DataCardKey35_1.Y
                            ZIndex: =4

                    SO_TIEN_TOI_DA_DataCard1_1 As typedDataCard.numberEditCard:
                        BorderStyle: =BorderStyle.Solid
                        DataField: ="cr282_so_tien_toi_da"
                        Default: =ThisItem.SO_TIEN_TOI_DA
                        DisplayMode: =Parent.DisplayMode
                        DisplayName: =DataSourceInfo([@DL_HOP_DONG_KETQUA_CS],DataSourceInfo.DisplayName,"cr282_so_tien_toi_da")
                        Fill: =RGBA(0, 0, 0, 0)
                        Height: =50
                        Required: =false
                        Update: =Value(DataCardValue23_1.Text)
                        Visible: =false
                        Width: =326
                        X: =3
                        Y: =0
                        ZIndex: =6

                        DataCardKey46_1 As label:
                            AutoHeight: =true
                            Height: =34
                            Text: ="Số tiền tối đa"
                            Width: =Parent.Width - 60
                            Wrap: =false
                            X: =30
                            Y: =10
                            ZIndex: =1

                        DataCardValue23_1 As text:
                            Align: =Align.Right
                            BorderColor: =If(IsBlank(Parent.Error), Parent.BorderColor, Color.Red)
                            Default: =Parent.Default
                            DelayOutput: =true
                            DisabledBorderColor: =RGBA(180, 214, 250, 1)
                            DisabledColor: =RGBA(0, 0, 0, 1)
                            DisabledFill: =RGBA(214, 221, 224, 1)
                            DisplayMode: =DisplayMode.Disabled
                            Format: =TextFormat.Number
                            PaddingLeft: =5
                            RadiusBottomLeft: =0
                            RadiusBottomRight: =0
                            RadiusTopLeft: =0
                            RadiusTopRight: =0
                            Size: =11
                            Tooltip: =Parent.DisplayName
                            Width: =Parent.Width - 60
                            X: =30
                            Y: =DataCardKey46_1.Y + DataCardKey46_1.Height + 5
                            ZIndex: =2

                        ErrorMessage36_1 As label:
                            AutoHeight: =true
                            Height: =10
                            Live: =Live.Assertive
                            PaddingBottom: =0
                            PaddingLeft: =0
                            PaddingRight: =0
                            PaddingTop: =0
                            Text: =Parent.Error
                            Visible: =Parent.DisplayMode=DisplayMode.Edit
                            Width: =Parent.Width - 60
                            X: =30
                            Y: =DataCardValue23_1.Y + DataCardValue23_1.Height
                            ZIndex: =3

                        StarVisible43_1 As label:
                            Align: =Align.Center
                            Height: =DataCardKey46_1.Height
                            Text: ="*"
                            Visible: =And(Parent.Required, Parent.DisplayMode=DisplayMode.Edit)
                            Width: =30
                            Wrap: =false
                            Y: =DataCardKey46_1.Y
                            ZIndex: =4

                Container6_2 As groupContainer.manualLayoutContainer:
                    DropShadow: =DropShadow.None
                    Height: =186
                    Width: =1267
                    Y: =65
                    ZIndex: =4

                    BadgeCanvas1_60 As Badge:
                        BasePaletteColor: =
                        Content: =""
                        DisplayMode: =DisplayMode.Edit
                        FontColor: =
                        Height: =40
                        Width: =1267
                        X: =0
                        Y: =0
                        ZIndex: =2

                    TextCanvas2_250 As Text:
                        Align: ='TextCanvas.Align'.Center
                        DisplayMode: =DisplayMode.Edit
                        FontColor: =
                        Height: =40
                        Size: =10
                        Text: ="Mã"
                        Weight: ='TextCanvas.Weight'.Bold
                        Width: =27
                        X: =49
                        Y: =0
                        ZIndex: =3

                    TextCanvas2_264 As Text:
                        Align: ='TextCanvas.Align'.Center
                        DisplayMode: =DisplayMode.Edit
                        FontColor: =
                        Height: =40
                        Size: =10
                        Text: ="Mô tả"
                        Weight: ='TextCanvas.Weight'.Bold
                        Width: =55
                        X: =406
                        Y: =0
                        ZIndex: =5

                    TextCanvas2_267 As Text:
                        Align: ='TextCanvas.Align'.Center
                        DisplayMode: =DisplayMode.Edit
                        FontColor: =
                        Height: =40
                        Size: =10
                        Text: ="Thao tác"
                        Weight: ='TextCanvas.Weight'.Bold
                        Width: =55
                        X: =1177
                        Y: =0
                        ZIndex: =8

                    "GalleryCSDaChon As gallery.'BrowseLayout_Vertical_TwoTextOneImageVariant_ver5.0'":
                        BorderColor: =RGBA(255, 255, 255, 1)
                        DelayItemLoading: =true
                        Height: =146
                        Items: =tmpCsDaChon
                        Layout: =Layout.Vertical
                        LoadingSpinner: =LoadingSpinner.Data
                        TemplatePadding: =0
                        TemplateSize: =104
                        Width: =1265
                        X: =2
                        Y: =40
                        ZIndex: =10

                        TextMaCS_1 As text:
                            BorderColor: =RGBA(245, 245, 245, 1)
                            Color: =RGBA(50, 49, 48, 1)
                            Default: =ThisItem.MA_CHINH_SACH
                            DisabledBorderColor: =RGBA(180, 214, 250, 1)
                            DisabledColor: =RGBA(0, 0, 0, 1)
                            DisabledFill: =RGBA(255, 255, 255, 1)
                            DisplayMode: =DisplayMode.Disabled
                            Height: =102
                            HoverBorderColor: =RGBA(16, 110, 190, 1)
                            HoverColor: =RGBA(50, 49, 48, 1)
                            HoverFill: =RGBA(255, 255, 255, 1)
                            OnSelect: =Select(Parent)
                            PressedBorderColor: =RGBA(0, 120, 212, 1)
                            PressedColor: =RGBA(50, 49, 48, 1)
                            PressedFill: =RGBA(255, 255, 255, 1)
                            RadiusBottomLeft: =0
                            RadiusBottomRight: =0
                            RadiusTopLeft: =0
                            RadiusTopRight: =0
                            Size: =11
                            Width: =103
                            X: =7
                            Y: =2
                            ZIndex: =1

                        HtmlMoTa_1 As htmlViewer:
                            BorderColor: =RGBA(180, 214, 250, 1)
                            BorderStyle: =BorderStyle.Solid
                            BorderThickness: =2
                            DisabledBorderColor: =RGBA(180, 214, 250, 1)
                            DisabledFill: =RGBA(255, 255, 255, 1)
                            Fill: =RGBA(255, 255, 255, 1)
                            Height: =102
                            HtmlText: =ThisItem.MO_TA
                            OnSelect: =Select(Parent)
                            Visible: |
                                =true
                            Width: =1026
                            X: =110
                            Y: =2
                            ZIndex: =5

                        Button2_7 As button:
                            Height: =32
                            OnSelect: =RemoveIf(tmpCsDaChon,ID=ThisItem.ID);
                            Size: =11
                            Text: ="Xóa"
                            Width: =80
                            X: =1165
                            Y: =37
                            ZIndex: =6

            Container3_9 As groupContainer.manualLayoutContainer:
                Height: =218
                Width: =1267
                X: =16
                Y: =1367
                ZIndex: =9

                Label3_63 As label:
                    FontWeight: =FontWeight.Bold
                    Height: =20
                    Size: =11
                    Text: ="7. Thanh toán"
                    Width: =254
                    Y: =4
                    ZIndex: =19

                Gallery3_3 As gallery.variableTemplateHeightGallery:
                    DelayItemLoading: =true
                    Height: =153
                    Items: |-
                        =SortByColumns(
                            tmpKTTNHDCollect,
                            "cr282_thoi_han_ttoan",
                            SortOrder.Ascending
                        )
                    Layout: =Layout.Vertical
                    LoadingSpinner: =LoadingSpinner.Data
                    TemplatePadding: =0
                    TemplateSize: =75
                    Width: =611
                    X: =654
                    Y: =60
                    ZIndex: =21

                    Label3_80 As label:
                        Height: =25
                        Size: =11
                        Text: ="Thời hạn đóng phí"
                        X: =260
                        Y: =5
                        ZIndex: =2

                    Label3_79 As label:
                        Height: =25
                        Size: =11
                        Text: ="Phí thanh toán/kỳ"
                        Width: =140
                        X: =8
                        Y: =5
                        ZIndex: =3

                    tiPhiTTNHD As text:
                        Align: =Align.Right
                        BorderColor: =RGBA(72, 163, 62, 1)
                        Default: =ThisItem.PHI_THANH_TOAN
                        Format: =TextFormat.Number
                        Height: =32
                        OnChange: |-
                            =UpdateIf(
                                tmpKTTNHDCollect,
                                ID=ThisItem.ID,
                                {
                                    PHI_THANH_TOAN:Value(tiPhiTTNHD.Text),
                                    THOI_HAN_TTOAN:dpTHPhiNHD.SelectedDate
                                }
                            )
                        RadiusBottomLeft: =0
                        RadiusBottomRight: =0
                        RadiusTopLeft: =0
                        RadiusTopRight: =0
                        Size: =11
                        Width: =230
                        X: =8
                        Y: =33
                        ZIndex: =4

                    dpTHPhiNHD As datepicker:
                        BorderColor: =RGBA(72, 163, 62, 1)
                        DefaultDate: =ThisItem.THOI_HAN_TTOAN
                        EndYear: =2200
                        Format: ="dd/mm/yyyy"
                        Height: =32
                        InputTextPlaceholder: =
                        IsEditable: =true
                        OnChange: |-
                            =UpdateIf(
                                tmpKTTNHDCollect,
                                ID=ThisItem.ID,
                                {
                                    PHI_THANH_TOAN:Value(tiPhiTTNHD.Text),
                                    THOI_HAN_TTOAN:dpTHPhiNHD.SelectedDate
                                }
                            )
                        Size: =11
                        StartYear: =1900
                        Width: =230
                        X: =260
                        Y: =33
                        ZIndex: =5

                    Button2_6 As button:
                        Height: =32
                        OnSelect: |
                            =If(
                                CountIf(tmpKTTNHDCollect,true)>1,
                                Remove(tmpKTTNHDCollect,ThisItem)
                            )
                        Size: =11
                        Text: ="Xóa"
                        Width: =80
                        X: =510
                        Y: =33
                        ZIndex: =6

                tiTongTPNHD As text:
                    Align: =Align.Right
                    BorderColor: =RGBA(72, 163, 62, 1)
                    Default: =If(IsBlank(First(objHD).TONG_TIEN_PHI) || First(objHD).TONG_TIEN_PHI<0,0,First(objHD).TONG_TIEN_PHI)
                    DisplayMode: =DisplayMode.Disabled
                    Format: =TextFormat.Number
                    Height: =32
                    RadiusBottomLeft: =0
                    RadiusBottomRight: =0
                    RadiusTopLeft: =0
                    RadiusTopRight: =0
                    Size: =11
                    Width: =250
                    X: =30
                    Y: =94
                    ZIndex: =22

                Label3_78 As label:
                    Height: =25
                    Size: =11
                    Text: ="Tổng tiền phí"
                    Width: =200
                    X: =30
                    Y: =66
                    ZIndex: =23

                tiSTGiamNHD As text:
                    Align: =Align.Right
                    BorderColor: =RGBA(72, 163, 62, 1)
                    Default: =If(IsBlank(First(objHD).SO_TIEN_GIAM),0,First(objHD).SO_TIEN_GIAM)
                    DisplayMode: =DisplayMode.Disabled
                    Format: =TextFormat.Number
                    Height: =32
                    RadiusBottomLeft: =0
                    RadiusBottomRight: =0
                    RadiusTopLeft: =0
                    RadiusTopRight: =0
                    Size: =11
                    Width: =250
                    X: =30
                    Y: =160
                    ZIndex: =24

                Label3_81 As label:
                    Height: =25
                    Size: =11
                    Text: ="Số tiền giảm"
                    Width: =200
                    X: =30
                    Y: =132
                    ZIndex: =25

                tiTienSauGiamNHD As text:
                    Align: =Align.Right
                    BorderColor: =RGBA(72, 163, 62, 1)
                    Default: =If(IsBlank(First(objHD).TIEN_PHI_SAU_GIAM) || First(objHD).TIEN_PHI_SAU_GIAM<0,0,First(objHD).TIEN_PHI_SAU_GIAM)
                    DisplayMode: =DisplayMode.Disabled
                    Format: =TextFormat.Number
                    Height: =32
                    RadiusBottomLeft: =0
                    RadiusBottomRight: =0
                    RadiusTopLeft: =0
                    RadiusTopRight: =0
                    Size: =11
                    Width: =250
                    X: =355
                    Y: =160
                    ZIndex: =26

                Label3_82 As label:
                    Height: =25
                    Size: =11
                    Text: ="Tổng tiền phí sau giảm"
                    Width: =200
                    X: =355
                    Y: =132
                    ZIndex: =27

                Label3_77 As label:
                    Height: =25
                    Size: =11
                    Text: ="Mã giảm giá"
                    Width: =200
                    X: =355
                    Y: =66
                    ZIndex: =28

                cbxMaGGNHD As combobox:
                    BorderColor: =RGBA(72, 163, 62, 1)
                    DefaultSelectedItems: =LookUp(dmMaGiamGiaNHDCollect,MA_GIAM_GIA=First(objHD).MA_GIAM_GIA)
                    DisplayFields: =["title"]
                    Height: =32
                    InputTextPlaceholder: ="Chọn mã giảm giá"
                    IsSearchable: =false
                    Items: =SortByColumns(dmMaGiamGiaNHDCollect,"gia_tri_tong",SortOrder.Descending)
                    SearchFields: =["title"]
                    SearchItems: =[]
                    SelectMultiple: =false
                    Size: =11
                    Width: =250
                    X: =355
                    Y: =94
                    ZIndex: =29

                Button2_5 As button:
                    Height: =32
                    OnSelect: |-
                        =UpdateContext({
                            maKTT:Max(DL_HOP_DONG_TTOANS,ID)+1
                        });
                        Collect(
                            tmpKTTNHDCollect,
                            {
                                ID:Text(maKTT)
                            }
                        );
                    Size: =11
                    Text: ="Thêm mới"
                    Width: =98
                    X: =663
                    Y: =20
                    ZIndex: =30

    LeftNavigation_30 As LeftNavigation_9:
        Width: =LeftNavigation_30.MenuWidth - 10
        ZIndex: =4

    Button2_4 As button:
        FontWeight: =FontWeight.Bold
        Height: =32
        OnSelect: |-
            =If(
                IsBlank(dpNgayHDNHD.SelectedDate),
                Notify(
                    "Bắt buộc nhập ngày hợp đồng",
                    NotificationType.Error,
                    2000
                ),
                IsBlank(dpHLTuNHD.SelectedDate),
                Notify(
                    "Bắt buộc nhập hiệu lực từ của hợp đồng",
                    NotificationType.Error,
                    2000
                ),
                IsBlank(dpHLDenNHD.SelectedDate),
                Notify(
                    "Bắt buộc nhập hiệu lực đến của hợp đồng",
                    NotificationType.Error,
                    2000
                ),
                IsBlank(cbxDVQLNHD.Selected.MA_PHAMVI),
                Notify(
                    "Bắt buộc nhập đơn vị quản lý hợp đồng",
                    NotificationType.Error,
                    2000
                ),
                IsBlank(cbxDVTienNHD.Selected.TIEN_TE),
                Notify(
                    "Bắt buộc nhập đơn vị tiền",
                    NotificationType.Error,
                    2000
                ),
                IsBlank(cbxLoaiKBNHD.Selected.MA_LOAI_KB),
                Notify(
                    "Bắt buộc nhập loại kênh bán",
                    NotificationType.Error,
                    2000
                ),
                IsBlank(cbxMaKBNHD.Selected.MA_KENH_BAN),
                Notify(
                    "Bắt buộc nhập mã kênh bán",
                    NotificationType.Error,
                    2000
                ),
                IsBlank(tiTenKBNHD.Text),
                Notify(
                    "Bắt buộc nhập tên kênh bán",
                    NotificationType.Error,
                    2000
                ),
                IsBlank(cbxMaKHNHD.Selected.MA_KHACH_HANG),
                Notify(
                    "Bắt buộc nhập mã khách hàng",
                    NotificationType.Error,
                    2000
                ),
                IsBlank(tiTenKHNHD.Text),
                Notify(
                    "Bắt buộc nhập tên khách hàng",
                    NotificationType.Error,
                    2000
                ),
                dpNgayHDNHD.SelectedDate > dpHLTuNHD.SelectedDate,
                Notify(
                    "Ngày hiệu lực từ phải sau hoặc bằng ngày hợp đồng",
                    NotificationType.Error,
                    2000
                ),
                dpHLDenNHD.SelectedDate <= dpHLTuNHD.SelectedDate,
                Notify(
                    "Ngày hiệu lực đến phải sau ngày hiệu lực từ",
                    NotificationType.Error,
                    2000
                ),
                (!IsBlank(Sum(tmpKTTNHDCollect,PHI_THANH_TOAN)) && Value(tiTienSauGiamNHD.Text) <> Sum(
                    tmpKTTNHDCollect,
                    PHI_THANH_TOAN
                )) || (IsBlank(Sum(tmpKTTNHDCollect,PHI_THANH_TOAN)) && Value(tiTienSauGiamNHD.Text) <> 0),
                Notify(
                    "Tổng tiền phí (sau miễn giảm) khác tổng phí trên các kỳ thanh toán",
                    NotificationType.Error,
                    2000
                ),
                Refresh(DL_HOP_DONGS);
                If(
                    CountIf(
                        DL_HOP_DONGS,
                        true
                    ) = 0,
                    UpdateContext({genMaHD: "HD0001"}),
                    UpdateContext(
                        {
                            sampleID: "000",
                            maxIdHD: Last(
                                SortByColumns(
                                    DL_HOP_DONGS,
                                    "cr282_ma_hop_dong",
                                    SortOrder.Ascending
                                )
                            ).MA_HOP_DONG
                        }
                    );
                    UpdateContext(
                        {
                            maIdHD: Text(
                                (Right(
                                    maxIdHD,
                                    4
                                )) + 1
                            )
                        }
                    );
                    UpdateContext(
                        {
                            genMaHD: Concatenate(
                                "HD",
                                If(
                                    Len(maIdHD) > 3,
                                    "",
                                    Left(
                                        sampleID,
                                        4 - Len(maIdHD)
                                    )
                                ),
                                maIdHD
                            )
                        }
                    );
                );
                If(
                    IsBlank(First(objHD).MA_HOP_DONG),
                    Patch(
                        DL_HOP_DONGS,
                        {
                            ID: Text(
                                Max(
                                    DL_HOP_DONGS,
                                    ID
                                ) + 1
                            ),
                            MA_HOP_DONG: genMaHD,
                            DIA_CHI: tiDChiNHD.Text,
                            DONVI_KENHBAN: cbxDVKBNHD.Selected.MA_DON_VI,
                            DONVI_QUANLY_HD: cbxDVQLNHD.Selected.MA_PHAMVI,
                            DONVI_TIEN: cbxDVTienNHD.Selected.TIEN_TE,
                            EMAIL: tiEmailNHD.Text,
                            GIOI_TINH: cbxGTinhNHD.Selected.MA_GIOI_TINH,
                            HIEU_LUC_DEN: dpHLDenNHD.SelectedDate,
                            HIEU_LUC_TU: dpHLTuNHD.SelectedDate,
                            LOAI_KENH_BAN: cbxLoaiKBNHD.Selected.MA_LOAI_KB,
                            LOAI_KHACH_HANG: cbxLoaiKHNHD.Selected.value,
                            MA_KENH_BAN: cbxMaKBNHD.Selected.MA_KENH_BAN,
                            MA_KHACH_HANG: cbxMaKHNHD.Selected.MA_KHACH_HANG,
                            NGAY_HOP_DONG: dpNgayHDNHD.SelectedDate,
                            NGAY_SINH: dpNSinhNHD.SelectedDate,
                            NGHE_NGHIEP: cbxNgheNHD.Selected.value,
                            SO_DIEN_THOAI: tiSDTNHD.Text,
                            SO_NGUOI_TGIA: tiSoNTGNHD.Text,
                            TEN_KENH_BAN: tiTenKBNHD.Text,
                            TEN_KHACH_HANG: tiTenKHNHD.Text,
                            TRANG_THAI: "Hoạt động",
                            TINH_TP_KH: cbxTinhNHD.Selected.MA_PHAMVI,
                            PTHUC_THANH_TOAN: cbxPTTTNHD.Selected.value,
                            NHOM_KHACH_HANG: cbxNhomKHNHD.Selected.MA_NHOM_KH,
                            NHOM_KENH_BAN: nhomKB,
                            TONG_TIEN_PHI: Value(tiTongTPNHD.Text),
                            MA_GIAM_GIA: cbxMaGGNHD.Selected.MA_GIAM_GIA,
                            SO_TIEN_GIAM: Value(tiSTGiamNHD.Text),
                            TIEN_PHI_SAU_GIAM: Value(tiTienSauGiamNHD.Text),
                            LOAI_HOP_DONG:ddLoaiHDNHD.Selected.value,
                            TEN_KHACH_HANG_SAVED:cbxMaKHNHD.Selected.MA_KHACH_HANG
                        }
                    );
                    UpdateIf(
                        objHD,
                        true,
                        {
                            ID: Text(
                                Max(
                                    DL_HOP_DONGS,
                                    ID
                                ) + 1
                            ),
                            MA_HOP_DONG: genMaHD,
                            DIA_CHI: tiDChiNHD.Text,
                            DONVI_KENHBAN: cbxDVKBNHD.Selected.MA_DON_VI,
                            DONVI_QUANLY_HD: cbxDVQLNHD.Selected.MA_PHAMVI,
                            DONVI_TIEN: cbxDVTienNHD.Selected.TIEN_TE,
                            EMAIL: tiEmailNHD.Text,
                            GIOI_TINH: cbxGTinhNHD.Selected.MA_GIOI_TINH,
                            HIEU_LUC_DEN: dpHLDenNHD.SelectedDate,
                            HIEU_LUC_TU: dpHLTuNHD.SelectedDate,
                            LOAI_KENH_BAN: cbxLoaiKBNHD.Selected.MA_LOAI_KB,
                            LOAI_KHACH_HANG: cbxLoaiKHNHD.Selected.value,
                            MA_KENH_BAN: cbxMaKBNHD.Selected.MA_KENH_BAN,
                            MA_KHACH_HANG: cbxMaKHNHD.Selected.MA_KHACH_HANG,
                            NGAY_HOP_DONG: dpNgayHDNHD.SelectedDate,
                            NGAY_SINH: dpNSinhNHD.SelectedDate,
                            NGHE_NGHIEP: cbxNgheNHD.Selected.value,
                            SO_DIEN_THOAI: tiSDTNHD.Text,
                            SO_NGUOI_TGIA: tiSoNTGNHD.Text,
                            TEN_KENH_BAN: tiTenKBNHD.Text,
                            TEN_KHACH_HANG: tiTenKHNHD.Text,
                            TRANG_THAI: "Hoạt động",
                            TINH_TP_KH: cbxTinhNHD.Selected.MA_PHAMVI,
                            PTHUC_THANH_TOAN: cbxPTTTNHD.Selected.value,
                            NHOM_KHACH_HANG: cbxNhomKHNHD.Selected.MA_NHOM_KH,
                            NHOM_KENH_BAN: nhomKB,
                            TONG_TIEN_PHI: Value(tiTongTPNHD.Text),
                            MA_GIAM_GIA: cbxMaGGNHD.Selected.MA_GIAM_GIA,
                            SO_TIEN_GIAM: Value(tiSTGiamNHD.Text),
                            TIEN_PHI_SAU_GIAM: Value(tiTienSauGiamNHD.Text),
                            LOAI_HOP_DONG:ddLoaiHDNHD.Selected.value,
                            TEN_KHACH_HANG_SAVED:cbxMaKHNHD.Selected.MA_KHACH_HANG
                        }
                    ),
                    UpdateIf(
                        DL_HOP_DONGS,
                        MA_HOP_DONG = tiMaHDNHD.Text,
                        {
                            DIA_CHI: tiDChiNHD.Text,
                            DONVI_KENHBAN: cbxDVKBNHD.Selected.MA_DON_VI,
                            DONVI_QUANLY_HD: cbxDVQLNHD.Selected.MA_PHAMVI,
                            DONVI_TIEN: cbxDVTienNHD.Selected.TIEN_TE,
                            EMAIL: tiEmailNHD.Text,
                            GIOI_TINH: cbxGTinhNHD.Selected.MA_GIOI_TINH,
                            HIEU_LUC_DEN: dpHLDenNHD.SelectedDate,
                            HIEU_LUC_TU: dpHLTuNHD.SelectedDate,
                            LOAI_KENH_BAN: cbxLoaiKBNHD.Selected.MA_LOAI_KB,
                            LOAI_KHACH_HANG: cbxLoaiKHNHD.Selected.value,
                            MA_KENH_BAN: cbxMaKBNHD.Selected.MA_KENH_BAN,
                            MA_KHACH_HANG: cbxMaKHNHD.Selected.MA_KHACH_HANG,
                            NGAY_HOP_DONG: dpNgayHDNHD.SelectedDate,
                            NGAY_SINH: dpNSinhNHD.SelectedDate,
                            NGHE_NGHIEP: cbxNgheNHD.Selected.value,
                            SO_DIEN_THOAI: tiSDTNHD.Text,
                            SO_NGUOI_TGIA: tiSoNTGNHD.Text,
                            TEN_KENH_BAN: tiTenKBNHD.Text,
                            TEN_KHACH_HANG: tiTenKHNHD.Text,
                            TRANG_THAI: "Hoạt động",
                            TINH_TP_KH: cbxTinhNHD.Selected.MA_PHAMVI,
                            PTHUC_THANH_TOAN: cbxPTTTNHD.Selected.value,
                            NHOM_KHACH_HANG: cbxNhomKHNHD.Selected.MA_NHOM_KH,
                            NHOM_KENH_BAN: nhomKB,
                            TONG_TIEN_PHI: Value(tiTongTPNHD.Text),
                            MA_GIAM_GIA: cbxMaGGNHD.Selected.MA_GIAM_GIA,
                            SO_TIEN_GIAM: Value(tiSTGiamNHD.Text),
                            TIEN_PHI_SAU_GIAM: Value(tiTienSauGiamNHD.Text),
                            LOAI_HOP_DONG:ddLoaiHDNHD.Selected.value,
                            TEN_KHACH_HANG_SAVED:cbxMaKHNHD.Selected.MA_KHACH_HANG
                        }
                    );
                    UpdateIf(
                        objHD,
                        true,
                        {
                            DIA_CHI: tiDChiNHD.Text,
                            DONVI_KENHBAN: cbxDVKBNHD.Selected.MA_DON_VI,
                            DONVI_QUANLY_HD: cbxDVQLNHD.Selected.MA_PHAMVI,
                            DONVI_TIEN: cbxDVTienNHD.Selected.TIEN_TE,
                            EMAIL: tiEmailNHD.Text,
                            GIOI_TINH: cbxGTinhNHD.Selected.MA_GIOI_TINH,
                            HIEU_LUC_DEN: dpHLDenNHD.SelectedDate,
                            HIEU_LUC_TU: dpHLTuNHD.SelectedDate,
                            LOAI_KENH_BAN: cbxLoaiKBNHD.Selected.MA_LOAI_KB,
                            LOAI_KHACH_HANG: cbxLoaiKHNHD.Selected.value,
                            MA_KENH_BAN: cbxMaKBNHD.Selected.MA_KENH_BAN,
                            MA_KHACH_HANG: cbxMaKHNHD.Selected.MA_KHACH_HANG,
                            NGAY_HOP_DONG: dpNgayHDNHD.SelectedDate,
                            NGAY_SINH: dpNSinhNHD.SelectedDate,
                            NGHE_NGHIEP: cbxNgheNHD.Selected.value,
                            SO_DIEN_THOAI: tiSDTNHD.Text,
                            SO_NGUOI_TGIA: tiSoNTGNHD.Text,
                            TEN_KENH_BAN: tiTenKBNHD.Text,
                            TEN_KHACH_HANG: tiTenKHNHD.Text,
                            TRANG_THAI: "Hoạt động",
                            TINH_TP_KH: cbxTinhNHD.Selected.MA_PHAMVI,
                            PTHUC_THANH_TOAN: cbxPTTTNHD.Selected.value,
                            NHOM_KHACH_HANG: cbxNhomKHNHD.Selected.MA_NHOM_KH,
                            NHOM_KENH_BAN: nhomKB,
                            TONG_TIEN_PHI: Value(tiTongTPNHD.Text),
                            MA_GIAM_GIA: cbxMaGGNHD.Selected.MA_GIAM_GIA,
                            SO_TIEN_GIAM: Value(tiSTGiamNHD.Text),
                            TIEN_PHI_SAU_GIAM: Value(tiTienSauGiamNHD.Text),
                            LOAI_HOP_DONG:ddLoaiHDNHD.Selected.value,
                            TEN_KHACH_HANG_SAVED:cbxMaKHNHD.Selected.MA_KHACH_HANG
                        }
                    )
                );
                Refresh(DL_HOP_DONG_TTOANS);
                RemoveIf(
                    DL_HOP_DONG_TTOANS,
                    MA_HOP_DONG = First(objHD).MA_HOP_DONG
                );
                ForAll(
                    tmpKTTNHDCollect As ds,
                    Patch(
                        DL_HOP_DONG_TTOANS,
                        {
                            ID: ds.ID,
                            MA_HOP_DONG: First(objHD).MA_HOP_DONG,
                            PHI_THANH_TOAN: ds.PHI_THANH_TOAN,
                            THOI_HAN_TTOAN: ds.THOI_HAN_TTOAN
                        }
                    )
                );
                Reset(tiMaHDNHD);
                Reset(LinkHDLK);
                //Xu ly muc 6
                Refresh(DL_HOP_DONG_CHON_CS);
            RemoveIf(
                    DL_HOP_DONG_CHON_CS,
                    MA_HOP_DONG = tiMaHDNHD.Text
                );
                Refresh(DL_HOP_DONG_KETQUA_CS);
                RemoveIf(
                    DL_HOP_DONG_KETQUA_CS,
                    MA_HOP_DONG = tiMaHDNHD.Text
                );
                ForAll(
                    GalleryCSDaChon.AllItems As cs,
                    Patch(
                        DL_HOP_DONG_CHON_CS,
                        Defaults(DL_HOP_DONG_CHON_CS),
                        {
                            ID: Max(
                                DL_HOP_DONG_CHON_CS,
                                ID
                            ) + 1,
                            MA_CHINH_SACH: cs.TextMaCS_1.Text,
                            MA_HOP_DONG: tiMaHDNHD.Text,
                            SO_TIEN: Value(
                                LookUp(
                                    DL_CHINHSACH_APDUNG,
                                    MA_CHINH_SACH = cs.TextMaCS_1.Text
                                ).SO_TIEN
                            ),
                            TY_LE: Value(
                                LookUp(
                                    DL_CHINHSACH_APDUNG,
                                    MA_CHINH_SACH = cs.TextMaCS_1.Text
                                ).TY_LE
                            ),
                            SO_TIEN_TOIDA: Value(
                                LookUp(
                                    DL_CHINHSACH_APDUNG,
                                    MA_CHINH_SACH = cs.TextMaCS_1.Text
                                ).SO_TIEN_TOI_DA
                            ),
                            MO_TA: cs.HtmlMoTa_1.HtmlText
                        }
                    )
                );
                If(
                    !IsEmpty(
                        Filter(
                            DL_HOP_DONG_CHON_CS,
                            MA_HOP_DONG = tiMaHDNHD.Text
                        )
                    ),
                    Patch(
                        DL_HOP_DONG_KETQUA_CS,
                        Defaults(DL_HOP_DONG_KETQUA_CS),
                        {
                            ID: Max(
                                DL_HOP_DONG_KETQUA_CS,
                                ID
                            ) + 1,
                            MA_HOP_DONG: tiMaHDNHD.Text,
                            KIEU_DU_LIEU: "002",
                            LOAI_TAC_DONG: "2",
                            GIA_TRI: Sum(
                                Filter(
                                    DL_HOP_DONG_CHON_CS,
                                    MA_HOP_DONG = tiMaHDNHD.Text
                                ),
                                SO_TIEN
                            )
                        }
                    )
                );
                //End muc 6
            
            Notify(
                    "Lưu dữ liệu thành công",
                    NotificationType.Success,
                    2000
                );
                
            )
        Size: =11
        Text: ="Lưu hợp đồng"
        Width: =130
        X: =1208
        Y: =716
        ZIndex: =5

    Button3_15 As button:
        FontWeight: =FontWeight.Bold
        Height: =32
        OnSelect: =Navigate(TraCuuHopDong)
        Size: =11
        Text: ="Quay lại"
        Width: =85
        X: =1000
        Y: =716
        ZIndex: =6

    Button3_16 As button:
        FontWeight: =FontWeight.Bold
        Height: =32
        OnSelect: |-
            =//Xu ly muc 6
            Refresh(DL_HOP_DONG_CHON_CS);
            RemoveIf(
                    DL_HOP_DONG_CHON_CS,
                    MA_HOP_DONG = tiMaHDNHD.Text
                );
                Refresh(DL_HOP_DONG_KETQUA_CS);
                RemoveIf(
                    DL_HOP_DONG_KETQUA_CS,
                    MA_HOP_DONG = tiMaHDNHD.Text
                );
                ForAll(
                    GalleryCSDaChon.AllItems As cs,
                    Patch(
                        DL_HOP_DONG_CHON_CS,
                        Defaults(DL_HOP_DONG_CHON_CS),
                        {
                            ID: Max(
                                DL_HOP_DONG_CHON_CS,
                                ID
                            ) + 1,
                            MA_CHINH_SACH: cs.TextMaCS_1.Text,
                            MA_HOP_DONG: tiMaHDNHD.Text,
                            SO_TIEN: Value(
                                LookUp(
                                    DL_CHINHSACH_APDUNG,
                                    MA_CHINH_SACH = cs.TextMaCS_1.Text
                                ).SO_TIEN
                            ),
                            TY_LE: Value(
                                LookUp(
                                    DL_CHINHSACH_APDUNG,
                                    MA_CHINH_SACH = cs.TextMaCS_1.Text
                                ).TY_LE
                            ),
                            SO_TIEN_TOIDA: Value(
                                LookUp(
                                    DL_CHINHSACH_APDUNG,
                                    MA_CHINH_SACH = cs.TextMaCS_1.Text
                                ).SO_TIEN_TOI_DA
                            ),
                            MO_TA: cs.HtmlMoTa_1.HtmlText
                        }
                    )
                );
                If(
                    !IsEmpty(
                        Filter(
                            DL_HOP_DONG_CHON_CS,
                            MA_HOP_DONG = tiMaHDNHD.Text
                        )
                    ),
                    Patch(
                        DL_HOP_DONG_KETQUA_CS,
                        Defaults(DL_HOP_DONG_KETQUA_CS),
                        {
                            ID: Max(
                                DL_HOP_DONG_KETQUA_CS,
                                ID
                            ) + 1,
                            MA_HOP_DONG: tiMaHDNHD.Text,
                            KIEU_DU_LIEU: "002",
                            LOAI_TAC_DONG: "2",
                            GIA_TRI: Sum(
                                Filter(
                                    DL_HOP_DONG_CHON_CS,
                                    MA_HOP_DONG = tiMaHDNHD.Text
                                ),
                                SO_TIEN
                            )
                        }
                    )
                );
                //End muc 6
            UpdateIf(
                objHD,
                true,
                {
                    TONG_TIEN_PHI:Sum(tmpDSHDSPNHDCollect,TONG_TIEN_PHI)-Sum(Filter(DL_HOP_DONG_KETQUA_CS,MA_HOP_DONG=First(objHD).MA_HOP_DONG),GIA_TRI)
                }
            );
            UpdateIf(
                objHD,
                true,
                {
                    SO_TIEN_GIAM:If(
                        !IsBlank(cbxMaGGNHD.Selected.TY_LE_GIAM),
                        Value(tiTongTPNHD.Text)*cbxMaGGNHD.Selected.TY_LE_GIAM,
                        !IsBlank(cbxMaGGNHD.Selected.SO_TIEN),
                        cbxMaGGNHD.Selected.SO_TIEN
                    )
                }
            );
            UpdateIf(
                objHD,
                true,
                {
                    TIEN_PHI_SAU_GIAM:Value(tiTongTPNHD.Text)-Value(tiSTGiamNHD.Text)
                }
            );
            UpdateIf(
                tmpKTTNHDCollect,
                true,
                {
                    PHI_THANH_TOAN:Trunc((Value(tiTienSauGiamNHD.Text)/CountIf(tmpKTTNHDCollect,true))/1000)*1000
                }
            );
            If(
                Mod(Value(tiTienSauGiamNHD.Text),CountIf(tmpKTTNHDCollect,true))<>0,
                UpdateIf(
                    tmpKTTNHDCollect,
                    ID=Text(Max(tmpKTTNHDCollect,ID)),
                    {
                        PHI_THANH_TOAN:Value(tiTienSauGiamNHD.Text) - Trunc((Value(tiTienSauGiamNHD.Text)/CountIf(tmpKTTNHDCollect,true))/1000)*1000*(CountIf(tmpKTTNHDCollect,true)-1)
                    }
                );
                Notify(Mod(Value(tiTienSauGiamNHD.Text),CountIf(tmpKTTNHDCollect,true)),NotificationType.Success,2000);
            )
        Size: =11
        Text: ="Tính phí"
        Width: =85
        X: =1107
        Y: =716
        ZIndex: =7

